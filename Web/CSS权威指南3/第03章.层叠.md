---
title: 【基础】层叠规则 Cascading
date: 2019-01-23 23:32:51
tags:
categories:
- CSS
---

用户代理进行页面渲染时，不仅要考虑继承、还要考虑声明的特殊性、另外需要考虑声明本身的来源，这个过程就称为层叠，冲突的声明要通过层叠过程排序，并由此确定最终的文档表示。

## 特殊性
每个选择器都有其特殊性(specificity)。对于每个规则，用户代理会计算选择器的特殊性，并将这个特殊性附加到规则中的各个声明。如果一个元素有两个或多个冲突的属性声明，那么有最高特殊性的声明将会胜出。

选择器的特殊性由选择器本身的组件确定，特殊性表述为4个部分：0,0,0,0：
- 对于选择器中给定的各个 ID 属性值，加 0,1,0,0；
- 对于选择器中给定的各个类属性值、属性选择或伪类，加0,0,1,0；
- 对于选择器中给定的各个元素和伪元素，加0,0,0,1；
- 结合符和通配选择器对特殊性没有任何贡献。

一旦确定一个选择器的特殊性，这个值将授予其所有相关声明。
<!-- more -->
### 通配选择器特殊性
通配选择器的特殊性为 0,0,0,0，这与根本没有特殊性有区别。

```css
/* div 下包含的段落将是黑色，而其他元素都是灰色 */
div p { color: black; }          /* 0,0,0,2 */
* { color: gray; }               /* 0,0,0,0 */

div p { color: black; }          /* 0,0,0,2 */
body * strong { color: gray; }   /* 0,0,0,2 */
```

如果一个选择器中包含通配选择器和其他选择器，该选择器的特殊性不会因为通配选择器的出现而改变。

### 内联样式特殊性
每个内联样式的特殊性都是1,0,0,0，它比其他声明的特殊性都高。

### 重要性
有时某个声明可能非常重要，超过了所有其他声明，称之为重要声明，并允许在这些声明的结束分号之前插入 !important 来标志。

所有的重要声明会分组在一起，和非重要声明分开考虑，重要声明的特殊性冲突会在重要声明内部解决，而不会与非重要声明相混。

## 继承
继承是从一个元素向后代元素传递属性值所采用的机制。基于继承机制，样式不仅应用到指定的元素，还会应用到它的后代元素。

继承沿着文档 DOM 树向下传播到后代元素。

除非有必要的理由，否则一般不会特别考虑继承（熟视无睹）。

不能继承的属性：
- 属性border，用于设置元素的边框，不会继承
- 大多数框模型属性(包括外边距、内边距、背景和边框)都不能继承

继承的值根本没有特殊性，甚至连 0 特殊性都没有。
```html
<style>
    * { color: gray; }
    h1#page-title { color: black; }
</style>

<h1 id="page-title">Meerkat <em>Central</em></h1>
```
通配选择器适用于所有元素，而且有0特殊性，其颜色声明指定的值 gray 要优先于继承值 black。

不加区分地使用通配选择器可能存在的问题：造成短路继承的效果。

## 层叠
结合继承和特殊性，CSS 设定层叠规则：
- 找出所有相关的规则，这些规则都包含与一个给定元素匹配的选择器；
- 按显式权重对应用到该元素的所有声明排序，权重从大到小依次为：
  - 读者的重要声明
  - 创作人员的重要声明
  - 创作人员的正常声明
  - 读者的正常声明
  - 用户代理声明
- 按特殊性对应用到给定元素的所有声明排序；
- 按出现顺序对应用到给定元素的所有声明排序：
  - 如果两个规则的权重、来源和特殊性完全相同，后出现的规则胜出
  - 以 style 属性中指定的样式胜过导入的样式，一般认为出现在导入样式表中的声明在前，主样式表中的所有声明在后

### 链式样式顺序
按 link-visited-hover-active 的顺序声明(LoVe-HA!)：

```css
:link { color: blue; }
:visited { color: purple; }
:hover { color: red; }
:active { color: orange; }
```
:link 或 :visited 后出现时，总是会覆盖 :hover 和 :active；:link 和 :visited 先后顺序无冲突；:hover 后出现时会覆盖 :active。

另一种解决方案，通过串链的伪类来缓解特殊性和顺序带来的问题，以下规则可以用任何顺序列出：
```css
:link { color: blue; }
:visited { color: purple; }
:link:hover { color: red; }
:visited:hover { color: gray}
:link:hover:active { color: orange; }
:visited:hover:active { color: silver; }
```


## 参考
[1] Meyer E , 迈耶, Meyer. CSS权威指南[M]. 东南大学出版社, 2007.