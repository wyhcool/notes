---
title: webpack5 模块联邦
date: 2023-10-23 19:40:00
tags:
categories:
- webpack
---

Federation \[ˌfedəˈreɪʃn\] n.联邦; (俱乐部、工会等的)联合会; 联盟; 同盟;


## 引言
自 webpack5 发布以来，推出了很多全新的特性，其中最主要的就如下三点：
- 可持续性缓存 -- 通过cache配置可实现首次构建后一直保存缓存。
- 真正意义上的 tree-shaking -- 让你的打包体积更小，去掉无用的代码。
- 模块联邦（module federation）


## 模块联邦（Module Federation）
webpack 可以通过 dll 实现对同一个项目的公共组件模块，做成代码共享 common chunk，但是如果是要实现跨项目针对不同的应用就变得非常的困难不易实现。几乎没办法做到不同应用之间进行插拔式的热更新。那怎么样去实现这种跨应用间的共用模块运用呢？于是 webpack5 内置了一个模块联邦的功能特性，这个功能可以让跨应用间做到模块共享真正的插拔式的便捷使用。比如 a 应用如果想使用 b 应用中 list 的组件，通过模块联邦可以直接在 a 中进行 import('b/list') 非常的方便。


## 共享模块处理的方式
### npm方式公共模块共享
我们如果想把某一块功能某一组件做成共用的，可以让其他应用进行使用的，一般就把他做成一个 npm 包然后发布上去，其他需要用到的应用进行下载安装就能用了。

虽然说这种方式在一定的程度上是实现了代码的共用，跨项目之间的安装即使用，但是 npm 的方式存在一个巨大的问题就是当 npm 包更新后，怎样让各个子应用也实现更新呢？只能是使用到的相关项目进行一次重新构建然后发布上线，这样才能在正式线上用到最新的代码。这也就是走本地编译带来的缺陷。

### UMD 方式共享模块
UMD 方式可以说的是真正的 runtime 方式使用公共模块，就像我们平时使用jQuery、lodsah一样，通过直接引用他们的 cdn，然后直接在项目中进行使用。而且当他们发布更新时候我们也可以做到更新。

这种方式是可以实现多个子应用共享共用模块，但是依旧存在两个问题：
- 各包库之间容易存在冲突；
- 无法在本地编译时候达到最大的优化效果。

### 微前端
微前端在处理大型项目应用、历史项目重构兼容等场景时候相当有用，它主要解决了多项目并存、代码隔离、与语言框架无关。

微前端基座下面可以有 n 个子应用，每个子应用都是可以单独构建的，他们之间是相互独立的，都可以引入对应的公共模块common。

微前端有两种构建方式：
- 每个子应用单独进行构建，这样无法抽离出公共的代码，每个子应用都会有一份 common 的代码；
- 可以进行整体的打包但是这样如果子应用规模庞大那构建速度是很慢的，没法扩展微前端的子应用规模。

### 模块联邦
webpack5 内置的这个功能比较完美的解决上面几种共享模式下的问题，既可以做到打包发布模块供给后，消费者能够实时保持同步，也可以进行代码构建时候的优化，可以在一个应用中直接导出使用另外一个应用的模块，


## 模块联邦的使用
模块联邦是webpack的内置模块，使用起来也是相当的简单，做好相关配置就可以了，首先要保障项目webpack是5.0及以上。然后在对应的项目的webpack.config.js进行配置，ModuleFederationPlugin有几个重要的参数：
- name: 当前应用的名称，需要唯一性；
- exposes: 需要导出的模块，用于提供给外部其他项目进行使用；
- remotes: 需要依赖的远程模块，用于引入外部其他模块；
- filename: 入口文件名称，用于对外提供模块时候的入口文件名；
- shared: 配置共享的组件，一般是对第三方库做共享使用；

配置如下：
```js
new ModuleFederationPlugin({
    name: "main_app",
    filename: "remoteEntry.js",
    exposes: {
        "./search": "./src/search/search.vue"
    },
    remotes: {
        lib_remote: "lib_remote@http://localhost:8085/remoteEntry.js",
    },
    shared: {
        vue: {
            eager: true,
            singleton: true,
        }
    }
})
```


## 总结
模块联邦其实可以当作是 webpack5 将需要导出来的组件打包成一个运行时的文件，然后在其他项目可以进行运行时的动态加载，加载的过程是异步的，执行的时候是同步的。根据这个特性我们可以实现一个中心化组件模块中心，然后对外进行模块的分发。


## 参考
[1] https://zhuanlan.zhihu.com/p/485148715