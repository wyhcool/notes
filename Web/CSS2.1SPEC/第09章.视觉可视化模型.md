---
title: 视觉格式化模型
date: 2019-02-23 12:25:51
tags:
categories:
- CSS
---

## 基本概念
在视觉格式化模型中，文档树中的每一个元素根据框模型生成零个或多个框，这些框的布局由下列内容控制：
- 框的尺寸和类型
- 定位方案（正常流、浮动和绝对定位）
- 文档树中元素间关系
- 外部信息(比如，视窗大小，图片的固有尺寸等)

### 视窗 viewport
视窗(viewport)是展现网页的媒体，比如窗口或者某个区域，它的大小是有限制的。

### 画布 canvas
在渲染网页的时候通常并不知道需要多大的空间，而且这些空间通常尺寸会超过 viewport 的大小，于是实际上需要设想一个无限大的画布来绘制我们的元素，即canvas。

### 包含块 Containing blocks
在 CSS2.1 中，许多框的位置和大小是相对于称为包含块的矩形框边缘来计算得到的。一般，一个元素生成的框为其后代框建立了包含块。一个框的包含块意味着该框所在的包含块，而不是其生成的包含块。


## 框的生成
一个框的类型影响其在视觉格式化模型中的表现。

### 块级元素和块框 Block-level elements and block boxes
块级元素是源文档中被格式化为块状的元素（比如，段落p），或 display 属性设置为 block、list-item 和 table 时使元素生成块级元素。

每个块级元素生成一个主要的块级框(principal block-level box)，其中包含其后代框和生成的内容，同时任何定位方案都会与这个主要的框相关。某些块级元素可能会生成额外的框相对于主要的块级框放置（比如，list-item）。

块级框是参与块格式化上下文(block formatting context)的框。

除了表格框(table boxes)和可替换元素(relpaced elements)外，一个块级框同时也是一个块容器框(block container box)。

一个块容器框要么只包含块级框，要么建立行内格式化上下文(inline formatting context)而只包含行内级框(inline-level box)。

除了不可替换的行内块(non-replaced inline blocks)和不可替换的表格单元(non-replaced table cells)外，一个块容器框同时也是一个块级框。

既是块级框又是块容器框的框称为块框。

#### 匿名块框 Anonymous block boxes
当一个块容器框内部包含有一个块级框时，将强制其内部只包含块级框。

### 行内级元素和行内框 Inline-level elements and inline boxes
行内级元素是源文档中不为其内容生成新的块，而让其内容分布在多行的元素（比如，段落内的强调文本，行内图片），或 display 属性设置为 inline、inline-table、inline-block 时使元素生成行内级元素。

行内级元素生成行内级框(inline-level boxes)，而这些行内级框参与某个行内格式化上下文。

一个 display 属性设置为 inline 的非替换元素生成一个行内框(inline boxes)。一个行内框是行内级框，且其内容参与了包含它的行内格式化上下文。

那些不是行内框的行内级框(例如，替换行内级元素(replaced inline-level elements)、行内块元素(inline-block elements)和行内表元素(inline-table elements))被称为原子行内级框(atomic inline-level boxes)，因为它们作为单个不透明框参与到其所在的行内格式化上下文中。

#### 匿名行内框 Anonymous inline boxes
任何直接包含在块容器元素中（不在行内元素中）的文本都必须被视为匿名行内元素。

匿名行内框将继承从父块框可以继承的属性，非继承属性则取其初始值。

空格内容，如果可被折叠（根据 white-space 属性），则其不会生成任何匿名行内框。

### display 属性

[display 属性取值](https://github.com/wyhcool/notes/blob/master/Web/CSS%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%973/%E7%AC%AC07%E7%AB%A0.%E5%9F%BA%E6%9C%AC%E8%A7%86%E8%A7%89%E6%A0%BC%E5%BC%8F%E5%8C%96.md#%E6%94%B9%E5%8F%98%E5%85%83%E7%B4%A0%E6%98%BE%E7%A4%BA)的意义：
- block，使元素生成一个块框(block box)。
- inline-block，使元素生成一个行内块容器(inline-level block container)，其内部被格式化为块框(block box)，元素本身被格式化为原子行内级框(atomic inline-level boxes)。
- inline，使元素生成一个或多个行内框(inline box)。
- list-item，使元素生成一个主块框(block box)和一个标记框(marker box)。
- none，使元素不出现格式化结构(formatting structure)中，即元素不生成框并且对布局没有影响。后代元素也不会生成任何框，通过在后代元素上设置 display 属性，无法覆盖此行为。

## 定位方案 Positioning schemes
在 CSS2.1 中会根据以下三种定位方案来摆放框：
- 正常流，包括对块级框的块格式化、对行内级框的行内格式化、对块级框和行内级框的相对定位。
- 浮动，在浮动模型中，一个框首先按照正常流摆放，其次从流中取出并尽可能地向左或右偏移，内容可能沿着浮动元素的一侧流动。
- 绝对定位，在绝对定位模型中，一个框完全从正常流中脱离，即对后续的流布局完全没有影响(此处仅指定位和位置计算，而绝对定位的元素在文档树中仍然与其他元素有父子或兄弟等关系），并根据其所在的包含块来定位。

如果一个元素是浮动的(float 为 left 或 right)、绝对定位的(position 为 absolute 或 fixed)或者是根元素(html)，则称该元素为流外的元素(out-of-flow)，反之，称之为流内的元素(in-flow)。换言之，流内的元素必须是正常流元素，流外的元素必须是浮动、绝对定位以及根元素。

元素 A 的流(flow)是一个集合，包括元素 A 本身，以及最近的流外祖先元素是 A 的所有流内元素。


### 选择一种定位方案：position 属性
'position'和'float'属性确定使用哪个 CSS2.1 定位算法来计算框的位置。

| 属性 | position |
|:-:|:-|
| 值 | static&#124;relative&#124;absolute&#124;fixed&#124;inherit |
| 初始值 | static |
| 应用于 | 所有元素 |
| 继承性 | 无 |
| 计算值 | 根据指定确定 |

各属性值的含义如下：
- static：元素生成的框是一个按照正常流布局的普通框。top、right、bottom、left 属性不起作用。

- relative：元素生成的框先按照正常流布局的方式计算其位置，然后框相对于其正常位置进行偏移。若框 B 使用了相对定位，则会假设框 B 还没有发生偏移之前的状态来计算其后面的框的位置。

- absoulte：该框的位置（可能还有它的尺寸）由 top、right、bottom、left 属性指定，这些属性指定了相对于该框所在的包含块的偏移量。绝对定位框会被排除在正常流之外，这意味它们对其之后的兄弟框的布局没有影响。虽然绝对定位框有外边距，但这些外边距不会与其他外边距合并。

- fixed：该框的位置相对于视窗本身是固定的，即页面滚动时并不移动。

### 框偏移 Box offsets
把 position 属性值不为 static 的元素是称为定位元素(positioned elements)。定位元素生成定位框，根据以下四个属性来确定其摆放的位置：

| 属性 | top、right、bottom、left |
|:-:|:-|
| 值 | <length\>&#124;<percentage\>&#124;auto&#124;inherit |
| 初始值 | auto |
| 应用于 | 定位元素，即 position 值不是 static 的元素 |
| 继承性 | 无 |
| 百分数 | 对于 top 和 bottom，相对于包含块的高度；对于 right 和 left，相对于包含块的宽度 |
| 计算值 | 对于长度值，是绝对长度；对于百分数值，则为指定的值；否则，auto |

对于绝对定位(absoulte, fixed)的框，偏移是基于框的包含块；对于相对定位(relative)的框，偏移是基于该框本身的外边界，即在正常流中给予框的一个位置。

top 属性指定框的上外边距边缘相对于框所在的包含块的上边缘向下偏移的距离。

right 属性指定框的右外边距边缘相对于框所在的包含块的右边缘向左偏移的距离。

bottom 属性指定框的下外边距边缘相对于框所在的包含块的下边缘向上偏移的距离。

left 属性指定框的左外边距边缘相对于框所在的包含块的左边缘向右偏移的距离。

## 正常流 Normal flow
格式化上下文(Formatting Context)是页面中的一块渲染区域，并且有一套渲染规则，它决定了其子元素将如何定位，以及和其他元素的关系和相互作用。

正常流中的框必然属于一种格式化上下文，要么是块格式化上下文，要么是行内格式化上下文。块级框参与块格式化上下文，行内级框参与行内格式化上下文。

### 块格式化上下文 Block formatting context, bfc
bfc 是一个独立的渲染区域，只有块级框参与，它规定了内部的块级框如何布局，并且与这个区域外部毫不相干。

为其内容创建新的 bfc 的条件：
- 根元素
- 浮动框，即浮动元素（元素的 float 不是 none）
- 绝对定位框，即绝对定位元素（元素的 position 是 absolute 或 fixed）
- 非块框的块容器，即元素的 display 是 inline-block、table-cell、table-caption
- overflow 属性不是 visiable 的块框

bfc 约束规则：
- 在 bfc 中，框从一个包含块的顶部开始一个接一个地垂直向下摆放，两个相邻框之间的垂直距离由 margin 属性决定。仅在 bfc 中相邻的块级框之间的垂直外边距会发生折叠(margin collapsing)，水平或垂直方向上的合并取决于 CSS 的文本书写模式(默认是垂直方向上)。

- 在 bfc 中，每个框的外边距边缘要紧贴包含块的左边缘（对于从左到右的格式化），即使存在浮动时也是如此（尽管行框可能为了避开浮动框而缩小），除非这个框创建了新的 bfc（这种情况下该框可能为了避开浮动框而变窄）。

bfc 约束规则的扩展：
- bfc 是可以嵌套的
- 内部的框会在垂直方向，从顶部开始一个接着一个地放置
- 框在垂直方向的距离由外边距决定。属于同一个 bfc 的两个相邻框的外边距发生折叠
- 每个元素的外边距边缘的左边与包含块的左边缘相接触(对于从左往右的格式化，否则相反)，即使存在浮动也是如此
- 当 bfc 外部存在浮动时，它不应该影响 bfc 内部框的布局，bfc 会通过变窄，而不与浮动有重叠
- 当 bfc 内部有浮动时，为了不影响外部元素的布局，bfc 计算高度时会包括浮动的高度
- bfc 就是页面上的一个隔离的独立容器，容器里面的子元素不会影响到外面的元素，反之亦然


### 行内格式化上下文 Inline formatting contexts, ifc
在 ifc 中，框会从包含块的顶部开始一个接一个地水平摆放。摆放这些框的时候，它们在水平方向上的外边距、边框和内边距所占用的空间都会被考虑在内。这些框会以不同的方式垂直对齐：它们的底部或顶部可以对齐，或者它们内部的文本的基线可以对齐。能把在一行上的框都完全包含进去的矩形区域称为该行的行框(line box)。

行框的宽度由包含块和浮动元素确定，行框的高度通过行高计算(line-height calculations)规则来确定。

行框总是足够高以容纳其包含的所有框，然而它也可能比所包含的最高的框还要高（例如，这些框是以基线对齐的）。当框的高度小于包含它的行框高度时，该框在行框中垂直对齐的位置由 vertical-align 属性决定。当多个行内级框(inline-level boxes)不能在一个行框内水平放置时，它们将被分布到两个或多个垂直堆放的行框中（一个段落(paragraph)是多个行框的垂直堆放）。行框垂直堆放时既没有垂直间距(除非另有说明)，也从不重叠。

通常，行框的左边缘紧贴其包含块的左边缘，而右边缘紧贴其包含块的右边缘。然而，浮动框(float boxes)可以插在包含块边缘与行框边缘之间，因此，尽管在同一个的 ifc 中的行框通常有相同的宽度（也就是包含块的宽度），但是它们的宽度也可能受浮动元素让水平可用空间减少的影响而有所改变。在同一个 ifc 的行框通常高度上会有变化（比如，一行可能包含较高的图片而其他行只包含文本）。

当一行中的行内级框的总宽度小于包含包含它们的行框的宽度时，它们在行框内的水平分布由 text-align 属性决定。如果该属性值为 justify，则用户代理可能会拉伸行内框（inline boxes，而不是行内表 inline-table 和行内块框 inline-block boxes）中的空格和字间距。

当行内框(inline box)超出行框的宽度时，它将被分割到多个框中，这些框分布在多个行框中。如果一个行内框不可分割（比如，行内框包含单个字符、或特定语言的分词规则不允许在行内框中出现中断、或者行内框的属性 [wihte-space 取值 nowrap 或 pre](https://github.com/wyhcool/notes/blob/master/Web/CSS%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%973/%E7%AC%AC06%E7%AB%A0.%E6%96%87%E6%9C%AC%E5%B1%9E%E6%80%A7.md#%E5%A4%84%E7%90%86%E7%A9%BA%E7%99%BD%E7%AC%A6-white-space)时），那么该行内框将溢出该行框。<font color=red>Supercalifragilisticexpialidocious</font>

当分割行内框时，外边距、边框和内边距在出现分割的地方没有视觉影响（就像纸条分割成多个短纸条）。

取决于双向文本处理，行内框也可能在同一个行框内被分割为多个框。

行框会被按需创建来包含 ifc 中的行内级内容。如果行框不包含文本、不保留空白符，不包含外边距、边框或内边距非零的行内框、也不包含其他流内(in-flow)的内容(比如、图片、行内块、行内表)，也不以保留的换行符结尾，像这样的行框，如果是为了决定在其中任意元素的定位，则必须以零高度的行框来对待，如果为了其他一些目的，则必须视其为不存在来对待。

### 相对定位 Relative positioning
当一个框按照正常流或浮动来摆放好之后，它就可以相对于该位置再有所偏移，这就是相对定位。以这种方式使框 B1 发生偏移，对跟随其后的框 B2 没有影响：B2 定位就好像 B1 没有发生偏移，并且在 B1 应用了偏移后，B2 不进行重新定位。这意味着相对定位可能导致框重叠，但是如果相对定位导致一个 overflow 属性指定为 auto 或 scroll 的框有了溢出，则用户代理允许通过必须创建滚动条来使用户访问这些偏移位置的内容，这可能会影响布局。

相对定位的框保持其在正常流中的大小，包括最初为其保留的换行和空白。相对定位的框会建立新的包含块。

相对定位的元素，left 和 right 属性会在不改变其框尺寸的情况下水平地移动框。left 将框向右移动，right 将框向左移动，向左或向右都不会分割或拉伸框，因此使用值总是：left = -right。

如果 left 和 right 都是 auto（它们的初始值），则使用值都是 0，即水平方向上框会保持在它们的原始位置。

如果 left 是 auto，则使用值是：-right。即框向左移动 right 的值。

如果 right 是 auto，则使用值是：-left。

如果 left 和 right 都不是 auto，则位置过度约束(over-constrained)，因此其中一个值将被忽略。如果包含块的 direction 属性是 ltr，则 left 属性胜出，right 的值设为 -left，反之则反。

top 和 bottom 属性会在不改变其框尺寸的情况下上下地移动框。top 将框向下移动，bottom 将框向上移动，向上或向下移动都会分割或拉伸框，因此使用值总是： top = -bottom。

如果 top 和 bottom 都是 auto，则使用值都是 0，即垂直方向上框会保持在它们的原始位置。

如果其中一个为 auto，则另一个变为它的负值。

如果两个都不是 auto，则忽略 bottom，将 bottom 值设置为 -top。

## 浮动 Floats
浮动是一个框在当前行上(on the current line)向左或向右移动。浮动框最有趣的特征是：内容可能沿着其侧面流动（或通过 clear 属性禁止这样做）。内容沿着左浮动框右侧向下流动，沿着右浮动框的左侧向下流动。

浮动的盒子向左或向右移动，直到它的外边缘接触到其包含块的边缘，或者另一个浮动元素的外边缘。如果有一个行框，则浮动框的外顶部与行框的顶部对齐。

如果没有足够的水平空间给浮动元素，它将向下移动，直到有适合的空间或者没有浮动元素的位置。

<font color=red>由于浮动不在流中，在浮动框之前或之后创建的非定位块框(non-positioned block boxes)垂直流动，就好像浮动不存在一样。但是，在浮动框旁边(next to)创建的当前和后续行框会缩短，以便于容纳浮动框。</font>

当存在一个满足所有这四个条件的垂直位置(vertical position，即一个点)时，一个行框 next to 一个浮动框：
- 位于行框顶部或以下
- 位于行框底部或以上
- 位于浮动块的上外边缘以下
- 位于浮动框的下外边缘以上

![vertical-position](https://github.com/wyhcool/notes/blob/master/Web/CSS2.1SPEC/09_floats-vertical-position.png)

注意⚠️：这意味着外部高度(outer height)为零或为负值的浮动框不会缩短行框。

如果被缩短的行框太小而不能包含任何内容时，则行框向下移动(并重新计算其宽度)直到能够包含内容或者不再有浮动元素处。在当前行中出现在浮动框之前的内容都会在浮动的另一侧中<font color=red>重排(reflowed)</font>，换言之，如果在遇到适合于剩余行框空间的左浮动框之前，将行内级框放置在行上，那么左浮动将放置在该行上，与行框的顶部对齐，然后行上已有的行内级框将移动到浮动的右侧（右侧是左浮动的另一起点），反之亦然，对于从右到左放置的行内框和右浮动。

表、块级替换元素、正常流中建立新的 bfc 的元素(比如 overflow 属性不是 visiable 的元素)的边框盒(border box)不能与同一个 bfc 内的所有浮动元素的外边距盒(margin box)重叠。如有必要，用户代理应该通过将该元素放置在任何前面的浮动元素的下面来清除该元素，但是如果有足够的空间，则可以将其放置在这些浮动框的旁边。

多个浮动框可能相邻，此模型也适用于同一行中相邻的浮动框。

浮动框的外边距不会与相邻框的外边距叠加。

一个浮动可以覆盖正常流中其它的框（如与浮动相邻的常规流向框的边距为负数）：
- 如果一个行内框覆盖一个浮动框，该行内框的内容、背景和边框在该浮动之上渲染。
- 如果一个块框覆盖一个浮动框，块框的背景和边框在浮动之下渲染，并只有在浮动为透明时才可见，块框的内容在浮动之上渲染。


### 浮动定位：float 属性

| 属性 | float |
|:-:|:-|
| 值 | left&#124;right&#124;none&#124;inherit |
| 初始值 | none |
| 应用于 | 除了非绝对定位的所有元素 |
| 继承性 | 无 |
| 计算值 | 根据指定确定 |

- left：该元素生成一个浮动到左侧的块框(block box)，内容从浮动框的右侧自顶部开始流动(受 clear 属性限制)
- right：该元素生成一个浮动到右侧的块框(block box)，内容从浮动框的左侧自顶部开始流动(受 clear 属性限制)
- none：该框没有浮动。

控制浮动行为的精确规则（类似规则适用于右浮动元素）：
- 水平限制：
  - 左浮动框的左外边缘必须出现在其包含块的左边缘的右侧。
  - 左浮动框的左外边缘必须出现在源文档中较早的左浮动元素的右外边缘的右侧，或者其顶部必须低于前一个浮动框的底部。
  - 左浮动框的右外边缘必须出现在其旁边的任何右浮动框左边缘的右侧。
  - 向左浮动的框若左边还有另一个左浮动框，它的右边缘必须在其包含块的右外边缘的左边。（向左浮动的框可能不会在包含块的右边缘伸出，除非它已经尽可能地靠左边）。
- 垂直限制：
  - 浮动框的上外边缘必须不高于其包含块的顶部。当浮动发生在两个叠加外边距之间时，浮动框定位在好像它有一个参与到流中的空的匿名父级块中，这个父级块的位置由外边距叠加的规则定义。
  - 浮动框的上外边缘必须不高于在源文档中较早出现的任何块或浮动框的上外边缘。
  - 浮动框的上外边缘必须不高于包含源文档中较早出现的框的任何行框的顶部。
  - 浮动框必须尽可能高地放置

- 左浮动的必须尽可能地向左侧放置，右浮动的必须尽可能向右侧放置。位置越高，向左或向右放置得越远。

这些规则仅对与浮动元素处于同一 bfc 的其他元素生效。

### 控制紧接浮动的流：clear 属性 Controlling flow next to floats

| 属性 | clear |
|:-:|:-|
| 值 | left&#124;right&#124;both&#124;none&#124;inherit |
| 初始值 | none |
| 应用于 | 块级元素 |
| 继承性 | 无 |
| 计算值 | 根据指定确定 |

clear 属性指示元素框的哪一边不能与先前的浮动框毗连，clear 属性不考虑元素内部的或其他 bfc 内的浮动。

应用于非浮动块级框(non-floating block-level boxes)时，值具有以下含义：

- left，要求框的上边框边缘位于源文档中较早元素产生的任何左浮动框的底部外边缘下方。
- right，要求框的上边框边缘位于源文档中较早元素产生的任何右浮动框的底部外边缘下方。
- both，要求框的上边框边缘位于源文档较早生成的任何左浮动和右浮动框的底部外边缘下方。
- none，框相对于浮动的位置没有约束。

clear 属性取值不是 none 时潜在地引入了间隙(clearance)。间隙会阻止外边距叠加(margin collpasing)，并充当元素的上外边距之上的间距(acts as spacing above the margin-top of an element)，间隙会推动元素垂直地越过浮动框（设置 clear 非 none 的元素的 margin-top 是否生效，主要取决于这个 margin-top 能否推动该元素越过所有 float 元素的）。















## 绝对定位

## display、position 和 float 关系

## 正常流、浮动和绝对定位的比较

## 文本方向：direction 和 unicode-bidi 属性
[略](https://github.com/wyhcool/notes/blob/master/Web/CSS%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%973/%E7%AC%AC06%E7%AB%A0.%E6%96%87%E6%9C%AC%E5%B1%9E%E6%80%A7.md#%E6%96%87%E6%9C%AC%E6%96%B9%E5%90%91-direction)







## 参考
[1] [Box model | CSS2.1 |W3C](https://www.w3.org/TR/2011/REC-CSS2-20110607/box.html)

[2] [视觉格式化模型 | MDN](https://developer.mozilla.org/zh-CN/docs/Web/Guide/CSS/Visual_formatting_model)

[3] [CSS 布局 | winter-cn](https://www.cnblogs.com/winter-cn/archive/2013/05/11/3072929.html)

[4] [浮动原本的作用是实现文字环绕 | SegmentFault](https://segmentfault.com/q/1010000009827767)

[5] [视觉格式化模型 |中文wiki](https://www.w3.org/html/ig/zh/wiki/CSS2/visuren)