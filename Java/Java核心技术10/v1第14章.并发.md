---
title: å¹¶å‘
date: 2019-03-22 10:40:00
tags:
categories:
- Java
---

æ“ä½œç³»ç»Ÿçš„å¤šä»»åŠ¡(multitasking)æ˜¯æŒ‡åœ¨åŒä¸€æ—¶åˆ»è¿è¡Œå¤šä¸ªç¨‹åºçš„èƒ½åŠ›ã€‚

å¤šçº¿ç¨‹ç¨‹åºæ˜¯åœ¨è¾ƒä½çš„å±‚æ¬¡ä¸Šæ‰©å±•äº†å¤šä»»åŠ¡(multitasking)çš„æ¦‚å¿µï¼šä¸€ä¸ªç¨‹åºåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚é€šå¸¸ï¼Œæ¯ä¸€ä¸ªä»»åŠ¡ç§°ä¸ºä¸€ä¸ªçº¿ç¨‹(thread)ï¼Œå®ƒæ˜¯çº¿ç¨‹æ§åˆ¶çš„ç®€ç§°ã€‚å¯ä»¥åŒæ—¶è¿è¡Œä¸€ä¸ªä»¥ä¸Šçº¿ç¨‹çš„ç¨‹åºç§°ä¸ºå¤šçº¿ç¨‹ç¨‹åº(multithreaded)ã€‚

å¤šè¿›ç¨‹ä¸å¤šçº¿ç¨‹æœ‰å“ªäº›åŒºåˆ«å‘¢ï¼Ÿæœ¬è´¨çš„åŒºåˆ«åœ¨äºæ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰è‡ªå·±çš„ä¸€æ•´å¥—å˜é‡ï¼Œè€Œçº¿ç¨‹åˆ™å…±äº«æ•°æ®ã€‚å…±äº«å˜é‡ä½¿çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ¯”è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æ›´æœ‰æ•ˆã€æ›´å®¹æ˜“ã€‚æ­¤å¤–ï¼Œåœ¨æŸäº›æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸è¿›ç¨‹ç›¸æ¯”è¾ƒï¼Œçº¿ç¨‹æ›´è½»é‡çº§ï¼Œåˆ›å»ºã€æ’¤é”€ä¸€ä¸ªçº¿ç¨‹æ¯”å¯åŠ¨æ–°è¿›ç¨‹çš„å¼€é”€è¦å°å¾—å¤šã€‚

## ä»€ä¹ˆæ˜¯çº¿ç¨‹
è°ƒç”¨ `Thread.sleep` æ–¹æ³•ä¸ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œè€Œæ˜¯ç”¨äºæš‚åœå½“å‰çº¿ç¨‹çš„æ´»åŠ¨ã€‚`sleep` æ–¹æ³•å¯ä»¥æŠ›å‡ºä¸€ä¸ª `InterruptedException` å¼‚å¸¸ã€‚

åœ¨æ²¡æœ‰ä½¿ç”¨å¤šçº¿ç¨‹æ—¶ï¼Œç”¨æˆ·å¾ˆéš¾è®©å®ƒæ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚å¿…é¡»ç­‰å¾…ä¸Šä¸€ä¸ªè¿‡ç¨‹æ‰§è¡Œå®Œæ¯•æ‰èƒ½ä¸ç¨‹åºè¿›è¡Œäº¤äº’ã€‚

### ä½¿ç”¨çº¿ç¨‹ç»™å…¶ä»–ä»»åŠ¡æä¾›æœºä¼š
å¯ä»¥å°†ç§»åŠ¨çƒçš„ä»£ç æ”¾ç½®åœ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­ï¼Œè¿è¡Œè¿™æ®µä»£ç å¯ä»¥æé«˜å¼¹è·³çƒçš„å“åº”èƒ½åŠ›ã€‚å®é™…ä¸Šï¼Œå¯ä»¥å‘èµ·å¤šä¸ªçƒï¼Œæ¯ä¸ªçƒéƒ½åœ¨è‡ªå·±çš„çº¿ç¨‹ä¸­è¿è¡Œã€‚

å¦å¤–ï¼ŒAWT çš„äº‹ä»¶åˆ†é…çº¿ç¨‹(event dispatch thread)å°†ä¸€ç›´åœ°å¹¶è¡Œè¿è¡Œï¼Œä»¥å¤„ç†ç”¨æˆ·ç•Œé¢çš„äº‹ä»¶ã€‚ç”±äºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰æœºä¼šå¾—ä»¥è¿è¡Œï¼Œæ‰€åœ¨åœ¨çƒå¼¹è·³æœŸé—´ï¼Œå½“ç”¨æˆ·ç‚¹å‡» Close æŒ‰é’®æ—¶ï¼Œäº‹ä»¶è°ƒåº¦çº¿ç¨‹å°†æœ‰æœºä¼šå…³æ³¨åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œå¹¶å¤„ç†å…³é—­åŠ¨ä½œã€‚

é€šå¸¸ï¼Œéœ€è¦è­¦æƒ•ä»»ä½•é•¿æ—¶é—´è¿è¡Œçš„è®¡ç®—ï¼Œè¿™è®¡ç®—å¯èƒ½æ˜¯æ›´å¤§çš„æ¡†æ¶ï¼ˆä¾‹å¦‚ GUI æˆ– Web æ¡†æ¶ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚æ¯å½“æ¡†æ¶è°ƒç”¨æ–¹æ³•æ—¶ï¼Œé€šå¸¸éƒ½ä¼šæœŸæœ›å¿«é€Ÿçš„è¿”å›ã€‚å¦‚æœéœ€è¦æ‰§è¡Œä»»ä½•è€—æ—¶çš„ä»»åŠ¡ï¼Œåˆ™åº”å½“å¹¶å‘åœ°è¿è¡Œä»»åŠ¡ã€‚

åœ¨ä¸€ä¸ªå•ç‹¬åœ°çº¿ç¨‹ä¸­æ‰§è¡Œä¸€ä¸ªä»»åŠ¡çš„è¿‡ç¨‹ï¼š
1) å°†ä»»åŠ¡ä»£ç ç§»åˆ°å®ç°äº† `Runnable` æ¥å£çš„ç±»çš„ `run` æ–¹æ³•ä¸­ï¼Œè¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œå¯ä»¥ç”¨ lambda è¡¨è¾¾å¼å»ºç«‹ä¸€ä¸ªå®ä¾‹ï¼š
```java
public interface Runnable {
    void run();
}

Runnable r = () -> { /* task code */ }
```
2) ç”± `Runnable` åˆ›å»ºä¸€ä¸ª `Thread` å¯¹è±¡ï¼š
```java
Thread t = new Thread(r);
```
3) å¯åŠ¨çº¿ç¨‹ï¼š
```java
t.start();
```

å°†å¼¹è·³çƒä»£ç æ”¾åœ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­ï¼Œåªéœ€è¦å®ç°ä¸€ä¸ªç±» `BallRunnable`ï¼Œç„¶åå°†åŠ¨ç”»ä»£ç æ”¾åœ¨ run æ–¹æ³•ä¸­ï¼š
```java
new Thread(()-> {
    try {
        for (int i = 1; i <= STEPS; i++) {
            ball.move(comp.getBounds());
            comp.repaint();
            Thread.sleep(DELAY);
        }
    } catch (InterruptedException e) {

    }
}).start();
```
åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œçº¿ç¨‹åœ¨ä¸­æ–­æ—¶è¢«ç»ˆæ­¢ã€‚å› æ­¤ï¼Œå½“å‘ç”Ÿ `InterruptedException` å¼‚å¸¸æ—¶ï¼Œ`run` æ–¹æ³•å°†ç»“æŸæ‰§è¡Œã€‚

åº”è¯¥å°†è¦å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ä¸è¿è¡Œæœºåˆ¶è§£è€¦åˆï¼Œå¦‚æœæœ‰å¾ˆå¤šä»»åŠ¡ï¼Œè¦ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ‰€ä»˜å‡ºçš„ä»£ä»·å¤ªå¤§äº†ï¼Œå¯ä»¥ä½¿ç”¨çº¿ç¨‹æ± æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

è­¦å‘Šâš ï¸ï¼šä¸è¦è°ƒç”¨ `Thread` ç±»æˆ– `Runnable` å¯¹è±¡çš„ `run` æ–¹æ³•ã€‚ç›´æ¥è°ƒç”¨ `run` æ–¹æ³•ï¼Œåªä¼šæ‰§è¡ŒåŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä»»åŠ¡ï¼Œè€Œä¸ä¼šå¯åŠ¨æ–°çº¿ç¨‹ã€‚åº”è¯¥è°ƒç”¨ `Thread.start` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†åˆ›å»ºä¸€ä¸ªæ‰§è¡Œ `run` æ–¹æ³•çš„æ–°çº¿ç¨‹ã€‚


## ä¸­æ–­çº¿ç¨‹
å½“çº¿ç¨‹çš„ `run` æ–¹æ³•æ‰§è¡Œæ–¹æ³•ä½“ä¸­æœ€åä¸€æ¡è¯­å¥åï¼Œå¹¶ç»ç”±æ‰§è¡Œ `return` è¯­å¥è¿”å›ï¼Œæˆ–è€…å‡ºç°äº†åœ¨æ–¹æ³•ä¸­æ²¡æœ‰æ•è·çš„å¼‚å¸¸æ—¶ï¼Œçº¿ç¨‹å°†ç»ˆæ­¢ã€‚

åœ¨ Java çš„æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œæœ‰ä¸€ä¸ª `stop` æ–¹æ³•ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è°ƒç”¨è¯¥æ–¹æ³•æ¥ç»ˆæ­¢çº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•ç°åœ¨å·²ç»è¢«åºŸå¼ƒã€‚

é™¤äº†ä¸æ¨èä½¿ç”¨çš„ `stop` æ–¹æ³•ä¹‹å¤–ï¼Œæ²¡æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥å¼ºåˆ¶çº¿ç¨‹ç»ˆæ­¢ã€‚ä½†æ˜¯ï¼Œ`interrupt` ä¸­æ–­æ–¹æ³•å¯ç”¨äºè¯·æ±‚çº¿ç¨‹ç»ˆæ­¢ã€‚

å½“å¯¹ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `interrupt` æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€(interrupted status)å°†è¢«ç½®ä½ï¼Œè¿™æ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å…·æœ‰çš„ `boolean` æ ‡å¿—ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åº”ä¸æ—¶åœ°æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ï¼Œä»¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ã€‚

åˆ¤æ–­ä¸­æ–­çŠ¶æ€æ˜¯å¦è¢«ç½®ä½ï¼Œé¦–å…ˆè°ƒç”¨é™æ€çš„ `Thread.currentThread` æ–¹æ³•è·å¾—å½“å‰çº¿ç¨‹ï¼Œç„¶åè°ƒç”¨ `isInterrupted` æ–¹æ³•ï¼š
```java
while (!Thread.currentThread().isInterrupted() /* && more work to do */) {
    // do more work
}
```
ä½†æ˜¯ï¼Œçº¿ç¨‹å¦‚æœè¢«é˜»å¡ï¼Œå°±æ— æ³•æ£€æµ‹ä¸­æ–­çŠ¶æ€ï¼Œè¿™æ˜¯äº§ç”Ÿ `InterruptedException` å¼‚å¸¸çš„åœ°æ–¹ã€‚å½“åœ¨ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹(è°ƒç”¨ `sleep` æˆ– `wait`)ä¸Šè°ƒç”¨ `interrupt` æ–¹æ³•æ—¶ï¼Œé˜»å¡è°ƒç”¨å°†ä¼šè¢« `InterruptedException` å¼‚å¸¸ä¸­æ–­ã€‚ï¼ˆå¦‚æœå­˜åœ¨ä¸èƒ½è¢«ä¸­æ–­çš„é˜»å¡ `I/O` è°ƒç”¨ï¼Œåº”è¯¥è€ƒè™‘é€‰æ‹©å¯ä¸­æ–­çš„è°ƒç”¨ã€‚ï¼‰

æ²¡æœ‰ä»»ä½•è¯­è¨€æ–¹é¢çš„éœ€æ±‚è¦æ±‚ä¸€ä¸ªè¢«ä¸­æ–­çš„çº¿ç¨‹åº”è¯¥ç»ˆæ­¢ã€‚ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ä¸è¿‡æ˜¯å¼•èµ·å®ƒçš„æ³¨æ„ã€‚è¢«ä¸­æ–­çš„çº¿ç¨‹å¯ä»¥å†³å®šå¦‚ä½•å“åº”ä¸­æ–­ã€‚æŸäº›çº¿ç¨‹æ˜¯å¦‚æ­¤é‡è¦ï¼Œä»¥è‡³äºå®ƒä»¬åº”è¯¥åœ¨å¤„ç†å®Œå¼‚å¸¸åï¼Œç»§ç»­æ‰§è¡Œï¼Œè€Œä¸ç†ä¼šä¸­æ–­ã€‚ä½†æ›´æ™®éçš„æ˜¯ï¼Œçº¿ç¨‹ç®€å•åœ°å°†ä¸­æ–­è§£é‡Šä¸ºç»ˆæ­¢çš„è¯·æ±‚ï¼Œè¿™æ ·çš„çº¿ç¨‹çš„ `run` æ–¹æ³•å…·æœ‰ä»¥ä¸‹å½¢å¼ï¼š
```java
Runnable r = () -> {
    try {
        //...
        while (!Thread.currentThread().isInterrupted() /* && more work to do */) {
            // do more work
        }
    } catch (InterruptedException ex) {
        // thread was interrupted during sleep or wait
    } finally {
        // cleanup, if required
    }
    // exiting the run method termintates the thread
};
```

å¦‚æœåœ¨æ¯æ¬¡è¿­ä»£ä¹‹åè°ƒç”¨ `sleep` æ–¹æ³•ï¼ˆæˆ–å…¶ä»–çš„å¯ä¸­æ–­æ–¹æ³•ï¼‰ï¼Œåˆ™ `isInterrupted` æ£€æŸ¥æ—¢ä¸å¿…è¦ä¹Ÿä¸æœ‰ç”¨ã€‚å¦‚æœåœ¨è®¾ç½®äº†ä¸­æ–­çŠ¶æ€æ—¶è°ƒç”¨äº† `sleep` æ–¹æ³•ï¼Œåˆ™å®ƒä¸ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ã€‚ è€Œæ˜¯æ¸…é™¤çŠ¶æ€å¹¶å¼•å‘ `InterruptedException`ã€‚å› æ­¤ï¼Œå¦‚æœå¾ªç¯è°ƒç”¨ `sleep` æ—¶ï¼Œä¸è¦æ£€æŸ¥ä¸­æ–­çŠ¶æ€ã€‚è€Œæ˜¯æ•è· `InterruptedException`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```java
Runnable r = () -> {
    try {
        //...
        while (/* more work to do */) {
            // do more work
            Thread.sleep(delay);
        }
    } catch (InterruptedException ex) {
        // thread was interrupted during sleep or wait
    } finally {
        // cleanup, if required
    }
    // exiting the run method termintates the thread
};
```
æ³¨æ„âš ï¸ï¼šæœ‰ä¸¤ä¸ªéå¸¸ç±»ä¼¼çš„æ–¹æ³•ï¼Œ`interrupted` æ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå®ƒæ£€æµ‹å½“å‰çš„çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œæ­¤å¤–ï¼Œè°ƒç”¨ `interrupted` æ–¹æ³•ä¼šæ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ã€‚å¦ä¸€æ–¹é¢ï¼Œ`isInterrupted` æ–¹æ³•æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œå¯ç”¨äºæ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•çº¿ç¨‹è¢«ä¸­æ–­ï¼Œè°ƒç”¨å®ƒä¸ä¼šæ›´æ”¹ä¸­æ–­çŠ¶æ€ã€‚


## çº¿ç¨‹çŠ¶æ€
çº¿ç¨‹å¯ä»¥æœ‰ 6 ç§çŠ¶æ€ï¼š
- newï¼ˆæ–°åˆ›å»ºï¼‰
- runnableï¼ˆå¯è¿è¡Œï¼‰
- blockedï¼ˆè¢«é˜»å¡ï¼‰
- waitingï¼ˆç­‰å¾…ï¼‰
- timed waitingï¼ˆè®¡æ—¶ç­‰å¾…ï¼‰
- terminatedï¼ˆè¢«ç»ˆæ­¢ï¼‰

è¦ç¡®å®šä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼Œå¯è°ƒç”¨ `getState` æ–¹æ³•ã€‚

### æ–°åˆ›å»ºçº¿ç¨‹
å½“ç”¨ `new` æ“ä½œç¬¦åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ—¶ï¼Œè¯¥çº¿ç¨‹è¿˜æ²¡æœ‰å¼€å§‹è¿è¡Œã€‚è¿™æ„å‘³ç€å®ƒçš„çŠ¶æ€æ˜¯ `new`ã€‚å½“ä¸€ä¸ªçº¿ç¨‹å¤„äºæ–°åˆ›å»ºçŠ¶æ€æ—¶ï¼Œç¨‹åºè¿˜æ²¡æœ‰å¼€å§‹è¿è¡Œçº¿ç¨‹ä¸­çš„ä»£ç ã€‚åœ¨çº¿ç¨‹è¿è¡Œä¹‹å‰è¿˜æœ‰ä¸€äº›åŸºç¡€å·¥ä½œè¦åšã€‚

### å¯è¿è¡Œçº¿ç¨‹
ä¸€æ—¦è°ƒç”¨ `start` æ–¹æ³•ï¼Œçº¿ç¨‹å¤„äº `runnable` çŠ¶æ€ã€‚ä¸€ä¸ªå¯è¿è¡Œçš„çº¿ç¨‹å¯èƒ½æ­£åœ¨è¿è¡Œï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰è¿è¡Œï¼Œè¿™å–å†³äºæ“ä½œç³»ç»Ÿç»™çº¿ç¨‹æä¾›è¿è¡Œçš„æ—¶é—´ã€‚

ä¸€æ—¦ä¸€ä¸ªçº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œå®ƒä¸å¿…å§‹ç»ˆä¿æŒè¿è¡Œã€‚äº‹å®ä¸Šï¼Œè¿è¡Œä¸­çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©å…¶ä»–çº¿ç¨‹è·å¾—è¿è¡Œæœºä¼šã€‚çº¿ç¨‹è°ƒåº¦çš„ç»†èŠ‚ä¾èµ–äºæ“ä½œç³»ç»Ÿæä¾›çš„æœåŠ¡ã€‚æŠ¢å å¼è°ƒåº¦ç³»ç»Ÿç»™æ¯ä¸€ä¸ªå¯è¿è¡Œçº¿ç¨‹ä¸€ä¸ªæ—¶é—´ç‰‡æ¥æ‰§è¡Œä»»åŠ¡ã€‚å½“æ—¶é—´ç‰‡ç”¨å®Œï¼Œæ“ä½œç³»ç»Ÿå‰¥å¤ºè¯¥çº¿ç¨‹çš„è¿è¡Œæƒï¼Œå¹¶ç»™å¦ä¸€ä¸ªçº¿ç¨‹è¿è¡Œæœºä¼šã€‚å½“é€‰æ‹©ä¸‹ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»Ÿè€ƒè™‘çº¿ç¨‹çš„ä¼˜å…ˆçº§ã€‚

ç°åœ¨æ‰€æœ‰çš„æ¡Œé¢ä»¥åŠæœåŠ¡å™¨æ“ä½œç³»ç»Ÿéƒ½ä½¿ç”¨æŠ¢å å¼è°ƒåº¦ï¼Œä½†æ˜¯ï¼Œåœ¨ä¸€äº›å°å‹è®¾å¤‡ä¸Šå¯èƒ½ä½¿ç”¨åä½œå¼è°ƒåº¦ï¼šä¸€ä¸ªçº¿ç¨‹åªæœ‰åœ¨è°ƒç”¨ `yield` æ–¹æ³•ã€æˆ–è€…è¢«é˜»å¡æˆ–ç­‰å¾…æ—¶ï¼Œçº¿ç¨‹æ‰å¤±å»æ§åˆ¶æƒã€‚

åœ¨å…·æœ‰å¤šä¸ªå¤„ç†å™¨çš„æœºå™¨ä¸Šï¼Œæ¯ä¸€ä¸ªå¤„ç†å™¨è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹å¹¶è¡Œè¿è¡Œã€‚å¦‚æœçº¿ç¨‹çš„æ•°ç›®å¤šäºå¤„ç†å™¨çš„æ•°ç›®ï¼Œè°ƒåº¦å™¨ä¾ç„¶é‡‡ç”¨æ—¶é—´ç‰‡æœºåˆ¶ã€‚

åœ¨ä»»ä½•ç»™å®šæ—¶åˆ»ï¼Œä¸€ä¸ªå¯è¿è¡Œçš„çº¿ç¨‹å¯èƒ½æ­£åœ¨è¿è¡Œä¹Ÿå¯èƒ½æ²¡æœ‰è¿è¡Œï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå°†è¿™ä¸ªçŠ¶æ€ç§°ä¸ºâ€œå¯è¿è¡Œ(runnable)â€è€Œä¸æ˜¯â€œè¿è¡Œ(running)â€ã€‚

### è¢«é˜»å¡çº¿ç¨‹å’Œç­‰å¾…çº¿ç¨‹
å½“çº¿ç¨‹å¤„äºè¢«é˜»å¡æˆ–ç­‰å¾…çŠ¶æ€æ—¶ï¼Œå®ƒæš‚æ—¶ä¸æ´»åŠ¨ã€‚å®ƒä¸è¿è¡Œä»»ä½•ä»£ç ä¸”æ¶ˆè€—æœ€å°‘çš„èµ„æºã€‚ç›´åˆ°çº¿ç¨‹è°ƒåº¦å™¨é‡æ–°æ¿€æ´»å®ƒã€‚ç»†èŠ‚å–å†³äºå®ƒæ˜¯æ€æ ·è¾¾åˆ°éæ´»åŠ¨çŠ¶æ€çš„ã€‚

1) å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå†…éƒ¨çš„å¯¹è±¡é”ï¼ˆè€Œä¸æ˜¯ java.util.concurrent åº“ä¸­çš„`Lock`ï¼‰ï¼Œè€Œè¯¥é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚å½“æ‰€æœ‰å…¶ä»–çº¿ç¨‹é‡Šæ”¾è¯¥é”ï¼Œå¹¶ä¸”çº¿ç¨‹è°ƒåº¦å™¨å…è®¸æœ¬çº¿ç¨‹æŒæœ‰å®ƒçš„æ—¶å€™ï¼Œè¯¥çº¿ç¨‹å°†å˜æˆéé˜»å¡çŠ¶æ€ã€‚

2) å½“çº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹å°†æ¡ä»¶é€šçŸ¥è°ƒåº¦å™¨æ—¶ï¼Œå®ƒè‡ªå·±è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚åœ¨è°ƒç”¨ `Object.wait` æ–¹æ³•æˆ– `Thread.join` æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ç­‰å¾… java.util.concurrent åº“ä¸­çš„ `Lock` æˆ– `Condition` æ—¶ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚å®é™…ä¸Šï¼Œé˜»å¡çŠ¶æ€ä¸ç­‰å¾…çŠ¶æ€ä¹‹é—´çš„å·®å¼‚å¹¶ä¸æ˜æ˜¾ã€‚

3) æœ‰å‡ ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªè¶…æ—¶å‚æ•°ï¼Œè°ƒç”¨å®ƒä»¬å¯¼è‡´çº¿ç¨‹è¿›å…¥è®¡æ—¶ç­‰å¾…(timed waiting)çŠ¶æ€ã€‚è¿™ä¸€çŠ¶æ€å°†ä¸€ç›´ä¿æŒåˆ°è¶…æ—¶æœŸæ»¡æˆ–è€…æ¥æ”¶åˆ°é€‚å½“çš„é€šçŸ¥ã€‚å¸¦æœ‰è¶…æ—¶å‚æ•°çš„æ–¹æ³•æœ‰ `Thread.sleep` ä»¥åŠ `Object.wait`ã€`Thread.join`ã€`Lock.tryLock` å’Œ `Condition.await` çš„å®šæ—¶ç‰ˆæœ¬ã€‚

å½“ä¸€ä¸ªçº¿ç¨‹è¢«é˜»å¡æˆ–ç­‰å¾…æ—¶ï¼ˆæˆ–ç»ˆæ­¢æ—¶ï¼‰å¦ä¸€ä¸ªçº¿ç¨‹å°†è¢«è°ƒåº¦ä¸ºè¿è¡ŒçŠ¶æ€ã€‚

å½“ä¸€ä¸ªçº¿ç¨‹è¢«é‡æ–°æ¿€æ´»æ—¶ï¼ˆä¾‹å¦‚ï¼Œå› ä¸ºè¶…æ—¶æœŸæ»¡æˆ–è€…æˆåŠŸåœ°è·å¾—äº†ä¸€ä¸ªé”ï¼‰ï¼Œè°ƒåº¦å™¨å°†æ£€æŸ¥å®ƒæ˜¯å¦å…·æœ‰æ¯”å½“å‰è¿è¡Œçº¿ç¨‹æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œè°ƒåº¦å™¨ä»å½“å‰è¿è¡Œçš„çº¿ç¨‹ä¸­æŒ‘é€‰ä¸€ä¸ªï¼Œå‰¥å¤ºå…¶è¿è¡Œæƒï¼Œé€‰æ‹©ä¸€ä¸ªæ–°çš„çº¿ç¨‹è¿è¡Œã€‚

### è¢«ç»ˆæ­¢çš„çº¿ç¨‹
çº¿ç¨‹å› å¦‚ä¸‹ä¸¤ä¸ªåŸå› ä¹‹ä¸€è€Œè¢«ç»ˆæ­¢ï¼š
- å› ä¸º `run` æ–¹æ³•æ­£å¸¸æ¨å‡ºè€Œè‡ªç„¶æ­»äº¡ã€‚
- å› ä¸ºä¸€ä¸ªæ²¡æœ‰æ•è·çš„å¼‚å¸¸ç»ˆæ­¢äº† `run` æ–¹æ³•è€Œæ„å¤–æ­»äº¡ã€‚

ç‰¹åˆ«æ˜¯ï¼Œå¯ä»¥è°ƒç”¨çº¿ç¨‹çš„ `stop` æ–¹æ³•æ€æ­»ä¸€ä¸ªçº¿ç¨‹ï¼Œè¯¥æ–¹æ³•æŠ›å‡º `ThreadDeath` é”™è¯¯å¯¹è±¡ï¼Œç”±æ­¤æ€æ­»çº¿ç¨‹ã€‚ä½†æ˜¯ `stop` æ–¹æ³•å·²è¿‡æ—¶ï¼Œå‹¿ä½¿ç”¨ã€‚

```
        æ–°åˆ›å»º
          |
          | å¼€å§‹
          |     ------------- è¯·æ±‚é” -----------> è¢«é˜»å¡
          |    / <----------  å¾—åˆ°é” ---------------|
          |   /
        å¯è¿è¡Œ _____------------- ç­‰å¾…é€šçŸ¥ ----------> ç­‰å¾…
          |  \     <------------ å‡ºç°é€šçŸ¥ -------------|
          |   \
          |    \_____------- ç­‰å¾…è¶…æ—¶æˆ–é€šçŸ¥ ---------> è®¡æ—¶ç­‰å¾…
          |          <------ å‡ºç°è¶…æ—¶æˆ–é€šçŸ¥ --------------|
          |
          | è¿è¡Œæ–¹æ³•
          | exits
          |
        è¢«ç»ˆæ­¢
```


## çº¿ç¨‹å±æ€§
### çº¿ç¨‹ä¼˜å…ˆçº§
åœ¨ Java ä¸­ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªä¼˜å…ˆçº§ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ç»§æ‰¿æ„é€ å®ƒçš„çº¿ç¨‹çš„ä¼˜å…ˆçº§ã€‚å¯ä»¥ç”¨ `setPriority` æ–¹æ³•æé«˜æˆ–é™ä½ä»»ä½•ä¸€ä¸ªçº¿ç¨‹çš„ä¼˜å…ˆçº§ã€‚å¯ä»¥å°†ä¼˜å…ˆçº§è®¾ç½®ä¸ºåœ¨ `MIN_PRIORITY`ï¼ˆåœ¨ `Thread` ç±»ä¸­å®šä¹‰ä¸º 1ï¼‰ä¸ `MAX_PRIORITY`ï¼ˆå®šä¹‰ä¸º 10ï¼‰ä¹‹é—´çš„ä»»ä½•å€¼ï¼Œ`NORM_PRIORITY` è¢«å®šä¹‰ä¸º 5ã€‚

æ¯å½“çº¿ç¨‹è°ƒåº¦å™¨æœ‰æœºä¼šé€‰æ‹©æ–°çº¿ç¨‹æ—¶ï¼Œå®ƒé¦–å…ˆé€‰æ‹©å…·æœ‰è¾ƒé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ã€‚ä½†æ˜¯ï¼Œçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯é«˜åº¦ä¾èµ–äºç³»ç»Ÿçš„ã€‚å½“è™šæ‹Ÿæœºä¾èµ–äºå®¿ä¸»å¹³å°çš„çº¿ç¨‹å®ç°æœºåˆ¶æ—¶ï¼ŒJava çº¿ç¨‹çš„ä¼˜å…ˆçº§è¢«æ˜ å°„åˆ°å®¿ä¸»æœºå¹³å°çš„ä¼˜å…ˆçº§ä¸Šï¼Œä¼˜å…ˆçº§ä¸ªæ•°ä¹Ÿè®¸æ›´å¤šï¼Œä¹Ÿè®¸æ›´å°‘ã€‚

æ³¨æ„âš ï¸ï¼šç»å¯¹ä¸è¦æ„é€ è¿™æ ·çš„ç¨‹åºï¼Œä»¥ä½¿å…¶æ­£å¸¸è¿è¡Œå–å†³äºä¼˜å…ˆçº§ã€‚

è­¦å‘Šâš ï¸ï¼šå¦‚æœæœ‰å‡ ä¸ªé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æ²¡æœ‰è¿›å…¥éæ´»åŠ¨çŠ¶æ€ï¼Œä½ä¼˜å…ˆçº§çš„çº¿ç¨‹å¯èƒ½æ°¸è¿œä¹Ÿä¸èƒ½æ‰§è¡Œã€‚æ¯å½“è°ƒåº¦å™¨å†³å®šè¿è¡Œä¸€ä¸ªæ–°çº¿ç¨‹æ—¶ï¼Œé¦–å…ˆä¼šåœ¨å…·æœ‰é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¸­è¿›è¡Œé€‰æ‹©ï¼Œå³ä½¿è¿™å¯èƒ½ä¼šå®Œå…¨é¥¿æ­»ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹ã€‚

### å®ˆæŠ¤çº¿ç¨‹
å¯ä»¥é€šè¿‡è°ƒç”¨ `t.setDaemon(true)` å°†çº¿ç¨‹è½¬æ¢ä¸ºå®ˆæŠ¤çº¿ç¨‹(daemon thread)ã€‚

å®ˆæŠ¤çº¿ç¨‹çš„å”¯ä¸€ç”¨é€”æ˜¯ä¸ºå…¶ä»–çº¿ç¨‹æä¾›æœåŠ¡ã€‚æ¯”å¦‚è®¡æ—¶çº¿ç¨‹ï¼Œå®ƒå®šæ—¶åœ°å‘é€ä¿¡å·ç»™å…¶ä»–çº¿ç¨‹æˆ–æ¸…ç©ºè¿‡æ—¶çš„é«˜é€Ÿç¼“å­˜é¡¹çš„çº¿ç¨‹ï¼Œå½“åªå‰©ä¸‹å®ˆæŠ¤çº¿ç¨‹æ—¶ï¼Œè™šæ‹Ÿæœºå°±é€€å‡ºäº†ï¼Œå› ä¸ºå¦‚æœåªå‰©ä¸‹å®ˆæŠ¤çº¿ç¨‹ï¼Œå°±æ²¡å¿…è¦ç»§ç»­è¿è¡Œç¨‹åºäº†ã€‚

æ³¨æ„âš ï¸ï¼šå®ˆæŠ¤çº¿ç¨‹æ°¸è¿œä¸è¦è®¿é—®æŒä¹…æ€§èµ„æºï¼Œä¾‹å¦‚æ–‡ä»¶æˆ–æ•°æ®åº“ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨ä»»ä½•æ—¶å€™ç”šè‡³åœ¨ä¸€ä¸ªæ“ä½œçš„ä¸­é—´éšæ—¶ç»ˆæ­¢ã€‚

### æœªæ•è·å¼‚å¸¸å¤„ç†å™¨
çº¿ç¨‹çš„ `run` æ–¹æ³•ä¸èƒ½æŠ›å‡ºä»»ä½•å—æŸ¥å¼‚å¸¸ï¼Œä½†æ˜¯ï¼Œéå—æŸ¥å¼‚å¸¸ä¼šå¯¼è‡´çº¿ç¨‹ç»ˆæ­¢ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹å°±æ­»äº¡äº†ã€‚

ä½†æ˜¯ï¼Œä¸éœ€è¦ä»»ä½• `catch` å­å¥æ¥å¤„ç†å¯ä»¥è¢«ä¼ æ’­çš„å¼‚å¸¸ã€‚ç›¸åï¼Œå°±åœ¨çº¿ç¨‹æ­»äº¡ä¹‹å‰ï¼Œå¼‚å¸¸è¢«ä¼ é€’åˆ°ä¸€ä¸ªç”¨äºæœªæ•è·å¼‚å¸¸çš„å¤„ç†å™¨ã€‚

è¯¥å¤„ç†å™¨å¿…é¡»å±äºä¸€ä¸ªå®ç° `Thread.UncaughtExceptionHandler` æ¥å£çš„ç±»ï¼Œè¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š
```java
void uncaughtException(Thread t, Throwable e);
```
å¯ä»¥ç”¨ `setUncaughtExceptionHanlder` æ–¹æ³•ä¸ºä»»ä½•çº¿ç¨‹å®‰è£…ä¸€ä¸ªå¤„ç†å™¨ï¼Œä¹Ÿå¯ä»¥ç”¨ `Thread` ç±»çš„é™æ€æ–¹æ³• `setDefaultUncaughtExceptionHandler` ä¸ºæ‰€æœ‰çº¿ç¨‹å®‰è£…ä¸€ä¸ªé»˜è®¤çš„å¤„ç†å™¨ã€‚æ›¿æ¢å¤„ç†ç¨‹åºå¯ä»¥ä½¿ç”¨æ—¥å¿—è®°å½• API å°†æœªæ•è·çš„å¼‚å¸¸çš„æŠ¥å‘Šå‘é€åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚

å¦‚æœä¸å®‰è£…é»˜è®¤çš„å¤„ç†å™¨ï¼Œé»˜è®¤çš„å¤„ç†å™¨ä¸º `null`ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸ä¸ºç‹¬ç«‹çš„çº¿ç¨‹å®‰è£…å¤„ç†å™¨ï¼Œæ­¤æ—¶çš„å¤„ç†å™¨å°±æ˜¯è¯¥çº¿ç¨‹çš„ `ThreadGroup` å¯¹è±¡ã€‚

çº¿ç¨‹ç»„(thread group)æ˜¯ä¸€ä¸ªå¯ä»¥ç»Ÿä¸€ç®¡ç†çš„çº¿ç¨‹é›†åˆã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹å±äºåŒä¸€çº¿ç¨‹ç»„ï¼Œä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥å»ºç«‹å…¶ä»–åˆ†ç»„ã€‚ç°åœ¨å¼•å…¥äº†æ›´å¥½çš„ç‰¹æ€§ç”¨äºçº¿ç¨‹é›†åˆçš„æ“ä½œï¼Œæ‰€ä»¥å»ºè®®ä¸è¦åœ¨è‡ªå·±çš„ç¨‹åºä¸­ä½¿ç”¨çº¿ç¨‹ç»„ã€‚

`ThreadGroup` ç±»å®ç° `Thread.UncaughtExceptionHandler` æ¥å£ï¼Œå®ƒçš„ `uncaughtException` æ–¹æ³•åšå¦‚ä¸‹æ“ä½œï¼š

1) å¦‚æœè¯¥çº¿ç¨‹æœ‰çˆ¶çº¿ç¨‹ï¼Œé‚£ä¹ˆçˆ¶çº¿ç¨‹ç»„çš„ `uncaughtException` æ–¹æ³•è¢«è°ƒç”¨ã€‚

2) å¦åˆ™ï¼Œå¦‚æœ `Thread.getDefaultExceptionHandler` æ–¹æ³•è¿”å›ä¸€ä¸ªéç©ºçš„å¤„ç†å™¨ï¼Œåˆ™è°ƒç”¨è¯¥å¤„ç†å™¨ã€‚

3) å¦åˆ™ï¼Œå¦‚æœ `Throwable` æ˜¯ `ThreadDeath` çš„ä¸€ä¸ªå®ä¾‹ï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚

4) å¦åˆ™ï¼Œçº¿ç¨‹çš„åå­—ä»¥åŠ `Throwable` çš„æ ˆè½¨è¿¹è¢«è¾“å‡ºåˆ° `System.err` ä¸Šã€‚


## åŒæ­¥
åœ¨å¤šçº¿ç¨‹åº”ç”¨ä¸­ï¼Œä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹éœ€è¦å…±äº«å¯¹åŒä¸€æ•°æ®çš„å­˜å–ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹å­˜å–ç›¸åŒçš„å¯¹è±¡ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½è°ƒç”¨äº†ä¸€ä¸ªä¿®æ”¹è¯¥å¯¹è±¡çŠ¶æ€çš„æ–¹æ³•ï¼Œå°†ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæ ¹æ®å„çº¿ç¨‹è®¿é—®æ•°æ®çš„æ¬¡åºï¼Œå¯èƒ½ä¼šäº§ç”Ÿè®¹è¯¯çš„æ•°æ®ã€‚è¿™æ ·çš„æƒ…å†µé€šå¸¸ç§°ä¸ºç«äº‰æ¡ä»¶(race condition)ã€‚

### ç«äº‰æ¡ä»¶
ä¸ºäº†é¿å…å¤šçº¿ç¨‹å¼•èµ·çš„å¯¹å…±äº«æ•°æ®çš„è®¹è¯¯ï¼Œå¿…é¡»å­¦ä¼šå¦‚ä½•åŒæ­¥å­˜å–ã€‚

### ç«äº‰æ¡ä»¶è¯¦è§£
å‡è®¾ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡ŒæŒ‡ä»¤ï¼š
```java
accounts[to] += amount;
```
é—®é¢˜åœ¨äºè¿™ä¸æ˜¯åŸå­æ“ä½œï¼Œè¯¥æŒ‡ä»¤å¯èƒ½è¢«å¤„ç†å¦‚ä¸‹ï¼š
- 1) å°† `accounts[to]` åŠ è½½åˆ°å¯„å­˜å™¨ã€‚
- 2) å¢åŠ  `amount`ã€‚
- 3) å°†ç»“æœå†™å› `accounts[to]`ã€‚

å‡å®šç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ­¥éª¤ 1 å’Œ 2ï¼Œç„¶åå®ƒè¢«å‰¥å¤ºäº†è¿è¡Œæƒã€‚å‡å®šç¬¬äºŒä¸ªçº¿ç¨‹è¢«å”¤é†’å¹¶ä¿®æ”¹äº† `accounts` æ•°ç»„ä¸­çš„åŒä¸€é¡¹ã€‚ç„¶åï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’å¹¶å®Œæˆå…¶ç¬¬ 3 æ­¥ã€‚

è¿™æ ·ï¼Œè¿™ä¸€åŠ¨ä½œæ“¦å»äº†ç¬¬äºŒä¸ªçº¿ç¨‹æ‰€åšçš„æ›´æ–°ã€‚

```
javapæ˜¯ jdk è‡ªå¸¦çš„åè§£æå·¥å…·ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯æ ¹æ® class å­—èŠ‚ç æ–‡ä»¶ï¼Œåè§£æå‡ºå½“å‰ç±»å¯¹åº”çš„ code åŒºï¼ˆæ±‡ç¼–æŒ‡ä»¤ï¼‰ã€æœ¬åœ°å˜é‡è¡¨ã€å¼‚å¸¸è¡¨å’Œä»£ç è¡Œåç§»é‡æ˜ å°„è¡¨ã€å¸¸é‡æ± ç­‰ç­‰ä¿¡æ¯ã€‚

æŸ¥çœ‹æ‰§è¡Œç±»ä¸­çš„æ¯ä¸€ä¸ªè¯­å¥çš„è™šæ‹Ÿæœºå­—èŠ‚ç ï¼Œè¿è¡Œå‘½ä»¤ï¼š
javap -c -v Bank
--------------------------------------------------------------------------------
Classfile Bank.class
  Last modified Mar 28, 2020; size 1439 bytes
  MD5 checksum fb066f73ca84623fa463a4cf36c71355
  Compiled from "UnsynchBankTest.java"
class Bank
  minor version: 0
  major version: 52
  flags: ACC_SUPER
Constant pool:
   #1 = Methodref          #8.#44         // java/lang/Object."<init>":()V
   #2 = Fieldref           #14.#45        // Bank.accounts:[D
   #3 = Methodref          #46.#47        // java/util/Arrays.fill:([DD)V
   #4 = Fieldref           #48.#49        // java/lang/System.out:Ljava/io/PrintStream;
   #5 = Methodref          #50.#51        // java/lang/Thread.currentThread:()Ljava/lang/Thread;
   #6 = Methodref          #52.#53        // java/io/PrintStream.print:(Ljava/lang/Object;)V
   #7 = String             #54            // %10.2f from %d to %d
   #8 = Class              #55            // java/lang/Object
   #9 = Methodref          #56.#57        // java/lang/Double.valueOf:(D)Ljava/lang/Double;
  #10 = Methodref          #58.#59        // java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
  #11 = Methodref          #52.#60        // java/io/PrintStream.printf:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/io/PrintStream;
  #12 = String             #61            //  Total Balance: %10.2f%n
  #13 = Methodref          #14.#62        // Bank.getTotalBalance:()D
  #14 = Class              #63            // Bank
  #15 = Utf8               accounts
  #16 = Utf8               [D
  #17 = Utf8               <init>
  #18 = Utf8               (ID)V
  #19 = Utf8               Code
  #20 = Utf8               LineNumberTable
  #21 = Utf8               LocalVariableTable
  #22 = Utf8               this
  #23 = Utf8               LBank;
  #24 = Utf8               n
  #25 = Utf8               I
  #26 = Utf8               initialBalance
  #27 = Utf8               D
  #28 = Utf8               transfer
  #29 = Utf8               (IID)V
  #30 = Utf8               from
  #31 = Utf8               to
  #32 = Utf8               amount
  #33 = Utf8               StackMapTable
  #34 = Utf8               getTotalBalance
  #35 = Utf8               ()D
  #36 = Utf8               a
  #37 = Utf8               sum
  #38 = Class              #63            // Bank
  #39 = Class              #16            // "[D"
  #40 = Utf8               size
  #41 = Utf8               ()I
  #42 = Utf8               SourceFile
  #43 = Utf8               UnsynchBankTest.java
  #44 = NameAndType        #17:#64        // "<init>":()V
  #45 = NameAndType        #15:#16        // accounts:[D
  #46 = Class              #65            // java/util/Arrays
  #47 = NameAndType        #66:#67        // fill:([DD)V
  #48 = Class              #68            // java/lang/System
  #49 = NameAndType        #69:#70        // out:Ljava/io/PrintStream;
  #50 = Class              #71            // java/lang/Thread
  #51 = NameAndType        #72:#73        // currentThread:()Ljava/lang/Thread;
  #52 = Class              #74            // java/io/PrintStream
  #53 = NameAndType        #75:#76        // print:(Ljava/lang/Object;)V
  #54 = Utf8               %10.2f from %d to %d
  #55 = Utf8               java/lang/Object
  #56 = Class              #77            // java/lang/Double
  #57 = NameAndType        #78:#79        // valueOf:(D)Ljava/lang/Double;
  #58 = Class              #80            // java/lang/Integer
  #59 = NameAndType        #78:#81        // valueOf:(I)Ljava/lang/Integer;
  #60 = NameAndType        #82:#83        // printf:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/io/PrintStream;
  #61 = Utf8                Total Balance: %10.2f%n
  #62 = NameAndType        #34:#35        // getTotalBalance:()D
  #63 = Utf8               Bank
  #64 = Utf8               ()V
  #65 = Utf8               java/util/Arrays
  #66 = Utf8               fill
  #67 = Utf8               ([DD)V
  #68 = Utf8               java/lang/System
  #69 = Utf8               out
  #70 = Utf8               Ljava/io/PrintStream;
  #71 = Utf8               java/lang/Thread
  #72 = Utf8               currentThread
  #73 = Utf8               ()Ljava/lang/Thread;
  #74 = Utf8               java/io/PrintStream
  #75 = Utf8               print
  #76 = Utf8               (Ljava/lang/Object;)V
  #77 = Utf8               java/lang/Double
  #78 = Utf8               valueOf
  #79 = Utf8               (D)Ljava/lang/Double;
  #80 = Utf8               java/lang/Integer
  #81 = Utf8               (I)Ljava/lang/Integer;
  #82 = Utf8               printf
  #83 = Utf8               (Ljava/lang/String;[Ljava/lang/Object;)Ljava/io/PrintStream;
{
  public Bank(int, double);
    descriptor: (ID)V
    flags: ACC_PUBLIC
    Code:
      stack=3, locals=4, args_size=3
         0: aload_0  //ä»æœ¬åœ°å˜é‡è¡¨ä¸­åŠ è½½ç´¢å¼•ä¸º0çš„å˜é‡çš„å€¼ï¼Œä¹Ÿå³ this çš„å¼•ç”¨ï¼Œå‹å…¥æ ˆ
         1: invokespecial #1  //å‡ºæ ˆï¼Œè°ƒç”¨java/lang/Object."<init>":()V åˆå§‹åŒ–å¯¹è±¡ï¼Œå°±æ˜¯thisæŒ‡å®šçš„å¯¹è±¡çš„init()æ–¹æ³•å®Œæˆåˆå§‹åŒ–
         4: aload_0
         5: iload_1
         6: newarray       double
         8: putfield      #2                  // Field accounts:[D
        11: aload_0
        12: getfield      #2                  // Field accounts:[D
        15: dload_2
        16: invokestatic  #3                  // Method java/util/Arrays.fill:([DD)V
        19: return
      LineNumberTable:
        line 46: 0
        line 47: 4
        line 48: 11
        line 49: 19
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      20     0  this   LBank;
            0      20     1     n   I
            0      20     2 initialBalance   D

  public void transfer(int, int, double);
    descriptor: (IID)V
    flags: ACC_PUBLIC
    Code:
      stack=7, locals=5, args_size=4
         0: aload_0
         1: getfield      #2                  // Field accounts:[D
         4: iload_1
         5: daload
         6: dload_3
         7: dcmpg
         8: ifge          12
        11: return
        12: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;
        15: invokestatic  #5                  // Method java/lang/Thread.currentThread:()Ljava/lang/Thread;
        18: invokevirtual #6                  // Method java/io/PrintStream.print:(Ljava/lang/Object;)V
        21: aload_0
        22: getfield      #2                  // Field accounts:[D
        25: iload_1
        26: dup2
        27: daload
        28: dload_3
        29: dsub
        30: dastore
        31: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;
        34: ldc           #7                  // String %10.2f from %d to %d
        36: iconst_3
        37: anewarray     #8                  // class java/lang/Object
        40: dup
        41: iconst_0
        42: dload_3
        43: invokestatic  #9                  // Method java/lang/Double.valueOf:(D)Ljava/lang/Double;
        46: aastore
        47: dup
        48: iconst_1
        49: iload_1
        50: invokestatic  #10                 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
        53: aastore
        54: dup
        55: iconst_2
        56: iload_2
        57: invokestatic  #10                 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
        60: aastore
        61: invokevirtual #11                 // Method java/io/PrintStream.printf:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/io/PrintStream;
        64: pop
        65: aload_0
        66: getfield      #2                  // Field accounts:[D
        69: iload_2
        70: dup2
        71: daload
        72: dload_3
        73: dadd
        74: dastore
        75: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;
        78: ldc           #12                 // String  Total Balance: %10.2f%n
        80: iconst_1
        81: anewarray     #8                  // class java/lang/Object
        84: dup
        85: iconst_0
        86: aload_0
        87: invokevirtual #13                 // Method getTotalBalance:()D
        90: invokestatic  #9                  // Method java/lang/Double.valueOf:(D)Ljava/lang/Double;
        93: aastore
        94: invokevirtual #11                 // Method java/io/PrintStream.printf:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/io/PrintStream;
        97: pop
        98: return
      LineNumberTable:
        line 52: 0
        line 53: 11
        line 55: 12
        line 56: 21
        line 57: 31
        line 58: 65
        line 59: 75
        line 60: 98
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      99     0  this   LBank;
            0      99     1  from   I
            0      99     2    to   I
            0      99     3 amount   D
      StackMapTable: number_of_entries = 1
        frame_type = 12 /* same */

  public double getTotalBalance();
    descriptor: ()D
    flags: ACC_PUBLIC
    Code:
      stack=4, locals=8, args_size=1
         0: dconst_0
         1: dstore_1
         2: aload_0
         3: getfield      #2                  // Field accounts:[D
         6: astore_3
         7: aload_3
         8: arraylength
         9: istore        4
        11: iconst_0
        12: istore        5
        14: iload         5
        16: iload         4
        18: if_icmpge     38
        21: aload_3
        22: iload         5
        24: daload
        25: dstore        6
        27: dload_1
        28: dload         6
        30: dadd
        31: dstore_1
        32: iinc          5, 1
        35: goto          14
        38: dload_1
        39: dreturn
      LineNumberTable:
        line 63: 0
        line 64: 2
        line 65: 27
        line 64: 32
        line 67: 38
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
           27       5     6     a   D
            0      40     0  this   LBank;
            2      38     1   sum   D
      StackMapTable: number_of_entries = 2
        frame_type = 255 /* full_frame */
          offset_delta = 14
          locals = [ class Bank, double, class "[D", int, int ]
          stack = []
        frame_type = 248 /* chop */
          offset_delta = 23

  public int size();
    descriptor: ()I
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: getfield      #2                  // Field accounts:[D
         4: arraylength
         5: ireturn
      LineNumberTable:
        line 71: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       6     0  this   LBank;
}
SourceFile: "UnsynchBankTest.java"
```
æ³¨æ„ğŸŒ¿ï¼šä»£ç è¡Œ `accounts[to] += amount;` å¢å€¼å‘½ä»¤æ˜¯ç”±å‡ æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œæ‰§è¡Œå®ƒä»¬çš„çº¿ç¨‹å¯ä»¥åœ¨ä»»ä½•ä¸€æ¡æŒ‡ä»¤ç‚¹ä¸Šè¢«ä¸­æ–­ã€‚

çœŸæ­£çš„é—®é¢˜æ˜¯ `transfer` æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½è¢«ä¸­æ–­ã€‚å¦‚æœèƒ½å¤Ÿç¡®ä¿çº¿ç¨‹åœ¨å¤±å»æ§åˆ¶ä¹‹å‰æ–¹æ³•è¿è¡Œå®Œæˆï¼Œé‚£ä¹ˆå°±ä¸ä¼šå‡ºç°æ•°æ®è®¹è¯¯ã€‚

### é”å¯¹è±¡
æœ‰ä¸¤ç§æœºåˆ¶é˜²æ­¢ä»£ç å—å—å¹¶å‘è®¿é—®çš„å¹²æ‰°ï¼ŒJava è¯­è¨€ä¸ºæ­¤æä¾›ä¸€ä¸ª `synchronized` å…³é”®å­—è¾¾åˆ°è¿™ä¸€ç›®çš„ï¼Œè€Œåœ¨ Java SE 5.0 å¼•å…¥äº† `ReentrantLock` ç±»ã€‚

synchronized ç¾[ËˆsÉªÅ‹krÉ™naÉªzd] v.(ä½¿) åŒæ­¥ï¼Œåœ¨æ—¶é—´ä¸Šä¸€è‡´ï¼ŒåŒé€Ÿè¿›è¡Œ;
synchronizeçš„è¿‡å»åˆ†è¯å’Œè¿‡å»å¼;

reentrant ç¾[ËŒriËˆÉ›ntrÉ™nt] adj.å¯é‡å…¥; å¯é‡å…¥çš„; é‡å…¥; å¯å†å…¥çš„; é‡è¿›å…¥;

`synchronized` å…³é”®å­—è‡ªåŠ¨æä¾›ä¸€ä¸ªé”ä»¥åŠç›¸å…³çš„æ¡ä»¶ï¼Œå¯¹äºå¤§å¤šæ•°éœ€è¦æ˜¾å¼é”çš„æƒ…å†µï¼Œè¿™æ˜¯å¾ˆä¾¿åˆ©çš„ã€‚`java.util.concurrent` æ¡†æ¶ä¸ºè¿™äº›åŸºç¡€æœºåˆ¶æä¾›ç‹¬ç«‹çš„ç±»ã€‚

ä½¿ç”¨ `ReentrantLock` ä¿æŠ¤ä»£ç å—çš„åŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š
```java
myLock.lock(); // a ReentrantLock object
try {
    // critical section
}
finally {
    myLock.unlock(); // make sure the lock is unlocked even if an exception is thrown
}
```
è¿™ä¸€ç»“æ„ç¡®ä¿ä»»ä½•æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œä¸€æ—¦ä¸€ä¸ªçº¿ç¨‹å°é”äº†é”å¯¹è±¡ï¼Œå…¶ä»–ä»»ä½•çº¿ç¨‹éƒ½æ— æ³•é€šè¿‡ `lock` è¯­å¥ã€‚å½“å…¶ä»–çº¿ç¨‹è°ƒç”¨ `lock` æ—¶ï¼Œå®ƒä»¬è¢«é˜»å¡ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾é”å¯¹è±¡ã€‚

è­¦å‘Šï¼šæŠŠè§£é”æ“ä½œæ”¾åœ¨ `finally` å­å¥ä¹‹ä¸­æ˜¯è‡³å…³é‡è¦çš„ï¼Œå¦‚æœåœ¨ä¸´ç•ŒåŒºçš„ä»£ç æŠ›å‡ºå¼‚å¸¸ï¼Œé”å¿…é¡»è¢«é‡Šæ”¾ï¼Œå¦åˆ™ï¼Œå…¶ä»–çº¿ç¨‹å°†æ°¸è¿œé˜»å¡ã€‚

å¦‚æœä½¿ç”¨é”ï¼Œå°±ä¸èƒ½ä½¿ç”¨å¸¦èµ„æºçš„ `try` è¯­å¥ã€‚é¦–å…ˆï¼Œè§£é”æ–¹æ³•åä¸æ˜¯ `close`ï¼Œä¸è¿‡ï¼Œå³ä½¿å°†å®ƒé‡å‘½åï¼Œå¸¦èµ„æºçš„ `try` è¯­å¥ä¹Ÿæ— æ³•æ­£å¸¸å·¥ä½œã€‚å®ƒçš„é¦–éƒ¨å¸Œæœ›å£°æ˜ä¸€ä¸ªæ–°å˜é‡ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨çš„æ˜¯ä¸€ä¸ªé”ï¼Œé‚£ä¹ˆä¼šæ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„é‚£ä¸ªå˜é‡ã€‚

å‡å®šä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `transfer`ï¼Œåœ¨æ‰§è¡Œç»“æŸå‰è¢«å‰¥å¤ºäº†è¿è¡Œæƒã€‚å‡è®¾ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿè°ƒç”¨ `transfer`ï¼Œç”±äºç¬¬äºŒä¸ªçº¿ç¨‹ä¸èƒ½è·å¾—é”ï¼Œå°†åœ¨è°ƒç”¨ `lock` æ–¹æ³•æ—¶è¢«é˜»å¡ã€‚å®ƒå¿…é¡»ç­‰å¾…ç¬¬ä¸€ä¸ªçº¿ç¨‹å®Œæˆ `transfer` æ–¹æ³•çš„æ‰§è¡Œä¹‹åæ‰èƒ½å†åº¦è¢«æ¿€æ´»ã€‚å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªçº¿ç¨‹æ‰èƒ½å¼€å§‹è¿è¡Œã€‚

æ³¨æ„æ¯ä¸€ä¸ª `Bank` å¯¹è±¡æœ‰è‡ªå·±çš„ `ReentrantLock` å¯¹è±¡ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹è§†å›¾è®¿é—®åŒä¸€ä¸ª `Bank` å¯¹è±¡ï¼Œé‚£ä¹ˆé”ä»¥ä¸²è¡Œæ–¹å¼æä¾›æœåŠ¡ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„ `Bank` å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹å¾—åˆ°ä¸åŒçš„é”å¯¹è±¡ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½ä¸ä¼šå‘ç”Ÿé˜»å¡ã€‚å› ä¸ºçº¿ç¨‹åœ¨æ“çºµä¸åŒçš„ `Bank` å®ä¾‹æ—¶ï¼Œçº¿ç¨‹ä¹‹é—´ä¸ä¼šç›¸äº’å½±å“ã€‚

é”æ˜¯å¯é‡å…¥çš„ï¼Œå› ä¸ºçº¿ç¨‹å¯ä»¥é‡å¤åœ°è·å¾—å·²ç»æŒæœ‰çš„é”ã€‚é”ä¿æŒä¸€ä¸ªæŒæœ‰è®¡æ•°(hold count)æ¥è·Ÿè¸ªå¯¹ `lock` æ–¹æ³•çš„åµŒå¥—è°ƒç”¨ã€‚çº¿ç¨‹åœ¨æ¯ä¸€æ¬¡è°ƒç”¨ `lock` éƒ½è¦è°ƒç”¨ `unlock` æ¥é‡Šæ”¾é”ã€‚ç”±äºè¿™ä¸€ç‰¹æ€§ï¼Œè¢«ä¸€ä¸ªé”ä¿æŠ¤çš„ä»£ç å¯ä»¥è°ƒç”¨å¦ä¸€ä¸ªä½¿ç”¨ç›¸åŒçš„é”çš„æ–¹æ³•ã€‚

`transfer` æ–¹æ³•è°ƒç”¨ `getTotalBalance` æ–¹æ³•ï¼Œè¿™ä¹Ÿä¼šå°é” `bankLock` å¯¹è±¡ï¼Œæ­¤æ—¶ `bankLock` å¯¹è±¡çš„æŒæœ‰è®¡æ•°ä¸º 2ã€‚å½“ `getTotalBalance` æ–¹æ³•é€€å‡ºçš„æ—¶å€™ï¼ŒæŒæœ‰è®¡æ•°å˜å› 1ã€‚å½“ `transfer` æ–¹æ³•é€€å‡ºçš„æ—¶å€™ï¼ŒæŒæœ‰è®¡æ•°å˜ä¸º 0ã€‚çº¿ç¨‹é‡Šæ”¾é”ã€‚

é€šå¸¸ï¼Œä¿æŠ¤éœ€è¦è‹¥ä¸ªæ“ä½œæ¥æ›´æ–°æˆ–æ£€æŸ¥å…±äº«å¯¹è±¡çš„ä»£ç å—ï¼Œè¦ç¡®ä¿è¿™äº›æ“ä½œå®Œæˆåï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ‰èƒ½ä½¿ç”¨ç›¸åŒå¯¹è±¡ã€‚

æ³¨æ„âš ï¸ï¼šè¦ç•™å¿ƒä¸´ç•ŒåŒºçš„ä»£ç ï¼Œä¸è¦å› ä¸ºå¼‚å¸¸çš„æŠ›å‡ºè€Œè·³å‡ºä¸´ç•ŒåŒºã€‚å¦‚æœåœ¨ä¸´ç•ŒåŒºä»£ç ç»“æŸä¹‹å‰æŠ›å‡ºäº†å¼‚å¸¸ï¼Œ`finally` å­å¥å°†é‡Šæ”¾é”ï¼Œä½†ä¼šä½¿å¯¹è±¡å¯èƒ½å¤„äºä¸€ç§å—æŸçŠ¶æ€ã€‚

ä½¿ç”¨ `ReentrantLock(boolean fair)` æ„å»ºä¸€ä¸ªå¸¦æœ‰å…¬å¹³ç­–ç•¥çš„é”ã€‚ä¸€ä¸ªå…¬å¹³é”åçˆ±ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ï¼Œä½†æ˜¯ï¼Œè¿™ä¸€å…¬å¹³çš„ä¿è¯å°†å¤§å¤§é™ä½æ€§èƒ½ã€‚æ‰€ä»¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé”æ²¡æœ‰è¢«å¼ºåˆ¶ä¸ºå…¬å¹³çš„ã€‚

è­¦å‘ŠğŸ“ï¼šå…¬å¹³é”æ¯”ä½¿ç”¨å¸¸è§„é”è¦æ…¢å¾—å¤šã€‚åªæœ‰å½“ä½ ç¡®å®äº†è§£è‡ªå·±è¦åšä»€ä¹ˆå¹¶ä¸”å¯¹äºä½ è¦è§£å†³çš„é—®é¢˜æœ‰ä¸€ä¸ªç‰¹å®šçš„ç†ç”±å¿…é¡»ä½¿ç”¨å…¬å¹³é”çš„æ—¶å€™æ‰ä½¿ç”¨å…¬å¹³é”ã€‚å³ä½¿ä½¿ç”¨å…¬å¹³é”ï¼Œä¹Ÿæ— æ³•ç¡®ä¿çº¿ç¨‹è°ƒåº¦å™¨æ˜¯å…¬å¹³çš„ã€‚å¦‚æœçº¿ç¨‹è°ƒåº¦å™¨é€‰æ‹©å¿½ç•¥ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œè¯¥çº¿ç¨‹ä¸ºäº†è¿™ä¸ªé”å·²ç»ç­‰å¾…äº†å¾ˆé•¿æ—¶é—´ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰æœºä¼šå…¬å¹³åœ°å¤„ç†è¿™ä¸ªé”ã€‚

### æ¡ä»¶å¯¹è±¡ Condition Objects
é€šå¸¸ï¼Œçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œå´å‘ç°åœ¨æŸä¸€æ¡ä»¶æ»¡è¶³ä¹‹åå®ƒæ‰èƒ½æ‰§è¡Œã€‚è¦ä½¿ç”¨ä¸€ä¸ªæ¡ä»¶å¯¹è±¡æ¥ç®¡ç†é‚£äº›å·²ç»è·å¾—äº†ä¸€ä¸ªé”ä½†æ˜¯å´ä¸èƒ½åšæœ‰ç”¨å·¥ä½œçš„çº¿ç¨‹ã€‚

æ¡ä»¶å¯¹è±¡ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¡ä»¶å˜é‡(condtion variables)ã€‚

é¿å…é€‰æ‹©æ²¡æœ‰è¶³å¤Ÿèµ„é‡‘çš„è´¦æˆ·ä½œä¸ºè½¬å‡ºè´¦æˆ·ï¼Œæ³¨æ„ä¸èƒ½ä½¿ç”¨ä¸‹é¢çš„ä»£ç âŒï¼š
```java
if (bank.getBalance(from) >= amount) {
    // thread might be deactivated at this point
    bank.transfer(from, to, amount);
}
```
å½“å‰çº¿ç¨‹å®Œå…¨æœ‰å¯èƒ½åœ¨æˆåŠŸåœ°å®Œæˆæµ‹è¯•ï¼Œä¸”åœ¨è°ƒç”¨ `transfer` æ–¹æ³•ä¹‹å‰å°†è¢«ä¸­æ–­ã€‚åœ¨çº¿ç¨‹å†æ¬¡è¿è¡Œå‰ï¼Œè´¦æˆ·ä½™é¢å¯èƒ½å·²ç»ä½äºææ¬¾é‡‘é¢ã€‚å¿…é¡»ç¡®ä¿æ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨æœ¬æ£€æŸ¥ä½™é¢ä¸è½¬è´¦æ´»åŠ¨ä¹‹é—´ä¿®æ”¹ä½™é¢ã€‚é€šè¿‡ä½¿ç”¨é”æ¥ä¿æŠ¤æ£€æŸ¥ä¸è½¬è´¦åŠ¨ä½œï¼š
```java
public void transfer(int from, int to, int amount) {
    bankLock.lock();
    try {
        while (accounts[from] < amount) {
            // wait
            // ...
        }
        // transfer funds
        // ...
    } finally {
        bankLock.unlock();
    }
}
```
ç°åœ¨ï¼Œå½“è´¦æˆ·æ²¡æœ‰è¶³å¤Ÿçš„é‡‘é¢æ—¶ï¼Œç­‰å¾…ç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹å‘è´¦æˆ·ä¸­æ³¨å…¥èµ„é‡‘ã€‚ä½†æ˜¯ï¼Œè¿™ä¸€çº¿ç¨‹åˆšåˆšè·å¾—äº†å¯¹ `bankLock` çš„æ’ä»–æ€§è®¿é—®ï¼Œå› æ­¤åˆ«çš„çº¿ç¨‹æ²¡æœ‰è¿›è¡Œå­˜æ¬¾æ“ä½œçš„æœºä¼šã€‚

ä¸€ä¸ªé”å¯¹è±¡å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªç›¸å…³çš„æ¡ä»¶å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨ `newCondtion` æ–¹æ³•è·å¾—ä¸€ä¸ªæ¡ä»¶å¯¹è±¡ã€‚ä¹ æƒ¯ä¸Šç»™æ¯ä¸€ä¸ªæ¡ä»¶å¯¹è±¡å‘½åä¸ºå¯ä»¥åæ˜ å‡ºå®ƒæ‰€è¡¨è¾¾çš„æ¡ä»¶çš„åå­—ã€‚
```java
class Bank {
    private Condtion sufficientFunds; // ä½™é¢å……è¶³æ¡ä»¶
    // ...
    public Bank() {
        // ...
        sufficientFunds = bankLock.newCondtion();
    }
}
```
å¦‚æœ `transfer` æ–¹æ³•å‘ç°ä½™é¢ä¸è¶³æ—¶ï¼Œè°ƒç”¨ `sufficientFunds.await();`ï¼Œå½“å‰çº¿ç¨‹ç°åœ¨è¢«é˜»å¡äº†ï¼Œå¹¶æ”¾å¼ƒäº†é”ã€‚è¿™æ ·å¯ä»¥ä½¿å¾—å¦ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›è¡Œå¢åŠ è´¦æˆ·ä½™é¢çš„æ“ä½œã€‚

ç­‰å¾…è·å¾—é”çš„çº¿ç¨‹å’Œè°ƒç”¨ `await` æ–¹æ³•çš„çº¿ç¨‹å­˜åœ¨æœ¬è´¨ä¸Šçš„ä¸åŒã€‚ä¸€æ—¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `await` æ–¹æ³•ï¼Œå®ƒè¿›å…¥è¯¥æ¡ä»¶çš„ç­‰å¾…é›†ã€‚ç­‰é”å¯ç”¨æ—¶ï¼Œè¯¥çº¿ç¨‹ä¸èƒ½é©¬ä¸Šè§£é™¤é˜»å¡ã€‚ç›¸åï¼Œå®ƒä»ç„¶å¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹åœ¨ç›¸åŒæ¡ä»¶ä¸‹è°ƒç”¨ `signalAll` æ–¹æ³•ä¸ºæ­¢ã€‚

å½“å¦ä¸€ä¸ªçº¿ç¨‹è½¬è´¦æ—¶ï¼Œè°ƒç”¨ `sufficientFunds.signalAll();`ï¼Œè¿™ä¸€è°ƒç”¨é‡æ–°æ¿€æ´»å› ä¸ºè¿™ä¸€æ¡ä»¶è€Œç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ã€‚å½“è¿™äº›çº¿ç¨‹ä»ç­‰å¾…é›†å½“ä¸­ç§»å‡ºæ—¶ï¼Œå®ƒä»¬å†æ¬¡æˆä¸ºå¯è¿è¡Œçš„ï¼Œè°ƒåº¦å™¨å°†å†æ¬¡æ¿€æ´»å®ƒä»¬ã€‚åŒæ—¶ï¼Œå®ƒä»¬å°†è¯•å›¾é‡æ–°è¿›å…¥è¯¥å¯¹è±¡ã€‚ä¸€æ—¦é”æˆä¸ºå¯ç”¨çš„ï¼Œå®ƒä»¬ä¸­çš„æŸä¸ªå°†ä» `await` è°ƒç”¨è¿”å›ï¼Œè·å¾—è¯¥é”å¹¶ä»è¢«é˜»å¡çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œã€‚

æ­¤æ—¶ï¼Œçº¿ç¨‹åº”è¯¥å†æ¬¡æµ‹è¯•è¯¥æ¡ä»¶ã€‚ç”±äºæ— æ³•ç¡®ä¿è¯¥æ¡ä»¶è¢«æ»¡è¶³ï¼Œ`signalAll` æ–¹æ³•ä»…ä»…æ˜¯é€šçŸ¥æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ï¼šæ­¤æ—¶æœ‰å¯èƒ½å·²ç»æ»¡è¶³æ¡ä»¶ï¼Œå€¼å¾—å†æ¬¡å»æ£€æµ‹è¯¥æ¡ä»¶ã€‚

é€šå¸¸ï¼Œå¯¹ `await` çš„è°ƒç”¨åº”è¯¥åœ¨å¦‚ä¸‹å½¢å¼çš„å¾ªç¯ä½“ä¸­ï¼š
```java
while (!(ok to procced)) {
    condtion.await();
}
```

è‡³å…³é‡è¦çš„æ˜¯æœ€ç»ˆéœ€è¦åœ¨æŸä¸ªå…¶ä»–çº¿ç¨‹ä¸­è°ƒç”¨ `signalAll` æ–¹æ³•ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `await` æ—¶ï¼Œå®ƒæ²¡æœ‰åŠæ³•é‡æ–°æ¿€æ´»è‡ªèº«ï¼Œå®ƒå¯„å¸Œæœ›äºå…¶ä»–çº¿ç¨‹ã€‚å¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹æ¥é‡æ–°æ¿€æ´»ç­‰å¾…çš„çº¿ç¨‹ï¼Œå®ƒå°±æ°¸è¿œä¸å†æ‰§è¡Œäº†ï¼Œè¿™å°†å¯¼è‡´æ­»é”(deadlock)ç°è±¡ã€‚å¦‚æœæ‰€æœ‰å…¶ä»–çº¿ç¨‹è¢«é˜»å¡ï¼Œæœ€åä¸€ä¸ªæ´»åŠ¨çº¿ç¨‹åœ¨è§£é™¤å…¶ä»–çº¿ç¨‹çš„é˜»å¡çŠ¶æ€ä¹‹å‰å°±è°ƒç”¨ `await` æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä¹Ÿè¢«é˜»å¡ã€‚æ²¡æœ‰ä»»ä½•çº¿ç¨‹å¯ä»¥è§£é™¤å…¶ä»–çº¿ç¨‹çš„é˜»å¡ï¼Œé‚£ä¹ˆè¯¥ç¨‹åºå°±æŒ‚èµ·äº†ã€‚

åº”è¯¥ä½•æ—¶è°ƒç”¨ `signalAll` å‘¢ï¼Ÿåœ¨å¯¹è±¡çš„çŠ¶æ€æœ‰åˆ©äºç­‰å¾…çº¿ç¨‹çš„æ–¹å‘æ”¹å˜æ—¶è°ƒç”¨ `signalAll`ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªè´¦æˆ·ä½™é¢å‘ç”Ÿæ”¹å˜æ—¶ï¼Œç­‰å¾…çš„çº¿ç¨‹ä¼šåº”è¯¥æœ‰æœºä¼šæ£€æŸ¥ä½™é¢ï¼š
```java
public void transfer(int from, int to, int amount) {
    bankLock.lock();
    try {
        while (accounts[from] < amount) {
            sufficientFunds.await();
        }
        // transfer funds
        // ...
        sufficientFunds.signalAll();
    } finally {
        bankLock.unlock();
    }
}
```
æ³¨æ„è°ƒç”¨ `signalAll` ä¸ä¼šç«‹å³æ¿€æ´»ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚å®ƒä»…ä»…æ˜¯è§£é™¤ç­‰å¾…çº¿ç¨‹çš„é˜»å¡ï¼Œä»¥ä¾¿è¿™äº›çº¿ç¨‹å¯ä»¥åœ¨å½“å‰çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œé€šè¿‡ç«äº‰å®ç°å¯¹å¯¹è±¡çš„è®¿é—®ã€‚

å¦ä¸€ä¸ªæ–¹æ³• `signal`ï¼Œåˆ™æ˜¯éšæœºè§£é™¤`ç­‰å¾…é›†`ä¸­æŸä¸ªçº¿ç¨‹çš„é˜»å¡çŠ¶æ€ã€‚è¿™æ¯”è§£é™¤æ‰€æœ‰çº¿ç¨‹çš„é˜»å¡æ›´åŠ æœ‰æ•ˆï¼Œä½†ä¹Ÿå­˜åœ¨å±é™©ã€‚å¦‚æœéšæœºé€‰æ‹©çš„çº¿ç¨‹å‘ç°è‡ªèº«ä»ç„¶ä¸èƒ½è¿è¡Œï¼Œé‚£ä¹ˆå®ƒå†æ¬¡è¢«é˜»å¡ã€‚å¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹å†æ¬¡è°ƒç”¨ `signal`ï¼Œåˆ™ç³»ç»Ÿæ­»é”ã€‚

è­¦å‘Šï¼šå½“ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰æŸä¸ªæ¡ä»¶çš„é”æ—¶ï¼Œå®ƒä»…ä»…å¯ä»¥åœ¨è¯¥æ¡ä»¶ä¸Šè°ƒç”¨ `await`ã€`signalAll` æˆ– `signal` æ–¹æ³•ã€‚

### synchronized å…³é”®å­—
é” `Lock` å’Œæ¡ä»¶ `Condtion` çš„å…³é”®ä¹‹å¤„ï¼š
- é”ç”¨æ¥ä¿æŠ¤ä»£ç ç‰‡æ®µï¼Œä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¢«ä¿æŠ¤çš„ä»£ç ã€‚
- é”å¯ä»¥ç®¡ç†è¯•å›¾è¿›å…¥è¢«ä¿æŠ¤ä»£ç æ®µçš„çº¿ç¨‹ã€‚
- é”å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªç›¸å…³çš„æ¡ä»¶å¯¹è±¡ã€‚
- æ¯ä¸ªæ¡ä»¶å¯¹è±¡ç®¡ç†é‚£äº›å·²ç»è¿›å…¥è¢«ä¿æŠ¤çš„ä»£ç æ®µä½†è¿˜ä¸èƒ½è¿è¡Œçš„çº¿ç¨‹ã€‚

`Lock` å’Œ `Condition` æ¥å£ä¸ºå¼€å‘è€…æä¾›äº†é«˜åº¦çš„é”å®šæ§åˆ¶ã€‚ç„¶è€Œï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¹¶ä¸éœ€è¦é‚£æ ·çš„æ§åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ä¸€ç§åµŒå…¥åˆ° Java è¯­è¨€å†…éƒ¨çš„æœºåˆ¶ã€‚

ä» 1.0 ç‰ˆæœ¬å¼€å§‹ï¼ŒJava ä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå†…éƒ¨é”ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•ç”¨ `synchronized` å…³é”®å­—å£°æ˜ï¼Œé‚£ä¹ˆå¯¹è±¡çš„é”å°†ä¿æŠ¤æ•´ä¸ªæ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦è°ƒç”¨æ–¹æ³•ï¼Œçº¿ç¨‹å¿…é¡»è·å¾—å†…éƒ¨çš„å¯¹è±¡é”ã€‚
```java
public synchronized void method() {
    // method body
}
// ç­‰ä»·äº
public void method() {
    this.intrinsicLock.lock();
    try {
        // method body
    } finally {
        this.intrinsicLock.unlock();
    }
}

```

intrinsic ç¾ [Éªn'trÉªnsÉªk] adj.å›ºæœ‰çš„ï¼Œå†…åœ¨çš„ï¼Œæœ¬è´¨çš„;

å¯ä»¥ç®€å•åœ°å£°æ˜ `Bank` ç±»çš„ `transfer` æ–¹æ³•ä¸º `synchronized`ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¸€ä¸ªæ˜¾å¼çš„é”ã€‚

å†…éƒ¨å¯¹è±¡é”åªæœ‰ä¸€ä¸ªå…³è”æ¡ä»¶ã€‚`wait` æ–¹æ³•å°†çº¿ç¨‹æ·»åŠ åˆ° `ç­‰å¾…é›†` ä¸­ï¼Œ`notifyAll` æˆ– `notify` æ–¹æ³•è§£é™¤ç­‰å¾…çº¿ç¨‹çš„é˜»å¡çŠ¶æ€ã€‚æ¢è¨€ä¹‹ï¼Œè°ƒç”¨ `wait` æˆ– `notifyAll` ç­‰ä»·äºï¼š
```java
intrinsicCondition.await();
intrinsicCondition.signalAll();
```

æ³¨æ„ï¼š`wait`ã€`notifyAll` ä»¥åŠ `notify` æ–¹æ³•æ˜¯ `Object` ç±»çš„ `final` æ–¹æ³•ã€‚`Condition` æ–¹æ³•å¿…é¡»è¢«å‘½åä¸º `await`ã€`signalAll` å’Œ `signal` ä»¥ä¾¿å®ƒä»¬ä¸ä¼šä¸é‚£äº›æ–¹æ³•å‘ç”Ÿå†²çªã€‚
```java
class Bank {
    //...
    private double[] accounts;
    //...
    public synchronized void transfer(int from, int to, int amount) throws InterruptedException {
        while (accounts[from] < amount) {
            wait(); // wait on intrinsic object lock's single condition
        }
        accounts[from] -= amount;
        accounts[to] += amount;
        notifyAll(); // notify all threads waiting on the condtion
    }
    //...
}
```
ä½¿ç”¨ `synchronized` å…³é”®å­—ç¼–å†™ä»£ç è¦ç®€æ´å¾—å¤šã€‚ç†è§£è¿™æ®µä»£ç ï¼Œéœ€è¦äº†è§£æ¯ä¸€ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå†…éƒ¨é”ï¼Œå¹¶ä¸”è¯¥é”æœ‰ä¸€ä¸ªå†…éƒ¨æ¡ä»¶ã€‚ç”±é”æ¥ç®¡ç†é‚£äº›è¯•å›¾è¿›å…¥ `synchronized` æ–¹æ³•çš„çº¿ç¨‹ï¼Œç”±æ¡ä»¶æ¥ç®¡ç†é‚£äº›è°ƒç”¨ `wait` çš„çº¿ç¨‹ã€‚

å°†é™æ€æ–¹æ³•å£°æ˜ä¸º `synchronized` ä¹Ÿæ˜¯åˆæ³•çš„ã€‚å¦‚æœè°ƒç”¨è¿™ç§æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è·å¾—ç›¸å…³çš„ç±»å¯¹è±¡çš„å†…éƒ¨é”ã€‚å¦‚æœ `Bank` ç±»æœ‰ä¸€ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œé‚£ä¹ˆå½“è¯¥æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œ`Bank.class` å¯¹è±¡çš„é”è¢«é”ä½ï¼Œå› æ­¤ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹å¯ä»¥è°ƒç”¨åŒä¸€ä¸ªç±»çš„è¿™ä¸ªæˆ–ä»»ä½•å…¶ä»–çš„åŒæ­¥é™æ€æ–¹æ³•ã€‚

å†…éƒ¨é”å’Œæ¡ä»¶å­˜åœ¨ä¸€äº›å±€é™ï¼š
- ä¸èƒ½ä¸­æ–­ä¸€ä¸ªæ­£åœ¨è¯•å›¾è·å¾—é”çš„çº¿ç¨‹ã€‚
- è¯•å›¾è·å¾—é”æ—¶ä¸èƒ½è®¾å®šè¶…æ—¶ã€‚
- æ¯ä¸ªé”ä»…æœ‰å•ä¸€çš„æ¡ä»¶ï¼Œå¯èƒ½æ˜¯ä¸å¤Ÿçš„ã€‚

ä½¿ç”¨ `Lock` å’Œ `Condition` å¯¹è±¡è¿˜æ˜¯åŒæ­¥æ–¹æ³•ï¼Ÿ
- æœ€å¥½æ—¢ä¸ä½¿ç”¨ `Lock`/`Condition` ä¹Ÿä¸ä½¿ç”¨ `synchronized` å…³é”®å­—ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ java.util.concurrent åŒ…ä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒä¼šå¤„ç†æ‰€æœ‰çš„åŠ é”ã€‚
- å¦‚æœ `synchronized` å…³é”®å­—é€‚åˆï¼Œé‚£ä¹ˆè¯·å°½é‡ä½¿ç”¨å®ƒï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç¼–å†™çš„ä»£ç æ•°é‡ï¼Œå‡å°‘å‡ºé”™çš„å‡ ç‡ã€‚
- å¦‚æœç‰¹åˆ«éœ€è¦ `Lock`/`Condition` ç»“æ„æä¾›çš„ç‹¬æœ‰ç‰¹æ€§æ—¶ï¼Œæ‰ä½¿ç”¨  `Lock`/`Condition`ã€‚

### åŒæ­¥é˜»å¡
æ¯ä¸€ä¸ª Java å¯¹è±¡æœ‰ä¸€ä¸ªé”ï¼Œçº¿ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨åŒæ­¥æ–¹æ³•è·å¾—é”ï¼Œè¿˜å¯ä»¥é€šè¿‡è¿›å…¥ä¸€ä¸ªåŒæ­¥é˜»å¡(synchronized block)è·å¾—é”ï¼š
```java
synchoronized(obj) { // the syntax for a synchronized block
    // critical section
}
```
äºæ˜¯è·å¾— obj çš„é”ã€‚
```java
public class Bank {
    private double[] accounts;
    private Object lock = new Object();
    // ...
    public void transfer(int from, int to, int amount) {
        synchronized(lock) {
            accounts[from] -= amount;
            accounts[to] += amount;
        }
        // ...
    }
}
```
lock å¯¹è±¡è¢«åˆ›å»ºä»…ä»…æ˜¯ç”¨æ¥ä½¿ç”¨æ¯ä¸ª Java å¯¹è±¡æŒæœ‰çš„é”ã€‚

ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡çš„é”æ¥å®ç°é¢å¤–çš„åŸå­æ“ä½œï¼Œå®é™…ä¸Šç§°ä¸ºå®¢æˆ·ç«¯é”å®š(client-side locking)ã€‚

è€ƒè™‘ `Vector` ç±»ï¼Œä¸€ä¸ªåˆ—è¡¨ï¼Œå®ƒçš„æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼š
```java
public void transfer(int from, int to, int amount) {
    accounts.set(from, accounts.get(from) - amount);
    accounts.set(to, accounts.get(to) + amount);
    // ...
}
```
è™½ç„¶ `Vector` ç±»çš„ `get` å’Œ `set` æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œä½†è¿™å¯¹äºä¸Šè¿°ç¨‹åºæ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ã€‚åœ¨ç¬¬ä¸€æ¬¡ `get` çš„è°ƒç”¨å·²ç»å®Œæˆä¹‹åï¼Œä¸€ä¸ªçº¿ç¨‹å®Œå…¨å¯èƒ½åœ¨ `transfer` æ–¹æ³•ä¸­è¢«å‰¥å¤ºè¿è¡Œæƒã€‚ç„¶åå¦ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å°†ä¸åŒçš„å€¼å­˜å‚¨åˆ°åŒä¸€ä½ç½®ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åŠ«æŒé”ï¼š
```java
public void transfer(int from, int to, int amount) {
    synchronized (accounts) {
        accounts.set(from, accounts.get(from) - amount);
        accounts.set(to, accounts.get(to) + amount);
        // ...
    }
}
```
æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•å¯ä»¥å·¥ä½œï¼Œä½†æ˜¯å®Œå…¨ä¾èµ–äºä¸€ä¸ªäº‹å®ï¼š`Vector` ç±»å¯¹è‡ªå·±çš„æ‰€æœ‰å¯ä¿®æ”¹æ–¹æ³•éƒ½ä½¿ç”¨å†…éƒ¨é”ã€‚æ•…ï¼Œå®¢æˆ·ç«¯é”å®šæ˜¯éå¸¸è„†å¼±çš„ï¼Œä¸æ¨èä½¿ç”¨ã€‚

### ç›‘è§†å™¨æ¦‚å¿µ
ç›‘è§†å™¨å…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š
- ç›‘è§†å™¨æ˜¯åªåŒ…å«ç§æœ‰åŸŸçš„ç±»ã€‚
- æ¯ä¸ªç›‘è§†å™¨ç±»çš„å¯¹è±¡æœ‰ä¸€ä¸ªç›¸å…³çš„é”ã€‚
- ä½¿ç”¨è¯¥é”å¯¹æ‰€æœ‰å¯¹æ–¹æ³•è¿›è¡ŒåŠ é”ã€‚å¦‚æœå®¢æˆ·ç«¯è°ƒç”¨ `obj.method()`ï¼Œé‚£ä¹ˆ obj å¯¹è±¡çš„é”æ˜¯åœ¨æ–¹æ³•è°ƒç”¨å¼€å§‹æ—¶è‡ªåŠ¨è·å¾—ï¼Œå¹¶ä¸”å½“æ–¹æ³•è¿”å›æ—¶è‡ªåŠ¨é‡Šæ”¾è¯¥é”ã€‚å› ä¸ºæ‰€æœ‰çš„åŸŸæ˜¯ç§æœ‰çš„ï¼Œè¿™æ ·çš„å®‰æ’å¯ä»¥ç¡®ä¿ä¸€ä¸ªçº¿ç¨‹åœ¨å¯¹å¯¹è±¡æ“ä½œæ—¶ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹èƒ½è®¿é—®è¯¥åŸŸã€‚
- è¯¥é”å¯ä»¥æœ‰ä»»æ„å¤šä¸ªç›¸å…³æ¡ä»¶ã€‚

Java ä¸­æ¯ä¸€ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå†…éƒ¨çš„é”å’Œå†…éƒ¨çš„æ¡ä»¶ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•ç”¨ `synchronized` å…³é”®å­—å£°æ˜ï¼Œé‚£ä¹ˆï¼Œå®ƒè¡¨ç°å¾—å°±åƒæ˜¯ä¸€ä¸ªç›‘è§†å™¨æ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨ `wait`/`notifyAll`/`notify` æ¥è®¿é—®æ¡ä»¶å˜é‡ã€‚

ç„¶è€Œï¼Œä¸‹è¿°çš„ 3 ä¸ªæ–¹æ³• Java å¯¹è±¡ä¸åŒäºç›‘è§†å™¨ï¼Œä»è€Œä½¿å¾—çº¿ç¨‹çš„å®‰å…¨æ€§ä¸‹é™ï¼š
- åŸŸä¸è¦æ±‚å¿…é¡»æ˜¯ `private`ã€‚
- æ–¹æ³•ä¸è¦æ±‚å¿…é¡»æ˜¯ `synchronized`ã€‚
- å†…éƒ¨é”å¯¹ç”¨æˆ·æ˜¯å¯ç”¨çš„ã€‚

### volatile åŸŸ
volatile ç¾[ËˆvÉ‘ËlÉ™tl] adj.æ˜“å˜çš„; æ— å®šæ€§çš„;

è¯»å†™å®ä¾‹åŸŸï¼Œå‡ºé”™çš„å¯èƒ½æ€§å¾ˆå¤§ï¼š
- å¤šå¤„ç†å™¨çš„è®¡ç®—æœºèƒ½å¤Ÿæš‚æ—¶åœ¨å¯„å­˜å™¨æˆ–æœ¬åœ°å†…å­˜ç¼“å†²åŒºä¸­ä¿å­˜å†…å­˜ä¸­çš„å€¼ï¼Œç»“æœæ˜¯ï¼Œè¿è¡Œåœ¨ä¸åŒå¤„ç†å™¨ä¸Šçš„çº¿ç¨‹å¯èƒ½åœ¨åŒä¸€ä¸ªå†…å­˜ä½ç½®å–åˆ°ä¸åŒçš„å€¼ã€‚
- ç¼–è¯‘å™¨å¯ä»¥æ”¹å˜æŒ‡ä»¤æ‰§è¡Œçš„é¡ºåºä»¥ä½¿ååé‡æœ€å¤§åŒ–ï¼Œè¿™ç§é¡ºåºä¸Šçš„å˜åŒ–ä¸ä¼šæ”¹å˜ä»£ç è¯­ä¹‰ï¼Œä½†æ˜¯ç¼–è¯‘å™¨å‡å®šå†…å­˜çš„å€¼ä»…ä»…åœ¨ä»£ç ä¸­æœ‰æ˜¾å¼çš„ä¿®æ”¹æŒ‡ä»¤æ—¶æ‰ä¼šæ”¹å˜ã€‚ç„¶è€Œï¼Œå†…å­˜çš„å€¼å¯ä»¥è¢«å¦ä¸€ä¸ªçº¿ç¨‹æ”¹å˜ã€‚

å¦‚æœä½¿ç”¨é”æ¥ä¿æŠ¤è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®çš„ä»£ç ï¼Œé‚£ä¹ˆå¯ä»¥ä¸ç”¨è€ƒè™‘è¿™ç§é—®é¢˜ï¼Œç¼–è¯‘å™¨è¢«è¦æ±‚é€šè¿‡åœ¨å¿…è¦çš„æ—¶å€™åˆ·æ–°æœ¬åœ°ç¼“å­˜æ¥ä¿æŒé”çš„æ•ˆåº”ï¼Œå¹¶ä¸”ä¸èƒ½ä¸æ­£å½“åœ°é‡æ–°æ’åºæŒ‡ä»¤ã€‚

åŒæ­¥æ ¼è¨€ï¼šå¦‚æœå‘ä¸€ä¸ªå˜é‡å†™å…¥å€¼ï¼Œè€Œè¿™ä¸ªå˜é‡æ¥ä¸‹æ¥å¯èƒ½ä¼šè¢«å¦ä¸€ä¸ªçº¿ç¨‹è¯»å–ï¼Œæˆ–è€…ï¼Œä»ä¸€ä¸ªå˜é‡è¯»å€¼ï¼Œè€Œè¿™ä¸ªå˜é‡å¯èƒ½æ˜¯ä¹‹å‰è¢«å¦ä¸€ä¸ªå†™å…¥çš„ï¼Œæ­¤æ—¶å¿…é¡»ä½¿ç”¨åŒæ­¥ã€‚

`volatile` å…³é”®å­—ä¸ºå®ä¾‹åŸŸçš„åŒæ­¥è®¿é—®æä¾›äº†ä¸€ç§å…é”æœºåˆ¶ã€‚å¦‚æœå£°æ˜ä¸€ä¸ªåŸŸä¸º `volatile`ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å’Œè™šæ‹Ÿæœºå°±çŸ¥é“è¯¥åŸŸæ˜¯å¯èƒ½è¢«å¦ä¸€ä¸ªçº¿ç¨‹å¹¶å‘æ›´æ–°çš„ã€‚

å‡å®šä¸€ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå¸ƒå°”æ ‡è®° `done`ï¼Œå®ƒçš„å€¼è¢«ä¸€ä¸ªçº¿ç¨‹è®¾ç½®å´è¢«å¦ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢ï¼š
```java
private boolean done;
public synchronized boolean isDone() { return done; }
public synchronized void setDone() { done = true; }
```
å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹å·²ç»å¯¹è¯¥å¯¹è±¡åŠ é”ï¼Œ`isDone` å’Œ `setDone` æ–¹æ³•å¯èƒ½é˜»å¡ã€‚æˆ–è€…ï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ªçº¿ç¨‹ä¸ºè¿™ä¸€å˜é‡ä½¿ç”¨ç‹¬ç«‹çš„ `Lock`ï¼Œä½†æ˜¯è¿™æ ·å¼€é”€è¿‡å¤§äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†åŸŸå£°æ˜ä¸º `volatile` æ˜¯åˆç†çš„ï¼š
```java
private volatile boolean done;
public boolean isDone() { return done; }
public void setDone() { done = true; }
```

æ³¨æ„âš ï¸ï¼š`volatile` å˜é‡ä¸èƒ½æä¾›åŸå­æ€§ï¼š
```java
public void flipDone() { done = !done; } // not atomic
```
ä¸èƒ½ç¡®ä¿ç¿»è½¬åŸŸä¸­çš„å€¼ï¼Œä¸èƒ½ä¿è¯è¯»å–ã€ç¿»è½¬å’Œå†™å…¥ä¸è¢«ä¸­æ–­ã€‚

### final å˜é‡
é™¤éä½¿ç”¨é”æˆ– `volatile` ä¿®é¥°ç¬¦ï¼Œå¦åˆ™æ— æ³•ä»å¤šä¸ªçº¿ç¨‹å®‰å…¨åœ°è¯»å–ä¸€ä¸ªåŸŸã€‚

è¿˜æœ‰ä¸€ç§æƒ…å†µå¯ä»¥å®‰å…¨åœ°è®¿é—®ä¸€ä¸ªå…±äº«åŸŸï¼Œå³è¿™ä¸ªåŸŸå£°æ˜ä¸º `final` æ—¶ã€‚

ä»¥ä¸‹å£°æ˜ï¼š
```java
final Map<String, Double> accounts = new HashMap<>();
```
å…¶ä»–çº¿ç¨‹ä¼šåœ¨æ„é€ å‡½æ•°å®Œæˆæ„é€ ä¹‹åæ‰çœ‹åˆ°è¿™ä¸ª `accounts` å˜é‡ã€‚

å¦‚æœä¸ä½¿ç”¨ `final`ï¼Œå°±ä¸èƒ½ä¿è¯å…¶ä»–çº¿ç¨‹çœ‹åˆ°çš„æ˜¯ `accounts` æ›´æ–°åçš„å€¼ï¼Œå®ƒä»¬å¯èƒ½éƒ½åªæ˜¯çœ‹åˆ° `null`ï¼Œè€Œä¸æ˜¯æ–°æ„é€ çš„ `HashMap`ã€‚

å½“ç„¶ï¼Œå¯¹è¿™ä¸ªæ˜ å°„è¡¨çš„æ“ä½œå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åœ¨è¯»å†™è¿™ä¸ªæ˜ å°„è¡¨ï¼Œä»ç„¶éœ€è¦è¿›è¡ŒåŒæ­¥ã€‚

### åŸå­æ€§
å‡è®¾å¯¹å…±äº«å˜é‡é™¤äº†èµ‹å€¼ä¹‹å¤–å¹¶ä¸å®Œæˆå…¶ä»–æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥å°†è¿™äº›å…±äº«å˜é‡å£°æ˜ä¸º `volatile`ã€‚

java.util.concurrent.atomic åŒ…ä¸­å¾ˆå¤šç±»ä½¿ç”¨äº†å¾ˆé«˜æ•ˆçš„æœºå™¨çº§æŒ‡ä»¤ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é”æ¥ä¿è¯å…¶ä»–æ“ä½œçš„åŸå­æ€§ã€‚ä¾‹å¦‚ï¼Œ`AtomicInteger` ç±»æä¾›äº†æ–¹æ³• `incrementAndGet` å’Œ `decrementAndGet`ï¼Œå®ƒä»¬åˆ†åˆ«ä»¥åŸå­æ–¹å¼å°†ä¸€ä¸ªæ•´æ•°è‡ªå¢æˆ–è‡ªå‡ã€‚
```java
public static AtomicLong nextNumber = new AtomicLong();

// in some thread
long id = nextNumber.incrementAndGet();
```
`incrementAndGet` æ–¹æ³•ä»¥åŸå­æ–¹å¼å°† `nextNumber` è‡ªå¢ï¼Œå¹¶è¿”å›è‡ªå¢åçš„å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè·å¾—å€¼ã€å¢ 1 å¹¶è®¾ç½®ç„¶åç”Ÿæˆæ–°å€¼çš„æ“ä½œä¸ä¼šä¸­æ–­ã€‚å¯ä»¥ä¿è¯å³ä½¿æ˜¯å¤šä¸ªçº¿ç¨‹å¹¶å‘åœ°è®¿é—®åŒä¸€ä¸ªå®ä¾‹ï¼Œä¹Ÿä¼šè®¡ç®—å¹¶è¿”å›æ­£ç¡®çš„å€¼ã€‚

atomic ç¾[É™ËˆtÉ‘ËmÉªk] adj.åŸå­çš„; ä¸åŸå­æœ‰å…³çš„; åŸå­èƒ½çš„; åŸå­æ­¦å™¨çš„;

è·Ÿè¸ªä¸åŒçº¿ç¨‹è§‚å¯Ÿçš„æœ€å¤§å€¼ï¼Œä¸‹é¢çš„ä»£ç æ˜¯ä¸å¯è¡Œçš„ï¼š
```java
public static AtomicLong largest = new AtomicLong();

// in some thread
largest.set(Math.max(larget.get()), observed); // Error - race condtion!
```
è¿™ä¸ªæ›´æ–°ä¸æ˜¯åŸå­çš„ï¼Œå®é™…ä¸Šï¼Œåº”è¯¥åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è®¡ç®—æ–°å€¼å’Œä½¿ç”¨ `CompareAndSet`ï¼š
```java
do {
    oldValue = largest.get();
    newValue = Math.max(oldValue, observed);
} while (!largest.compareAndSet(oldValue, newValue));
```
å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿåœ¨æ›´æ–° `largest`ï¼Œå°±å¯èƒ½é˜»æ­¢è¿™ä¸ªçº¿ç¨‹æ›´æ–°ï¼Œè¿™æ ·ä¸€æ¥ï¼Œ`compareAndSet` è¿”å› `false`ï¼Œè€Œä¸ä¼šè®¾ç½®æ–°å€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¾ªç¯ä¼šæ›´æ–°å°è¯•ï¼Œè¯»å–æ›´æ–°åçš„å€¼ï¼Œå¹¶å°è¯•ä¿®æ”¹ã€‚æœ€ç»ˆï¼Œå®ƒä¼šæˆåŠŸåœ°ç”¨æ–°å€¼æ›¿æ¢åŸæ¥çš„å€¼ã€‚è¿™å¬ä¸Šå»æœ‰äº›éº»çƒ¦ï¼Œä¸è¿‡ `compareAndSet` æ–¹æ³•ä¼šæ˜ å°„åˆ°ä¸€ä¸ªå¤„ç†å™¨æ“ä½œï¼Œæ¯”ä½¿ç”¨é”çš„é€Ÿåº¦æ›´å¿«ã€‚

åœ¨ Java SE 8 ä¸­ï¼Œä¸å†éœ€è¦ç¼–å†™å¾ªç¯ä»£ç ï¼Œå¯ä»¥æä¾›ä¸€ä¸ª lambda è¡¨è¾¾å¼æ›´æ–°å˜é‡ï¼š
```java
largest.updateAndGet(x -> Math.max(x, observed));
// æˆ–
largest.accumulateAndGet(observed, Math::max);
```
`accumulateAndGet` æ–¹æ³•åˆ©ç”¨ä¸€ä¸ªäºŒå…ƒæ“ä½œç¬¦æ¥åˆå¹¶åŸå­å€¼å’Œæ‰€æä¾›çš„å‚æ•°ã€‚

`getAndUpdate` å’Œ `getAndAccumulate` æ–¹æ³•å¯ä»¥è¿”å›åŸå€¼ã€‚

ç±» `AtomicInteger`ã€`AtomicIntegerArray`ã€`AtomicIntegerFieldUpdate`ã€`AtomicLongArray`ã€`AtomicLongFieldUpdate`ã€`AtomicReference`ã€`AtomicRefenceArray` å’Œ `AtomicReferenceFieldUpdate` ä¹Ÿæä¾›äº†è¿™äº›æ–¹æ³•ã€‚

å¦‚æœæœ‰å¤§é‡çº¿ç¨‹è¦è®¿é—®ç›¸åŒçš„åŸå­å€¼ï¼Œæ€§èƒ½ä¼šå¤§å¹…ä¸‹é™ï¼Œå› ä¸ºä¹è§‚æ›´æ–°éœ€è¦å¤ªå¤šæ¬¡é‡è¯•ã€‚Java SE 8 æä¾›äº† `LongAdder` å’Œ `LongAccumulator` ç±»æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚`LongAdder` åŒ…æ‹¬å¤šä¸ªå˜é‡(åŠ æ•°)ï¼Œå…¶æ€»å’Œä¸ºå½“å‰å€¼ã€‚å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹æ›´æ–°ä¸åŒçš„åŠ æ•°ï¼Œçº¿ç¨‹ä¸ªæ•°å¢åŠ æ—¶ä¼šè‡ªåŠ¨æä¾›æ–°çš„åŠ æ•°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåªæœ‰å½“æ‰€æœ‰å·¥ä½œéƒ½å®Œæˆä¹‹åæ‰éœ€è¦æ€»å’Œçš„å€¼ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œè¿™ç§æ–¹æ³•ä¼šå¾ˆé«˜æ•ˆï¼Œæ€§èƒ½ä¼šæœ‰æ˜¾è‘—çš„æå‡ã€‚

å¦‚æœè®¤ä¸ºå¯èƒ½å­˜åœ¨å¤§é‡ç«äº‰ï¼Œåªéœ€è¦ä½¿ç”¨ `LongAdder` è€Œä¸æ˜¯ `AtomicLong`ã€‚è°ƒç”¨ `increment` è®©è®¡æ•°å™¨è‡ªå¢ï¼Œæˆ–è€…è°ƒç”¨ `add` æ¥å¢åŠ ä¸€ä¸ªé‡ï¼Œæˆ–è€…è°ƒç”¨ `sum` æ¥è·å¾—æ€»å’Œï¼š
```java
final LongAdder adder = new LongAdder();
for (...) {
    pool.submit(() -> {
        while (...) {
            ...
            if (...) {
                adder.increment();
            }
        }
    })
}
...
long total = adder.sum();
```
æ³¨æ„âš ï¸ï¼š`increment` æ–¹æ³•ä¸ä¼šè¿”å›åŸå€¼ï¼Œå¦‚æœé‚£æ ·åšä¼šæ¶ˆé™¤æ±‚å’Œåˆ†è§£åˆ°å¤šä¸ªåŠ æ•°æ‰€å¸¦æ¥çš„æ€§èƒ½æå‡ã€‚

`LongAccumulator` å°†è¿™ç§æ€æƒ³æ¨å¹¿åˆ°ä»»æ„çš„ç´¯åŠ æ“ä½œã€‚åœ¨æ„é€ å™¨ä¸­ï¼Œå¯ä»¥æä¾›è¿™ä¸ªæ“ä½œä»¥åŠå®ƒçš„é›¶å…ƒç´ ã€‚è¦åŠ å…¥æ–°çš„å€¼ï¼Œå¯ä»¥è°ƒç”¨ `accumulate`ã€‚è°ƒç”¨ `get` æ¥è·å¾—å½“å‰å€¼ï¼š
```java
LongAccumulator adder = new LongAccumulator(Long::sum, 0);

// in some thread
adder.accumulate(value);
```
åœ¨å†…éƒ¨ï¼Œè¿™ä¸ªç´¯åŠ å™¨åŒ…å«å˜é‡ a<sub>1</sub>ã€a<sub>2</sub>ã€... a<sub>n</sub>ï¼Œæ¯ä¸ªå˜é‡åˆå§‹åŒ–ä¸ºé›¶å…ƒç´ ã€‚

è°ƒç”¨ `accumulate` å¹¶æä¾›å€¼ v æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªå˜é‡ä¼šä»¥åŸå­å½¢å¼æ›´æ–°ä¸º a<sub>i</sub> = a<sub>i</sub> op vï¼Œè¿™é‡Œçš„ op æ˜¯ä¸­ç¼€å½¢å¼çš„ç´¯åŠ æ“ä½œã€‚

è°ƒç”¨ `get` çš„ç»“æœæ˜¯ a<sub>1</sub> op a<sub>2</sub> op ... op a<sub>n</sub>ã€‚

### æ­»é” deadlock
é”å’Œæ¡ä»¶ä¸èƒ½è§£å†³å¤šçº¿ç¨‹ä¸­çš„æ‰€æœ‰é—®é¢˜ã€‚

å› ä¸ºè´¦æˆ·1 ä»¥åŠè´¦æˆ·2 ä¸­çš„ä½™é¢éƒ½ä¸è¶³ä»¥è¿›è¡Œè½¬è´¦ï¼Œæœ‰å¯èƒ½å› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½è¦ç­‰å¾…æ›´å¤šçš„é’±æ¬¾å­˜å…¥è€Œå¯¼è‡´æ‰€æœ‰çš„çº¿ç¨‹éƒ½è¢«é˜»å¡ï¼Œè¿™æ ·çš„çŠ¶æ€ç§°ä¸ºæ­»é”ã€‚

å¯¼è‡´æ­»é”çš„å¦ä¸€ä¸ªé€”å¾„æ˜¯è®©ç¬¬ i ä¸ªçº¿ç¨‹è´Ÿè´£å‘ç¬¬ i ä¸ªè´¦æˆ·å­˜é’±ï¼Œè€Œä¸æ˜¯ä»ç¬¬ i ä¸ªè´¦æˆ·å–é’±ã€‚è¿™æ ·ä¸€æ¥ï¼Œæœ‰å¯èƒ½å°†æ‰€æœ‰çš„çº¿ç¨‹éƒ½é›†ä¸­ä¸€ä¸ªè´¦æˆ·ä¸Šï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½è¯•å›¾ä»è¿™ä¸ªè´¦æˆ·å–å‡ºå¤§äºè¯¥è´¦æˆ·ä½™é¢çš„é’±ã€‚

è¿˜æœ‰ä¸€ç§å¾ˆå®¹æ˜“å‘ç”Ÿæ­»é”çš„æƒ…å†µï¼šå°† `signalAll` æ–¹æ³•æ¢ä¸º `signal`ï¼Œ`signalAll` é€šçŸ¥æ‰€æœ‰ç­‰å¾…å¢åŠ èµ„é‡‘çš„çº¿ç¨‹ï¼Œè€Œ `signal` æ–¹æ³•ä»…ä»…å¯¹ä¸€ä¸ªçº¿ç¨‹è§£é”ï¼Œå¦‚æœè¯¥çº¿ç¨‹ä¸èƒ½ç»§ç»­è¿è¡Œï¼Œæ‰€æœ‰çš„çº¿ç¨‹å¯èƒ½éƒ½è¢«é˜»å¡ã€‚

Java ç¼–ç¨‹è¯­è¨€ä¸­æ²¡æœ‰ä»»ä½•ä¸œè¥¿å¯ä»¥é¿å…æˆ–æ‰“ç ´è¿™ç§æ­»é”ç°è±¡ï¼Œå¿…é¡»ä»”ç»†è®¾è®¡ç¨‹åºï¼Œä»¥ç¡®ä¿ä¸ä¼šå‡ºç°æ­»é”ã€‚

### çº¿ç¨‹å±€éƒ¨å˜é‡
åœ¨çº¿ç¨‹é—´å…±äº«å˜é‡æœ‰é£é™©ï¼Œä½¿ç”¨ `ThreadLocal` è¾…åŠ©ç±»ä¸ºå„ä¸ªçº¿ç¨‹æä¾›å„è‡ªçš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œ`SimpleDateFormat` ç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå‡è®¾æœ‰ä¸€ä¸ªé™æ€å˜é‡ï¼š
```java
public static final SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
```
å¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```java
String dateStamp = dateFormat.format(new Date());
```
`dateFormat` ä½¿ç”¨çš„å†…éƒ¨æ•°æ®ç»“æ„å¯èƒ½ä¼šè¢«å¹¶å‘çš„è®¿é—®æ‰€ç ´åã€‚

è¦ä¸ºæ¯ä¸ªçº¿ç¨‹æ„é€ ä¸€ä¸ªå®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ—ä»£ç ï¼š
```java
public static final ThreadLocal<SimpleDateFormat> dateFormat = ThreadLocal().withInitial(() -> new SimpleDateFormat("yyyy-MM-dd"));
```

è¦è®¿é—®å…·ä½“çš„æ ¼å¼åŒ–æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨ï¼š
```java
String dateStamp = dateFormat.get().format(new Date());
```
åœ¨ä¸€ä¸ªç»™å®šçº¿ç¨‹ä¸­é¦–æ¬¡è°ƒç”¨ `get` æ—¶ï¼Œä¼šè°ƒç”¨ `initialValue` æ–¹æ³•ï¼Œåœ¨æ­¤ä¹‹åï¼Œ`get` æ–¹æ³•ä¼šè¿”å›å±äºå½“å‰çº¿ç¨‹çš„é‚£ä¸ªå®ä¾‹ã€‚

java.util.Random ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¦‚æœå¤šä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…ä¸€ä¸ªå…±äº«çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼Œè¿™æ ·ä¼šå¾ˆä½æ•ˆï¼Œå¯ä»¥ä½¿ç”¨ `ThreadLocal` è¾…åŠ©ç±»ä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ä¸€ä¸ªå•ç‹¬çš„ç”Ÿæˆå™¨ã€‚åœ¨ Java SE 7 ä¸­å¦å¤–æä¾›äº†ä¸€ä¸ªä¾¿åˆ©ç±»ï¼Œ `ThreadLocalRandom.current()` è°ƒç”¨ä¼šè¿”å›ç‰¹å®šäºå½“å‰çº¿ç¨‹çš„ `Random` ç±»å®ä¾‹ï¼š
```java
int random = ThreadLocalRandom.current().nextInt(upperBound);
```

### é”æµ‹è¯•ä¸è¶…æ—¶
çº¿ç¨‹åœ¨è°ƒç”¨ `lock` æ–¹æ³•æ¥è·å¾—å¦ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰çš„é”çš„æ—¶å€™ï¼Œå¾ˆå¯èƒ½å‘ç”Ÿé˜»å¡ï¼Œåº”è¯¥è°¨æ…åœ°ç”³è¯·é”ã€‚

`tryLock` æ–¹æ³•è¯•å›¾ç”³è¯·ä¸€ä¸ªé”ï¼Œåœ¨æˆåŠŸè·å¾—é”åè¿”å› `true`ï¼Œå¦åˆ™ï¼Œç«‹å³è¿”å› `false`ï¼Œè€Œä¸”çº¿ç¨‹å¯ä»¥ç«‹å³ç¦»å¼€å»åšå…¶ä»–äº‹æƒ…ã€‚
```java
if (myLock.tryLock()) {
    // now the thread owns the lock
    try {
        // ...
    } finally {
        myLock.unlock();
    }
} else {
    // do something else
}
```
å¯ä»¥è°ƒç”¨ `tryLock` æ—¶ï¼Œä½¿ç”¨è¶…æ—¶å‚æ•°ï¼š
```java
if (myLock.tryLock(100, TimeUnit.MILISECONDS)) { ... }
```

`lock` æ–¹æ³•ä¸èƒ½è¢«ä¸­æ–­ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…è·å¾—ä¸€ä¸ªé”æ—¶è¢«ä¸­æ–­ï¼Œä¸­æ–­çº¿ç¨‹åœ¨è·å¾—é”ä¹‹å‰ä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ã€‚å¦‚æœå‡ºç°æ­»é”ï¼Œé‚£ä¹ˆï¼Œ`lock` æ–¹æ³•æ— æ³•ç»ˆæ­¢ã€‚ç„¶è€Œï¼Œå¦‚æœè°ƒç”¨å¸¦æœ‰è¶…æ—¶å‚æ•°çš„ `tryLock`ï¼Œé‚£ä¹ˆå¦‚æœçº¿ç¨‹åœ¨ç­‰å¾…æœŸé—´è¢«ä¸­æ–­ï¼Œå°†æŠ›å‡º `InterruptedException` å¼‚å¸¸ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç‰¹æ€§ï¼Œå› ä¸ºå…è®¸ç¨‹åºæ‰“ç ´æ­»é”ã€‚

ä¹Ÿå¯ä»¥è°ƒç”¨ `lockInterruptibly` æ–¹æ³•ï¼Œå®ƒå°±ç›¸å½“äºä¸€ä¸ªè¶…æ—¶è®¾ä¸ºæ— é™çš„ `tryLock` æ–¹æ³•ã€‚

åœ¨ç­‰å¾…ä¸€ä¸ªæ¡ä»¶æ—¶ï¼Œä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªè¶…æ—¶ï¼š
```java
myCondtion.await(100, TimeUnit.MILISECONDS);
```
å¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«å¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡è°ƒç”¨ `signalAll` æˆ– `signal` æ¿€æ´»ï¼Œæˆ–è€…è¶…æ—¶æ—¶é™å·²è¾¾åˆ°ï¼Œæˆ–è€…çº¿ç¨‹è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆ `await` æ–¹æ³•å°†è¿”å›ã€‚

å¦‚æœç­‰å¾…çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œ`await` æ–¹æ³•å°†æŠ›å‡ºä¸€ä¸ª `InterruptedException` å¼‚å¸¸ã€‚

### è¯»ï¼å†™é”
java.util.concurrent.locks åŒ…ä¸­å®šä¹‰äº†ä¸¤ä¸ªé”ç±»ï¼Œ`ReentrantLock` ç±»å’Œ `ReentrantReadWriteLock` ç±»ã€‚

å¦‚æœå¾ˆå¤šçº¿ç¨‹ä»ä¸€ä¸ªæ•°æ®ç»“æ„è¯»å–æ•°æ®è€Œå¾ˆå°‘çº¿ç¨‹ä¿®æ”¹å…¶ä¸­æ•°æ®çš„è¯ï¼Œåè€…æ˜¯ååˆ†æœ‰ç”¨çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå…è®¸å¯¹è¯»çº¿ç¨‹å…±äº«è®¿é—®æ˜¯åˆé€‚çš„ï¼Œå¯¹å†™çº¿ç¨‹ä¾ç„¶å¿…é¡»æ˜¯äº’æ–¥è®¿é—®çš„ã€‚

ä½¿ç”¨è¯»ï¼å†™é”çš„æ­¥éª¤ï¼š

1) æ„é€ ä¸€ä¸ª `ReentrantReadWriteLock` å¯¹è±¡ï¼š
```java
private ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
```

2) æŠ½å–è¯»é”å’Œå†™é”ï¼š
```java
private Lock readLock = rwl.readLock();
private Lock writeLock = rwl.writeLock();
```

3) å¯¹æ‰€æœ‰çš„è·å–æ–¹æ³•åŠ è¯»é”ï¼š
```java
public double getTotalBalance() {
    readLock.lock();
    try { ... }
    finally { readLock.unlock(); }
}
```

4) å¯¹æ‰€æœ‰çš„ä¿®æ”¹æ–¹æ³•åŠ å†™é”ï¼š
```java
public void transfer(...) {
    writeLock.lock();
    try { ... }
    finally { writeLock.unlock(); }
}
```

### ä¸ºä»€ä¹ˆå¼ƒç”¨ stop å’Œ suspend æ–¹æ³•
åˆå§‹çš„ Java ç‰ˆæœ¬å®šä¹‰äº†ä¸€ä¸ª `stop` æ–¹æ³•ç”¨æ¥ç»ˆæ­¢ä¸€ä¸ªè¿›ç¨‹ï¼Œä»¥åŠä¸€ä¸ª `suspend` æ–¹æ³•ç”¨æ¥é˜»å¡ä¸€ä¸ªçº¿ç¨‹ç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `resume`ã€‚`stop` å’Œ `suspend` æ–¹æ³•æœ‰ä¸€äº›å…±åŒç‚¹ï¼šéƒ½è¯•å›¾æ§åˆ¶ä¸€ä¸ªç»™å®šçº¿ç¨‹çš„è¡Œä¸ºã€‚

`stop` æ–¹æ³•ç»ˆæ­¢æ‰€æœ‰æœªç»“æŸçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ `run` æ–¹æ³•ã€‚å½“çº¿ç¨‹è¢«ç»ˆæ­¢ï¼Œç«‹å³é‡Šæ”¾è¢«å®ƒé”ä½çš„æ‰€æœ‰å¯¹è±¡çš„é”ï¼Œè¿™ä¼šå¯¼è‡´å¯¹è±¡å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚

å½“çº¿ç¨‹è¦ç»ˆæ­¢å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œæ— æ³•çŸ¥é“ä»€ä¹ˆæ—¶å€™è°ƒç”¨ `stop` æ–¹æ³•æ˜¯å®‰å…¨çš„ï¼Œä»€ä¹ˆæ—¶å€™å¯¼è‡´å¯¹è±¡è¢«ç ´åã€‚<font color="red">åœ¨å¸Œæœ›åœæ­¢çº¿ç¨‹çš„æ—¶å€™åº”è¯¥ä¸­æ–­çº¿ç¨‹ï¼Œè¢«ä¸­æ–­çš„çº¿ç¨‹ä¼šåœ¨å®‰å…¨çš„æ—¶å€™åœæ­¢ã€‚</font>

`suspend` æ–¹æ³•ä¸ä¼šç ´åå¯¹è±¡ï¼Œå¦‚æœç”¨ `suspend` æŒ‚èµ·ä¸€ä¸ªæŒæœ‰é”çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆï¼Œè¯¥é”åœ¨æ¢å¤ä¹‹å‰æ˜¯ä¸å¯ç”¨çš„ã€‚å¦‚æœè°ƒç”¨ `suspend` æ–¹æ³•çš„çº¿ç¨‹è¯•å›¾è·å¾—åŒä¸€é”ï¼Œé‚£ä¹ˆç¨‹åºæ­»é”ï¼šè¢«æŒ‚èµ·çš„çº¿ç¨‹ç­‰ç€è¢«æ¢å¤ï¼Œè€Œå°†å…¶æŒ‚èµ·çš„çº¿ç¨‹ç­‰å¾…è·å¾—é”ã€‚

å¦‚æœæƒ³å®‰å…¨åœ°æŒ‚èµ·çº¿ç¨‹ï¼Œå¼•å…¥ä¸€ä¸ªå˜é‡ `suspendRequested` å¹¶åœ¨ `run` æ–¹æ³•çš„æŸä¸ªå®‰å…¨åœ°æ–¹æµ‹è¯•å®ƒï¼Œå®‰å…¨çš„åœ°æ–¹æ˜¯æŒ‡è¯¥çº¿ç¨‹æ²¡æœ‰å°é”å…¶ä»–çº¿ç¨‹éœ€è¦çš„å¯¹è±¡çš„åœ°æ–¹ã€‚å½“çº¿ç¨‹å‘ç° `suspendRequested` å˜é‡å·²ç»è®¾ç½®ï¼Œå°†ä¼šä¿æŒç­‰å¾…çŠ¶æ€çŸ¥é“å®ƒå†æ¬¡è·å¾—ä¸ºæ­¢ã€‚


## é˜»å¡é˜Ÿåˆ—


## çº¿ç¨‹å®‰å…¨çš„é›†åˆ


## Collable ä¸ Future


## æ‰§è¡Œå™¨


## åŒæ­¥å™¨


## çº¿ç¨‹ä¸ Swing


## å‚è€ƒ
[1] Javaæ ¸å¿ƒæŠ€æœ¯.å·â… .åŸºç¡€çŸ¥è¯†(åŸä¹¦ç¬¬10ç‰ˆ).æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾,2016.8


