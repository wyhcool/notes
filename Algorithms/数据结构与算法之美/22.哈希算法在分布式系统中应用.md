---
title: 哈希算法在分布式系统中应用
date: 2022-07-30 18:25:00
tags:
categories:
- 算法
---

## 应用五：负载均衡
实现一个会话粘滞(session sticky)的负载均衡算法，在同一个客户端上，在一次会话中的所有请求都路由到同一个服务器上。

最直接的方法就是，维护一张映射关系表，这张表的内容是客户端 IP 地址或者回话 ID 与服务器编号的映射关系。客户端发出的每次请求，都要先在映射表中查找应该路由到的服务器编号，然后再请求编号对应的服务器。这种方法简单直观，存在弊端：
- 如果客户端很多，映射表可能会很大，比较浪费内存空间；
- 客户端下线、上线，服务器扩容、缩容都会导致映射失效，这样维护映射表的成本就会很大。

通过哈希算法，对客户端 IP 地址或者会话 ID 计算哈希值，将取得的哈希值域服务器列表的大小进行取模运算，最终得到的值就是应该被路由到的服务器编号。这样，我们就可以把同一个 IP 过来的所有请求，都路由到同一个后端服务器上。

## 应用六：数据分片
当处理的数据非常大时，先对数据进行分片，然后采用多台机器处理的方法，来提高处理速度。

用 n 台机器并行处理，从搜索记录的日志文件中，依次读出每个搜索关键字，并通过哈希函数计算哈希值，然后再跟 n 取模，最终得到的值，就是应该被分配到的机器编号。这样，哈希值相同的搜索关键词就被分配到了同一个机器上，每个机器分别计算关键字出现的次数，最终合并起来就是最终的结果。

这样的处理过程也是 MapReduce 的基本设计思想。

针对海量数据的处理问题，都可以采用多机分布式处理。借助这种分片的思路，可以突破单机内存、CPU 等资源的限制。

## 应用七：分布式存储
通过哈希算法对数据取哈希值，然后对机器个数取模，这个最终值就是应该存储的缓存机器编号。当扩容时候，所有的数据都要重新计算哈希值，然后重新搬移到正确的机器上，这样就相当于，缓存中的数据一下子就都失效了。所有的数据请求都会穿透缓存，直接请求数据库。

索引，我们需要一个方法，使得在新加入一个机器后，并不需要做大量的数据搬移。

假设我们有 k 个机器，数据的哈希值的范围是 `[0, MAX]`。我们将整个范围划分为 m 个小区间(m 远大于 k)，每个机器负责 m/k 个小区间。当有新机器加入的时候，我们就将某几个小区间的数据，从原来的机器中搬移到新的机器中，这样既不用全部重新哈希、搬移数据，也保持了各个机器上数据数量的均衡。这就是一致性哈希算法的基本思想。

其实，一致性哈希算法也是使用取模的方法，只是，普通的取模法是对服务器的数量进行取模，而一致性哈希算法是对 2^32 取模。


## 参考
[1] https://time.geekbang.org/column/intro/100017301?tab=catalog

[2] https://github.com/wangzheng0822/algo

[3] https://www.zsythink.net/archives/1182
