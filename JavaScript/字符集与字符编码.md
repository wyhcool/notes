---
title: 字符集与字符编码 Charset and Encoding
date: 2018-10-18 20:05:35
tags:
categories:
- null
---

## 基础知识
编码：按照何种规则将字符存储在计算机中。

解码：将存储在计算机中的二进制数解析显示出来。在解码过程中，如果使用了错误的解码规则，则导致'a'解析成'b'或者乱码。

字符集（Charset）：是一个系统支持的所有抽象字符的集合。字符是各种文字和符号的总称，包括各国家文字、标点符号、图形符号、数字等。

字符编码（Character Encoding）：是一套法则，使用该法则能够对自然语言的字符的一个集合（如字母表或音节表），与其他东西的一个集合（如号码或电脉冲）进行配对。即在符号集合与数字系统之间建立对应关系，它是信息处理的一项基本技术。通常人们用符号集合（一般情况下就是文字）来表达信息。而以计算机为基础的信息处理系统则是利用元件（硬件）不同状态的组合来存储和处理信息的。元件不同状态的组合能代表数字系统的数字，因此字符编码就是将符号转换为计算机可以接受的数字系统的数，称为数字代码。

<!-- more -->
## 常用字符集和字符编码
常见字符集名称：ASCII字符集、GB2312字符集、BIG5字符集、GB18030字符集、Unicode字符集等。计算机要准确的处理各种字符集文字，需要进行字符编码，以便计算机能够识别和存储各种文字。

### ASCII 字符集及编码
ASCII（American Standard Code for Information Interchange，美国信息交换标准代码）是基于拉丁字母的一套电脑编码系统。它主要用于显示现代英语。

ASCII 字符集：主要包括控制字符（回车键、退格、换行键等，由0x20以下的字节表示）；可显示字符（英文大小写字母、阿拉伯数字和英文符号）。

ASCII 编码规则：将ASCII字符集转换为计算机可以接受的数字系统的数的规则。使用7位（bits）表示一个字符，共128字符，从0x00到0x7F，将每个字符对应的编号转换为一个8bit的二进制数；但是7位编码的字符集只能支持128个字符，为了表示更多的欧洲常用字符对ASCII进行了扩展，ASCII扩展字符集使用8位（bits）表示一个字符，共256字符。

解码：以字节为单位进行解码，将每个字节转换为数字，去字符表里找到对应编号的字符。

### GBXXXX 字符集及编码
为了让使用非英语字符的国家也能使用计算机，那就有需要创造新的字符集，然后对其中的每个字符进行编码。基于这样的背景，不同国家就编制了自己的字符集和对应的编码方案。中国的字符集和编码方案大体经过了三个阶段：GB2312 -> GBK -> GB18030。

#### GB2312
GB2312 编码规则： GB2312完全兼容ASCII字符编码，首先将那些127号之后的奇异符号（即EASCII）取消掉，规定：一个小于127的字符的意义与原来相同，但两个大于127的字符连在一起时，就表示一个汉字，前面的一个字节（称之为高字节）从0xA1到0xF7，后面一个字节（低字节）从0xA1到0xFE，这样我们就可以组合出大约7000多个简体汉字了。在这些编码里，还把数学符号、罗马希腊的字母、日文的假名们都编进去了，连在ASCII里本来就有的数字、标点、字母都统统重新编了两个字节长的编码，这就是常说的"全角"字符，而原来在127号以下的那些就叫"半角"字符。

解码：先看第一个bit位，如果第一个bit位是0，那就是ASCII字符，解析单字节。如果第一个bit位是1，那不是ASCII字符，将两个字节作为整体进行解析，根据的编码表找到对应的字符。

#### GBK
GBK(GBK即“国标”、“扩展”汉语拼音的第一个字母) 编码规则：GBK完全兼容GB2312，并对GB2312字符集进行了扩充，其内码空间为0x8140 ~ 0xFEFE，去除第二字节的0x7F（192个码位），总共23940个码位。

解码：规则同 GB2312 解码规则。

#### GB18030
GB18030 字符集：解决汉字、日文假名、朝鲜语和中国少数民族文字组成的大字符集计算机编码问题。该标准的字符总编码空间超过150万个编码位，收录了27484个汉字，覆盖中文、日文、朝鲜语和中国少数民族文字。满足中国大陆、香港、台湾、日本和韩国等东亚地区信息交换多文种、大字量、多用途、统一编码格式的要求。GB18030完全兼容GB2312。

GB18030 编码规则：GB18030编码采用单字节，双字节和四字节三种方式。其中，ASCII字符采用单字节编码方式，依然是从0x00到0x7F，因此GB18030也完全兼容ASCII码。其它字符用双字节或四字节来表示。对于双字节，高字节从0x81到0xFE，低字节从0x40到0x7E，0x80到0xFE。GB2312的双字节编码就在GB18030的双字节编码范围内。对于四字节，第一字节(最高位字节)和第三字节都是从0x81到0xFE，第二和第四字节从0x30到0x39，因此四字节编码范围从0x81308130到0xFE39FE39。

解码：如果第一个bit位是0，那就是ASCII字符，解析单字节。如果第一个bit是1，那就继续看第二个字节，如果第二个字节范围在0x30到0x39之间，那就是四字节，以四字节为一个单位进行字符解析，如果第二个字节不在0x30到0x39之间，那就是双字节，以双字节为一个单位进行字符解析。

### Unicode字符集及编码
Unicode字符集包含了全世界所有字符，又称“统一码”和“万国码”。Unicode字符集只是给了每个字符一个对应的编号，具体对每个字符怎么进行编码是没有规定的。现在Unicode字符集有多种编码方案(Unicode Transformation Format)，包括UTF-32, UTF-16, UTF-8。

通用字符集（Universal Character Set，UCS）是由ISO制定的ISO 10646（或称ISO/IEC 10646）标准所定义的标准字符集。历史上存在两个独立的尝试创立单一字符集的组织，即国际标准化组织（ISO）和多语言软件制造商组成的统一码联盟。前者开发的 ISO/IEC 10646 项目，后者开发的统一码项目。因此最初制定了不同的标准。

在Unicode字符集中的某个字符对应的代码值，称作代码点（Code Point），用16进制书写，并加上U+前缀。比如，‘田’的代码点是U+7530；‘A’的代码点是U+0041。

Unicode定义的字符集已经超过16位所能表达的范围，把所有这些CodePoint分成17个代码平面（Code Plane）：
- U+0000 ~ U+FFFF划入基本多语言平面（Basic Multilingual Plane，简记为BMP）；
- 其余划入16个辅助平面（Supplementary Plane），代码点范围 U+10000 ~ U+10FFFF。

虽然这样划分，但并不是每个Plane中的Code point都对应有字符，这里面有保留的，还有特殊用途的。


#### UTF-32
编码: 对Unicode字符集里的每个字符用四字节来表示，转换方式很简单，直接将字符对应的编号数字转换为四字节的二进制数。正是因为UTF-32把每个字符都用四字节来存储，因此UTF-32不兼容ASCII编码，也就是说ASCII编码的文件用UTF-32来打开会成为乱码。UCS-4和UTF-32是一样的编码方式。

解码: 以四个字节为单位进行解析即可，找到Unicode字符集中对应编号的字符。

优点：编码简单，查找第N个字符只需要O(1)时间。

缺点：浪费存储空间，大量常用字符的编号只需要2个字节就能表示。其次，在存储的时候需要指定字节序，是高位字节存储在前，还是低位字节存储在前。

#### UTF-16
编码：对Unicode字符集里的字符用双字节或者四字节进行表示。字符编号在0到65535的统一用2个字节来表示，将每个字符的编号转换为2字节的二进制数，从0x0000到0xFFFF。对于编号大于0xFFFF的，也就是编号从0x010000到0x10FFFF的字符，以如下方式进行编码：将该字符的编号减去0x010000，减去之后范围从0x00000到0xFFFFF，刚好用20个bit位可以表示，将前10个bit位作为高位与0xD800相加，后10个bit位作为低位和0xDC00相加，因为前10个bit位在前面补6个0，凑成双字节后，范围是从0x0000到0x03FF，因此加上0xD800后 范围从0xD800到0xDBFF，同样的后10个bit位加上0xDC00后范围从0xDC00到0xDFFF，很巧妙的是，**在Unicode字符集里，刚好编号0xD800到0xDFFF没有表示任何字符**，因此在解码的时候如果发现高位的两个字节是在0xD800到0xDBFF就知道，这两个字节应该和低位的2个字节作为一个整体，即以四字节为单位进行解析。
UCS-2字符集是Unicode中编号从0到65535的字符，（**UCS-2是UTF-16的子集**）编码方式与UTF-16的双字节字符编码方式完全相同，就是对编号从0到65535的字符，按双字节进行编码。

解码：每2个字节去看，如果这两个字节不在0xD800到0xDFFF范围内，那就是双字节编码的字符，以双字节进行解析，找到对应编号的字符。如果这两个字节在0xD800到 0xDFFF之间，那就是四字节编码的字符，以四字节进行解析，找到对应编号的字符。

优点：和UTF-32相比，节约了存储空间。

缺点：和UTF-32一样，存在一个字节序的问题。

#### UTF-8
编码：每个字符根据自己的编号范围去进行对应的编码。

|编号| UTF-8二进制编码|
| - | - |
| U+00000000 – U+0000007F | 0xxxxxxx (00-7F) |
| U+00000080 – U+000007FF | 110xxxxx (C0-DF) 10xxxxxx (80-BF)|
| U+00000800 – U+0000FFFF | 1110xxxx (E0-EF) 10xxxxxx 10xxxxxx |
| U+00010000 – U+001FFFFF | 11110xxx (F0-F7) 10xxxxxx 10xxxxxx 10xxxxxx |


解码：以字节为单位去看，如果第一个字节的bit位以0打头，那就是ASCII字符，以单字节进行解析。如果第一个字节的bit位以110打头，就按双字节进行解析。 如果第一个字节的bit位以1110大头，就按三字节进行解析。如果第一个字节的bit位以11110大头，就按四字节进行解析。

UTF-8使用四个字节来编码似乎太耗费资源了。但UTF-8对所有常用的字符都只用三个字节表达，而且UTF-16编码对前述的第四种字符同样需要四个字节来编码，而如果是ASCII居多的字符，UTF-8能极大的节约存储空间。UTF-8逐渐成为电子邮件、网页及其他储存或传送文字的应用中，优先采用的编码。互联网工程工作小组（IETF）要求所有互联网协议都必须支持UTF-8编码。互联网邮件联盟（IMC）建议所有电子邮件软件都支持UTF-8编码。


### 字节序与 BOM(Byte Order Mark)

计算机在内存中存放数据的顺序都是从低地址到高地址，所不同的是取低字节的数据存在低地址（小端法，little endian，低位字节在前）还是取高字节数据存在低地址（大端法，big endian，高位字节在前）。在几乎所有的机器上，多字节对象都被存储为连续的字节序列。

ASCII编码没有字节序问题，因为每个字符只用一个字节来表示。
GB系列编码都是大端序，即高位字节在前。
UTF8编码没有字节序问题，根据第一个字节的bit位中连续的1的个数，决定后面有多少个字节，然后去解析找到对应的字符。
UTF16有大端序和小端序，分别叫做UTF-16BE和UTF-16LE。
UTF-32实际中用得很少。

既然UTF系列有这么多编码方式，那到底计算机软件在打开文档的时候到底应该用什么编码方式去解码呢？在文档最前面加标记，一种标记对应一种编码方式，这些标记就叫做字节顺序标记(BOM)。BOM是对Unicode的几种编码而言的，ANSI编码没有BOM。

|字节开头| Charset/Encoding|
| - | - |
|   EF BB BF   | UTF8 |
|     FF FE    | UTF-16/UCS-2, little endian(UTF-16LE) |
|     FE FF    | UTF-16/UCS-2, big endian(UTF-16BE) |
|  FF FE 00 00 | UTF-32/UCS-4, little endian |
|  00 00 FE FF | UTF-32/UCS-4, big endian |

其中 UTF-8 以字节为编码单元，它的字节顺序在所有系统中都是一様的，没有字节序的问题，也因此它实际上并不需要BOM。但是UTF-8 with BOM即utf-8-sig需要提供BOM。

字符U+FEFF如果出现在字节流的开头，则用来标识该字节流的字节序，是高位在前还是低位在前。如果它出现在字节流的中间，则表达零宽度非换行空格的意义，用户看起来就是一个空格。从Unicode3.2开始，U+FEFF只能出现在字节流的开头，只能用于标识字节序，就如它的名称——字节序标记——所表示的一样；除此以外的用法已被舍弃。取而代之的是，使用U+2060来表达零宽度无断空白。


## JavaScript 语言支持编码 UCS-2
JavaScript语言采用Unicode字符集，但是只支持一种编码方法。JavaScript用的是UCS-2！

UCS的开发进度快于Unicode，1990年就公布了第一套编码方法UCS-2，使用2个字节表示已经有码点的字符。（那个时候只有一个平面，就是基本平面，所以2个字节就够用了）。UTF-16编码迟至1996年7月才公布，明确宣布是UCS-2的超集，即基本平面字符沿用UCS-2编码，辅助平面字符定义了4个字节的表示方法。
两者的关系简单说，就是UTF-16取代了UCS-2，或者说UCS-2整合进了UTF-16。所以，现在只有UTF-16，没有UCS-2。

1995年5月，Brendan Eich用了10天设计了JavaScript语言；10月，第一个解释引擎问世；次年11月，Netscape正式向ECMA提交语言标准。对比UTF-16的发布时间（1996年7月），就会明白Netscape公司那时没有其他选择，只有UCS-2一种编码方法可用！

由于JavaScript只能处理UCS-2编码，造成所有字符在这门语言中都是2个字节，如果是4个字节的字符，会当作两个双字节的字符处理。JavaScript的字符函数都受到这一点的影响，无法返回正确结果。

```javascript
"𝌆".length          //2

"𝌆".charCodeAt(0)   //55348 -> 0xD834
"𝌆".charCodeAt(1)   //57094 -> 0xDF06 这两个码点在 UCS-2 中是空的(0xD800 ~ 0xDFFF)

"𝌆" === "\uD834\uDF06" //true

while (++index < length) {
  // ...
  if (charCode >= 0xD800 && charCode <= 0xDBFF) {
    output.push(character + string.charAt(++index));
  } else {
    output.push(character);
  }
}
```
上面代码表示，处理字符串的时候，必须对码点做一个判断，只要落在0xD800到0xDBFF的区间，就要连同后面2个字节一起读取。
类似的问题存在于所有的JavaScript字符操作函数：
- String.prototype.replace()
- String.prototype.substring()
- String.prototype.slice()

上面的函数都只对2字节的码点有效。要正确处理4字节的码点，就必须逐一部署自己的版本，判断一下当前字符的码点范围。

**ECMAScript 6（简称ES6），大幅增强了Unicode支持，基本上解决了这个问题**。

## HTTP 相关字符集及字符编码

Accept-Charset：浏览器申明自己接收的字符集，如gb2312，utf-8（通常我们说Charset包括了相应的字符编码方案）；

Accept-Encoding：浏览器申明自己接收的编码方法，通常指定压缩方法，是否支持压缩，支持什么压缩方法（gzip，deflate），（注意：这不是只字符编码）；

Accept-Language：浏览器申明自己接收的语言。语言跟字符集的区别：中文是语言，中文有多种字符集，比如big5，gb2312，gbk等等；


Content-Type：WEB服务器告诉浏览器自己响应的对象的类型和字符集。例如：Content-Type: text/javascript; charset=UTF-8

Content-Encoding：WEB服务器表明自己使用了什么压缩方法（gzip，deflate）压缩响应中的对象。例如：Content-Encoding: gzip

Content-Language：WEB服务器告诉浏览器自己响应的对象的语言。



## 参考
[1] [字符集和字符编码（Charset & Encoding）| 吴秦（Tyler）](http://www.cnblogs.com/skynet/archive/2011/05/03/2035105.html)

[2] [ASCII 编码](http://17de.com/library/c/ascii.html)

[3] [GB2312 编码](http://ash.jp/code/cn/gb2312tbl.htm)

[4] [遇到乱码不怕不怕啦——计算机字符编码详尽讲解 | 傅里叶变黄油猫](https://www.guokr.com/blog/763017/)

[5] [Unicode与JavaScript详解 | 阮一峰](http://www.ruanyifeng.com/blog/2014/12/unicode.html)

[6] [去除 \ufeff](https://www.cnblogs.com/chongzi1990/p/8694883.html)