---
title: ç”Ÿæˆå™¨ generator
date: 2020-05-30 18:51:00
tags:
categories:
- JavaScript
---

## æ‰“ç ´å®Œæ•´è¿è¡Œ
ä¸€ä¸ªå‡½æ•°ä¸€æ—¦å¼€å§‹æ‰§è¡Œï¼Œå°±ä¼šè¿è¡Œåˆ°ç»“æŸï¼ŒæœŸé—´ä¸ä¼šæœ‰å…¶ä»–ä»£ç èƒ½å¤Ÿæ‰“æ–­å®ƒå¹¶æ’å…¥æœŸé—´ã€‚

ES6 å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å‡½æ•°ç±»å‹ï¼Œå®ƒå¹¶ä¸ç¬¦åˆè¿™ç§è¿è¡Œåˆ°ç»“æŸçš„ç‰¹æ€§ï¼Œè¿™ç±»æ–°çš„å‡½æ•°è¢«ç§°ä¸ºç”Ÿæˆå™¨ã€‚

JavaScript å¹¶ä¸æ˜¯æŠ¢å å¼çš„ï¼Œç›®å‰ä¹Ÿä¸æ˜¯å¤šçº¿ç¨‹çš„ï¼Œç„¶è€Œï¼Œå¦‚æœ foo() è‡ªèº«å¯ä»¥é€šè¿‡æŸç§å½¢å¼åœ¨ä»£ç çš„æŸä¸ªä½ç½®æŒ‡ç¤ºæš‚åœçš„è¯ï¼Œé‚£å°±ä»ç„¶å¯ä»¥ä»¥ä¸€ç§åˆä½œå¼çš„æ–¹å¼å®ç°è¿™æ ·çš„ä¸­æ–­(å¹¶å‘)ã€‚
 
```javascript
var x = 1;

function *foo() {
    x++;
    yield; // æš‚åœï¼
    console.log('x', x);
}

function bar() {
    x++;
}

// å¦‚ä½•ä½¿å¾— bar() åœ¨ *foo() å†…éƒ¨çš„ yield å¤„æ‰§è¡Œå‘¢ï¼Ÿ

// æ„é€ ä¸€ä¸ªè¿­ä»£å™¨æ¥æ§åˆ¶è¿™ä¸ªç”Ÿæˆå™¨
var it = foo();

// å¯åŠ¨ foo()
it.next();
console.log(x); // 2
bar();
console.log(x); // 3
it.next();
```
æ˜¾ç„¶ï¼Œfoo() å¯åŠ¨äº†ï¼Œä½†æ˜¯æ²¡æœ‰å®Œæ•´è¿è¡Œï¼Œå®ƒåœ¨ yield å¤„æš‚åœäº†ï¼Œåé¢æ¢å¤äº† foo() å¹¶è®©å®ƒè¿è¡Œåˆ°ç»“æŸï¼Œä½†è¿™ä¸æ˜¯å¿…éœ€çš„ã€‚

ç”Ÿæˆå™¨å°±æ˜¯ä¸€ç±»ç‰¹æ®Šçš„å‡½æ•°ï¼Œå¯ä»¥ä¸€æ¬¡æˆ–å¤šæ¬¡å¯åŠ¨å’Œåœæ­¢ï¼Œå¹¶ä¸ä¸€å®šéå¾—è¦å®Œæˆã€‚

### è¾“å…¥å’Œè¾“å‡º
ç”Ÿæˆå™¨å‡½æ•°ä»ç„¶å¯ä»¥æ¥å—å‚æ•°(å³è¾“å…¥)ï¼Œä¹Ÿèƒ½å¤Ÿè¿”å›å€¼(å³è¾“å‡º)ã€‚
```javascript
function *foo(x, y) {
    return x * y;
}

var it = foo(6, 7);
// it =
// foo {<suspended>}
// __proto__: Generator
// [[GeneratorLocation]]: VM796:1
// [[GeneratorStatus]]: "suspended"
// [[GeneratorFunction]]: Æ’ *foo(x, y)
// [[GeneratorReceiver]]: Window
// [[Scopes]]: Scopes[3]
```
ç”Ÿæˆå™¨å’Œæ™®é€šå‡½æ•°åœ¨è°ƒç”¨ä¸Šçš„åŒºåˆ«ï¼šfoo(6, 7)ï¼Œç”Ÿæˆå™¨å¹¶æ²¡æœ‰åƒæ™®é€šå‡½æ•°ä¸€æ ·å®é™…è¿è¡Œï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚

next(..) è°ƒç”¨çš„ç»“æœæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒæœ‰ä¸€ä¸ª value å¯¹è±¡ï¼ŒæŒæœ‰ä» *foo(..) è¿”å›çš„å€¼ï¼Œyield ä¼šå¯¼è‡´ç”Ÿæˆå™¨åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘é€å‡ºä¸€ä¸ªå€¼ï¼Œç±»ä¼¼äºä¸­é—´çš„ returnã€‚

ç”Ÿæˆå™¨æä¾›äº†æ›´å¼ºå¤§æ›´å¼•äººæ³¨ç›®çš„å†…å»ºæ¶ˆæ¯è¾“å…¥è¾“å‡ºèƒ½åŠ›ï¼Œé€šè¿‡ yield å’Œ next(..) å®ç°ã€‚
```javascript
function *foo(x) {
    var y = x * (yield);
    return y;
}

var it = foo(6);

// å¯åŠ¨ foo
it.next();
// è¿”å›å€¼ {value: undefined, done: false}
// it = 
// foo {<suspended>}
// __proto__: Generator
// [[GeneratorLocation]]: VM1200:2
// [[GeneratorStatus]]: "suspended"
// [[GeneratorFunction]]: Æ’ *foo(x)
// [[GeneratorReceiver]]: Window
// [[Scopes]]: Scopes[3]

var res = it.next(7);
// è¿”å›å€¼ {value: 42, done: true}
// it = 
// foo {<closed>}
// __proto__: Generator
// [[GeneratorLocation]]: VM1200:1
// [[GeneratorStatus]]: "closed"
// [[GeneratorFunction]]: Æ’ *foo(x)
// [[GeneratorReceiver]]: Window
```
åœ¨ *foo(..) å†…éƒ¨ï¼Œå¼€å§‹æ‰§è¡Œè¯­å¥ `var y = x ...`ï¼Œä½†éšåå°±é‡åˆ°äº†ä¸€ä¸ª yield è¡¨è¾¾å¼ï¼Œå®ƒå°±ä¼šåœ¨è¿™ä¸€ç‚¹ä¸Šæš‚åœ *foo(..)(åœ¨èµ‹å€¼è¯­å¥ä¸­é—´ï¼)ï¼Œå¹¶åœ¨æœ¬è´¨ä¸Šè¦æ±‚è°ƒç”¨ä»£ç ä¸º yield è¡¨è¾¾å¼æä¾›ä¸€ä¸ªç»“æœå€¼ã€‚æ¥ä¸‹æ¥ï¼Œè°ƒç”¨ it.next(7)ï¼Œè¿™ä¸€å¥æŠŠå€¼ 7 ä¼ å›ä½œä¸ºè¢«æš‚åœçš„ yield è¡¨è¾¾å¼çš„ç»“æœã€‚

æ³¨æ„ï¼šyield å’Œ next(..) è°ƒç”¨æœ‰ä¸€ä¸ªä¸åŒ¹é…ã€‚å› ä¸ºç¬¬ä¸€ä¸ª next(..) æ€»æ˜¯å¯åŠ¨ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå¹¶è¿è¡Œåˆ°ç¬¬ä¸€ä¸ª yield å¤„ï¼Œç¬¬äºŒä¸ª next(..) è°ƒç”¨å®Œæˆçš„å“¥è¢«æš‚åœçš„ yield è¡¨è¾¾å¼ï¼Œç¬¬ä¸‰ä¸ª next(..) è°ƒç”¨å®Œæˆç¬¬äºŒä¸ª yieldï¼Œä»¥æ­¤ç±»æ¨ã€‚

æ¶ˆæ¯æ˜¯åŒå‘ä¼ é€’çš„ â€”â€” yield.. ä½œä¸ºä¸€ä¸ªè¡¨è¾¾å¼å¯ä»¥å‘å‡ºæ¶ˆæ¯å“åº” next(..) è°ƒç”¨ï¼Œnext(..) ä¹Ÿå¯ä»¥å‘æš‚åœçš„ yield è¡¨è¾¾å¼å‘é€å€¼ã€‚
```javascript
function *foo(x) {
    var y = x * (yield "hello");  // <-- yield ä¸€ä¸ªå€¼
    return y;
}

var it = foo(6);

it.next();
// è¿”å›å€¼ {value: "hello", done: false}

it.next(7);
// è¿”å›å€¼ {value: 42, done: true}
```
yield .. å’Œ next(..) è¿™ä¸€å¯¹ç»„åˆèµ·æ¥ï¼Œåœ¨ç”Ÿæˆå™¨çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ„æˆäº†ä¸€ä¸ªåŒå‘æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿã€‚

æ³¨æ„ï¼šæ²¡æœ‰å‘ç¬¬ä¸€ä¸ª next(..) è°ƒç”¨å‘é€å€¼ï¼Œè¿™æ˜¯æœ‰æ„ä¸ºä¹‹çš„ã€‚åªæœ‰æš‚åœçš„ yield æ‰èƒ½æ¥å—è¿™æ ·ä¸€ä¸ªé€šè¿‡ next(..) ä¼ é€’çš„å€¼ï¼Œè€Œåœ¨ç”Ÿæˆå™¨çš„èµ·å§‹å¤„æˆ‘ä»¬è°ƒç”¨ç¬¬ä¸€ä¸ª next() æ—¶ï¼Œè¿˜æ²¡æœ‰æš‚åœçš„ yield æ¥æ¥å—è¿™æ ·ä¸€ä¸ªå€¼ã€‚

è§„èŒƒå’Œæ‰€æœ‰å…¼å®¹æµè§ˆå™¨éƒ½ä¼šé»˜é»˜ä¸¢å¼ƒä¼ é€’ç»™ç¬¬ä¸€ä¸ª next() çš„ä»»ä½•ä¸œè¥¿ï¼Œä¼ å€¼è¿‡å»ä»ç„¶ä¸æ˜¯ä¸€ä¸ªå¥½æ€è·¯ï¼Œå› ä¸ºåˆ›å»ºäº†é»˜è®¤çš„æ— æ•ˆä»£ç ï¼Œè¿™ä¼šè®©äººè¿·æƒ‘ï¼Œå› æ­¤å¯åŠ¨ç”Ÿæˆå™¨æ—¶ä¸€å®šè¦ç”¨ä¸å¸¦å‚æ•°çš„ next()ã€‚

### å¤šä¸ªè¿­ä»£å™¨
æ¯æ¬¡æ„å»ºä¸€ä¸ªè¿­ä»£å™¨ï¼Œå®é™…ä¸Šå°±éšå¼æ„å»ºäº†ç”Ÿæˆå™¨çš„ä¸€ä¸ªå®ä¾‹ï¼Œé€šè¿‡è¿™ä¸ªè¿­ä»£å™¨æ¥æ§åˆ¶çš„æ˜¯è¿™ä¸ªç”Ÿæˆå™¨çš„å®ä¾‹ã€‚

åŒä¸€ä¸ªç”Ÿæˆå™¨çš„å¤šä¸ªå®ä¾‹å¯ä»¥åŒæ—¶è¿è¡Œï¼Œä»–ä»¬ç”šè‡³å¯ä»¥å½¼æ­¤äº¤äº’ï¼š
```javascript
function *foo() {
    var x = yield 2;
    z++;
    var y = yield (x * z);
    console.log(x, y, z);
}

var z = 1;

var it1 = foo();
var it2 = foo();

it1.next(); // {value: 2, done: false}
it2.next(); // {value: 2, done: false}

it1.next(20); // {value: 40, done: false}
it2.next(10); // {value: 60, done: false}

it1.next(4); // {value: undefined, done: true}
// 20 4 3
it2.next(2); // {value: undefined, done: true}
// 10 2 3
```
ä½¿ç”¨ç”Ÿæˆå™¨ï¼Œé™¤äº†å‡½æ•°äº¤æ›¿æ‰§è¡Œå¤–ï¼Œåœ¨è¯­å¥å½“ä¸­çš„äº¤æ›¿æ‰§è¡Œä¹Ÿæ˜¯å¯èƒ½çš„ã€‚

é€šè¿‡ä¸¤ä¸ªç”Ÿæˆå™¨åœ¨å…±äº«çš„ç›¸åŒå˜é‡ä¸Šçš„è¿­ä»£äº¤æ›¿æ‰§è¡Œï¼Œæˆ‘ä»¬å¯æŸç§æ¨¡æ‹Ÿçš„æ–¹å¼å°è¯å¤šçº¿ç¨‹ç«æ€æ¡ä»¶ç¯å¢ƒã€‚

æ§åˆ¶è¿­ä»£å™¨çš„è¾…åŠ©å‡½æ•°ï¼š
```javascript
function step(gen) {
    var it = gen();
    var last;

    return function() {
        // ä¸ç®¡ yield å‡ºæ¥çš„æ˜¯ä»€ä¹ˆï¼Œä¸‹ä¸€æ¬¡éƒ½æŠŠå®ƒåŸæ ·ä¼ å›å»
        last = it.next(last),value;
    }
}

var a = 1;
var b = 2;

function *foo() {
    a++;
    yield;
    b = b * a;
    a = (yield b) + 3;
}

function *bar() {
    b--;
    yield;
    a = (yield 8) + b;
    b = a * (yield 2);
}
```


## ç”Ÿæˆå™¨äº§ç”Ÿå€¼
### ç”Ÿäº§è€…ä¸è¿­ä»£å™¨
å¦‚æœè¦äº§ç”Ÿä¸€ç³»åˆ—å€¼ï¼Œå…¶ä¸­æ¯ä¸ªå€¼éƒ½ä¸å‰é¢ä¸€ä¸ªæœ‰ç‰¹å®šçš„å…³ç³»ï¼Œè¦å®ç°è¿™ä¸€ç‚¹ï¼Œéœ€è¦ä¸€ä¸ªæœ‰çŠ¶æ€çš„ç”Ÿäº§è€…èƒ½å¤Ÿè®°ä½å…¶ç”Ÿæˆçš„æœ€åä¸€ä¸ªå€¼ã€‚

å¯ä»¥å®ç°ä¸€ä¸ªç›´æ¥ä½¿ç”¨å‡½æ•°é—­åŒ…çš„ç‰ˆæœ¬ï¼š
```javascript
var gimmeSth = (function() {
    var nextVal;

    return function() {
        if (nextVal === undefined) {
            nextVal = 1;
        } else {
            nextVal = (3*nextVal) + 6;
        }
        return nextVal;
    }
})();

gimmeSth(); // 1
gimmeSth(); // 9
gimmeSth(); // 33
```
è¿­ä»£å™¨æ˜¯ä¸€ä¸ªå®šä¹‰è‰¯å¥½çš„æ¥å£ï¼Œç”¨äºä»ä¸€ä¸ªç”Ÿäº§è€…ä¸€æ­¥æ­¥å¾—åˆ°ä¸€ç³»åˆ—å€¼ã€‚JavaScript è¿­ä»£å™¨çš„æ¥å£ï¼Œå°±æ˜¯æ¯æ¬¡æƒ³è¦ä»ç”Ÿäº§è€…å¾—åˆ°ä¸‹ä¸€ä¸ªå€¼çš„æ—¶å€™è°ƒç”¨ next()ã€‚
```javascript
var something = (function() {
    var nextVal;

    return {
        // for..of å¾ªç¯éœ€è¦
        [Symbol.iterator]: function() { return this },

        // æ ‡å‡†è¿­ä»£å™¨æ–¹æ³•
        next: function() {
            if (nextVal === undefined) {
                nextVal = 1;
            } else {
            nextVal = (3*nextVal) + 6;
            }
            return { done: false, value: nextVal }
        }

    }
})();

something.next().value; // 1
something.next().value; // 9
something.next().value; // 33
```
é¦–å…ˆ `[ .. ]` è¯­æ³•è¢«ç§°ä¸ºè®¡ç®—å±æ€§åï¼Œè¿™åœ¨å¯¹è±¡å®šä¹‰ä¸­æ˜¯æŒ‡ï¼ŒæŒ‡å®šä¸€ä¸ªè¡¨è¾¾å¼å¹¶ç”¨è¿™ä¸ªè¡¨è¾¾å¼çš„ç»“æœä½œä¸ºå±æ€§çš„åç§°ã€‚

å¦å¤–ï¼Œ`Symbol.iterator` æ˜¯ ES6 é¢„å®šä¹‰çš„ç‰¹æ®Š Symbol å€¼ä¹‹ä¸€ã€‚

next() è°ƒç”¨è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æœ‰ä¸¤ä¸ªå±æ€§ï¼šdone æ˜¯ä¸€ä¸ª boolean å€¼ï¼Œæ ‡è¯†è¿­ä»£å™¨çš„å®ŒæˆçŠ¶æ€ï¼Œvalue ä¸­æ”¾ç½®è¿­ä»£å€¼ã€‚

ES6 æ–°å¢äº† `for..of` å¾ªç¯ï¼Œé€šè¿‡åŸç”Ÿå¾ªç¯è¯­æ³•è‡ªåŠ¨è¿­ä»£æ ‡å‡†è¿­ä»£å™¨ã€‚`for..of` å¾ªç¯åœ¨æ¯æ¬¡è¿­ä»£ä¸­è‡ªåŠ¨è°ƒç”¨ next()ï¼Œå®ƒä¸ä¼šå‘ next() ä¼ å…¥ä»»ä½•å€¼ï¼Œå¹¶ä¸”ä¼šåœ¨æ¥æ”¶åˆ° `done:true` ä¹‹åè‡ªåŠ¨åœæ­¢ã€‚è¿™å¯¹äºåœ¨ä¸€ç»„æ•°æ®ä¸Šå¾ªç¯å¾ˆæ–¹ä¾¿ã€‚

é™¤äº†æ„é€ è‡ªå·±çš„è¿­ä»£å™¨ï¼Œä» ES6 å¼€å§‹ï¼Œarray æœ‰é»˜è®¤çš„è¿­ä»£å™¨ã€‚

å¯¹äºä¸€èˆ¬çš„ object æ˜¯æ•…æ„ä¸åƒ array ä¸€æ ·æœ‰é»˜è®¤çš„è¿­ä»£å™¨ã€‚å¦‚æœè¦è¿­ä»£ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§çš„è¯ï¼Œå¯ä»¥é€šè¿‡ Object.keys(..) è¿”å›ä¸€ä¸ª arrayï¼ŒObject.keys(..) å¹¶ä¸åŒ…å«æ¥è‡ª \[\[Prototype]] é“¾ä¸Šçš„å±æ€§ï¼Œè€Œ for..in åˆ™åŒ…å«ã€‚

### iterable
iterable å¯è¿­ä»£å³æŒ‡ä¸€ä¸ªåŒ…å«å¯ä»¥åœ¨å…¶å€¼ä¸Šè¿­ä»£çš„è¿­ä»£å™¨çš„å¯¹è±¡ã€‚

ä» ES6 å¼€å§‹ï¼Œä»ä¸€ä¸ª iterable ä¸­æå–è¿­ä»£å™¨çš„æ–¹å¼æ˜¯ï¼šiterable å¿…é¡»æ”¯æŒä¸€ä¸ªå‡½æ•°ï¼Œå…¶åç§°æ˜¯ä¸“é—¨çš„ ES6 ç¬¦å·å€¼ Symbol.iteratorã€‚è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œé€šå¸¸æ¯æ¬¡è°ƒç”¨ä¼šè¿”å›ä¸€ä¸ªå…¨æ–°çš„è¿­ä»£å™¨(éå¿…é¡»)ã€‚

for..of å¾ªç¯è‡ªåŠ¨è°ƒç”¨ iterable çš„ Symbol.iterator å‡½æ•°æ¥æ„å»ºä¸€ä¸ªè¿­ä»£å™¨ã€‚

### ç”Ÿæˆå™¨è¿­ä»£å™¨
å¯ä»¥æŠŠç”Ÿæˆå™¨çœ‹ä½œæ˜¯ä¸€ä¸ªå€¼çš„ç”Ÿäº§è€…ï¼Œé€šè¿‡è¿­ä»£å™¨æ¥å£çš„ next() è°ƒç”¨ä¸€æ¬¡å–å‡ºä¸€ä¸ªå€¼ã€‚

ä¸¥æ ¼æ¥è¯´ï¼Œç”Ÿæˆå™¨æœ¬èº«å¹¶ä¸æ˜¯ iterableï¼Œå°½ç®¡éå¸¸ç±»ä¼¼ â€”â€” å½“ä½ æ‰§è¡Œä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªè¿­ä»£å™¨ï¼š
```javascript
function *foo() { .. }

var it = foo();
```
å¯ä»¥é€šè¿‡ç”Ÿæˆå™¨å®ç°å‰é¢çš„ something æ— é™æ•°å­—åºåˆ—ç”Ÿäº§è€…ï¼š
```javascript
function *something() {
    var nextVal;

    while (true) {
        if (nextVal === undefined) {
            nextVal = 1;
        } else {
            nextVal = (3 * nextVal) + 6;
        }
        yield nextVal;
    }
}
```
åœ¨å®é™…çš„ JavaScript ç¨‹åºä¸­ä½¿ç”¨ while..true å¾ªç¯éå¸¸ç³Ÿç³•ï¼Œå¦‚æœæ²¡æœ‰ break æˆ– returnï¼Œå› ä¸ºå®ƒæœ‰å¯èƒ½ä¼šåŒæ­¥åœ°æ— é™å¾ªç¯ï¼Œå¹¶é˜»å¡å’Œé”ä½æµè§ˆå™¨ UIã€‚

ä½†æ˜¯ï¼Œå¦‚æœåœ¨ç”Ÿæˆå™¨ä¸­æœ‰ yield çš„è¯ï¼Œä½¿ç”¨è¿™æ ·çš„å¾ªç¯å°±æ²¡æœ‰é—®é¢˜ã€‚å› ä¸ºç”Ÿæˆå™¨ä¼šåœ¨æ¯æ¬¡è¿­ä»£ä¸­æš‚åœï¼Œé€šè¿‡ yield è¿”å›åˆ°ä¸»ç¨‹åºæˆ–äº‹ä»¶å¾ªç¯é˜Ÿåˆ—ä¸­ã€‚

å› ä¸ºç”Ÿæˆå™¨ä¼šåœ¨æ¯ä¸ª yield å¤„æš‚åœï¼Œå‡½æ•° `*something()` çš„çŠ¶æ€(ä½œç”¨åŸŸ)ä¼šè¢«ä¿æŒï¼Œå³æ„å‘³ç€ä¸éœ€è¦é—­åŒ…åœ¨è°ƒç”¨ä¹‹é—´ä¿æŒå˜é‡çŠ¶æ€ã€‚

ç°åœ¨å¯ä»¥é€šè¿‡ for..of å¾ªç¯ä½¿ç”¨ *something() ç”Ÿæˆå™¨ï¼š
```javascript
for (var v of something()) {
    //...
}
```
æ³¨æ„ï¼Œå¹¶ä¸æ˜¯æŠŠ something å½“ä½œä¸€ä¸ªå€¼æ¥å¼•ç”¨ï¼Œè€Œæ˜¯è°ƒç”¨ *something() ç”Ÿæˆå™¨ä»¥å¾—åˆ°å®ƒçš„è¿­ä»£å™¨ä¾› for..of å¾ªç¯ä½¿ç”¨ã€‚

ç”Ÿæˆå™¨çš„è¿­ä»£å™¨ä¹Ÿæ˜¯ä¸€ä¸ª iterableï¼

#### åœæ­¢ç”Ÿæˆå™¨
for..of å¾ªç¯çš„å¼‚å¸¸ç»“æŸ(æå‰ç»ˆæ­¢)ï¼Œé€šå¸¸ç”± breakã€return æˆ–è€…æœªæ•è·å¼‚å¸¸å¼•èµ·ï¼Œä¼šå‘ç”Ÿæˆå™¨çš„è¿­ä»£å™¨å‘é€ä¸€ä¸ªä¿¡å·ä½¿å…¶ç»ˆæ­¢ã€‚

ä¸¥æ ¼åœ°è¯´ï¼Œåœ¨å¾ªç¯æ­£å¸¸ç»“æŸä¹‹åï¼Œfor..of å¾ªç¯ä¹Ÿä¼šå‘è¿­ä»£å™¨å‘é€è¿™ä¸ªä¿¡å·ã€‚å¯¹äºç”Ÿæˆå™¨é‡Œè¯´ï¼Œè¿™æœ¬è´¨ä¸Šæ˜¯æ²¡æœ‰æ„ä¹‰çš„æ“ä½œï¼Œå› ä¸ºç”Ÿæˆå™¨çš„è¿­ä»£å™¨éœ€è¦å…ˆå®Œæˆ for..of å¾ªç¯æ‰èƒ½ç»“æŸã€‚ä½†æ˜¯è‡ªå®šä¹‰çš„è¿­ä»£å™¨å¯èƒ½ä¼šéœ€è¦ä» for..of å¾ªç¯çš„æ¶ˆè´¹è€…é‚£é‡Œæ¥æ”¶åˆ°è¿™ä¸ªé¢å¤–çš„ä¿¡å·ã€‚

å‘ä¸€ä¸ªè¿­ä»£å™¨æ‰‹å·¥å‘é€è¿™ä¸ªä¿¡å·ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ return(..) å®ç°ã€‚

å¦‚æœåœ¨ç”Ÿæˆå™¨å†…æœ‰ try..finally è¯­å¥ï¼Œå®ƒå°†æ€»æ˜¯è¿è¡Œï¼Œå³ä½¿ç”Ÿæˆå™¨å·²ç»å¤–éƒ¨ç»“æŸï¼Œå¦‚æœéœ€è¦æ¸…ç†èµ„æºçš„è¯(æ•°æ®åº“è¿æ¥ç­‰)ï¼Œéå¸¸æœ‰ç”¨ï¼š
```javascript
function *something() {
    try {
        var nextVal;

        while (true) {
            if (nextVal === undefined) {
                nextVal = 1;
            } else {
                nextVal = (3 * nextVal) + 6;
            }
            yield nextVal;
        }
    } finally {
        console.log('cleaning up');
    }
}

// åœ¨ for..of å¾ªç¯å†…çš„ break ä¼šè§¦å‘ finally è¯­å¥ï¼š
for (var v of something()) {
    console.log(v);
    if (v > 30) {
        break;
    }
}
// 1
// 9
// 33
// cleaning up

// ä¹Ÿå¯ä»¥åœ¨å¤–éƒ¨é€šè¿‡è°ƒç”¨ return(..) æ‰‹å·¥ç»ˆæ­¢ç”Ÿæˆå™¨çš„è¿­ä»£å™¨å®ä¾‹ï¼š
var it = something()
for (var v of it) {
    console.log(v);
    if (v > 30) {
        console.log(it.return('hello return').value)
    }
}

// 1
// 9
// 33
// cleaning up
// hello return
```
è°ƒç”¨ it.return(..) ä¹‹åï¼Œå®ƒä¼šç«‹å³ç»ˆæ­¢ç”Ÿæˆå™¨ï¼ŒåŒæ—¶è¿è¡Œ finally è¯­å¥ã€‚å¦å¤–å®ƒè¿˜è¢«æŠŠè¿”å›çš„ value è®¾ç½®ä¸ºä¼ å…¥ return(..) çš„å†…å®¹ï¼Œç°åœ¨ç”Ÿæˆå™¨çš„è¿­ä»£å™¨å·²ç»è¢«è®¾ç½®ä¸º `done:true`ï¼Œæ‰€ä»¥ for..of å¾ªç¯ä¼šåœ¨ä¸‹ä¸€ä¸ªè¿­ä»£ç»ˆæ­¢ã€‚


## å¼‚æ­¥è¿­ä»£ç”Ÿæˆå™¨
é€šè¿‡ç”Ÿæˆå™¨æ¥è¡¨è¾¾å›è°ƒæµç¨‹ï¼š
```javascript
var ajax = jQuery.ajax
var url = 'https://www.tianqiapi.com/api/?version=v1&appid=XXXX&appsecret=$$$$$'

function foo() {
    ajax({
        url,
        success: function(data) {
            it.next(data);
        },
        error: function(err) {
            it.throw(err);
        }
    });
}

function *main() {
    try {
        var text = yield foo();
        console.log(text);
    } catch (err) {
        console.log(err);
    }
}

var it = main();

// å¯åŠ¨
it.next(); // {value: undefined, done: false}
```
åœ¨ `yield foo()` ä¸­ï¼Œé¦–å…ˆè°ƒç”¨ foo(..)ï¼Œå®ƒæ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å‘å‡ºäº†ä¸€ä¸ªè°ƒç”¨æ¥è¯·æ±‚æ•°æ®ï¼Œä½†å®é™…ä¸Šä¹‹ååšçš„æ˜¯ `yield undefined`ã€‚å› ä¸ºè¿™æ®µä»£ç å½“å‰å¹¶ä¸ä¾èµ– yield å‡ºæ¥çš„å€¼åšä»»ä½•äº‹æƒ…ã€‚

è¿™é‡Œå¹¶ä¸æ˜¯åœ¨æ¶ˆæ¯ä¼ é€’çš„æ„ä¹‰ä¸Šä½¿ç”¨ yieldï¼Œè€Œåªæ˜¯å°†å…¶ç”¨äºæµç¨‹æ§åˆ¶å®ç°æš‚åœ/é˜»å¡ã€‚å®é™…ä¸Šï¼Œå®ƒè¿˜æ˜¯ä¼šæœ‰æ¶ˆæ¯ä¼ é€’ï¼Œä½†åªæ˜¯åœ¨æ˜¯åœ¨ç”Ÿæˆå™¨æ¢å¤è¿è¡Œä¹‹åçš„å•å‘æ¶ˆæ¯ä¼ é€’ã€‚

å¦‚æœ Ajax è¯·æ±‚æˆåŠŸï¼Œè°ƒç”¨ `it.next(data)`ï¼Œè¿™ä¼šç”¨å“åº”æ•°æ®æ¢å¤ç”Ÿæˆå™¨ï¼Œæ„å‘³ç€æˆ‘ä»¬æš‚åœçš„ yield è¡¨è¾¾å¼ç›´æ¥æ¥æ”¶åˆ°äº†è¿™ä¸ªå€¼ã€‚ç„¶åéšç€ç”Ÿæˆå™¨ä»£ç ç»§ç»­è¿è¡Œï¼Œè¿™ä¸ªå€¼è¢«èµ‹ç»™å±€éƒ¨å˜é‡ textã€‚

ä»æœ¬è´¨ä¸Šè€Œè¨€ï¼Œæˆ‘ä»¬æŠŠå¼‚æ­¥ä½œä¸ºå®ç°ç»†èŠ‚æŠ½è±¡äº†å‡ºå»ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ä»¥åŒæ­¥é¡ºåºçš„å½¢å¼è¿½è¸ªæµç¨‹æ§åˆ¶ã€‚


## åŒæ­¥é”™è¯¯å¤„ç†
ç”Ÿæˆå™¨ yield æš‚åœçš„ç‰¹æ€§æ„å‘³ç€ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½å¤Ÿä»å¼‚æ­¥å‡½æ•°è°ƒç”¨å¾—åˆ°çœ‹ä¼¼åŒæ­¥çš„è¿”å›å€¼ï¼Œè¿˜å¯ä»¥åŒæ­¥æ•è·æ¥è‡ªè¿™äº›å¼‚æ­¥å‡½æ•°è°ƒç”¨çš„é”™è¯¯ã€‚

åœ¨å¼‚æ­¥ä»£ç ä¸­å®ç°çœ‹ä¼¼åŒæ­¥çš„é”™è¯¯å¤„ç†(é€šè¿‡ try..catch)åœ¨å¯è¯»æ€§å’Œåˆç†æ€§æ–¹é¢éƒ½æ˜¯ä¸€ä¸ªå·¨å¤§çš„è¿›æ­¥ã€‚


## ç”Ÿæˆå™¨ + Promise
ES6 ä¸­æœ€å®Œç¾çš„ä¸–ç•Œå°±æ˜¯ç”Ÿæˆå™¨(çœ‹ä¼¼åŒæ­¥çš„å¼‚æ­¥ä»£ç )å’Œ Promise (å¯ä¿¡ä»»å¯ç»„åˆ)çš„ç»“åˆã€‚

å¯ä»¥é€šè¿‡ foo(..) æ„é€ ä¸€ä¸ª promiseï¼Œç„¶åé€šè¿‡ç”Ÿæˆå™¨æŠŠå®ƒ yield å‡ºæ¥ï¼Œç„¶åè¿­ä»£å™¨æ§åˆ¶ä»£ç å°±å¯ä»¥æ¥æ”¶åˆ°è¿™ä¸ª promise äº†ã€‚

è¿­ä»£å™¨åº”è¯¥ä¾¦å¬è¿™ä¸ª promise çš„å†³è®®(å®Œæˆæˆ–æ‹’ç»)ï¼Œç„¶åè¦ä¹ˆä½¿ç”¨å®Œæˆæ¶ˆæ¯æ¢å¤ç”Ÿæˆå™¨è¿è¡Œï¼Œè¦ä¹ˆå‘ç”Ÿæˆå™¨æŠ›å‡ºä¸€ä¸ªå¸¦æœ‰æ‹’ç»åŸå› çš„é”™è¯¯ã€‚

ğŸŒ¿è·å¾— Promise å’Œç”Ÿæˆå™¨æœ€å¤§æ•ˆç”¨çš„æœ€è‡ªç„¶çš„æ–¹æ³•å°±æ˜¯ yield å‡ºæ¥ä¸€ä¸ª Promiseï¼Œç„¶åé€šè¿‡è¿™ä¸ª Promise æ¥æ§åˆ¶ç”Ÿæˆå™¨çš„è¿­ä»£å™¨ã€‚

```javascript
function foo(x, y) {
    return request(
        'http://some.url/?x=' + x + '&y=' + y
    );
}

function *main() {
    try {
        var text = yield foo(11, 31);
        console.log(text);
    } catch (err) {
        console.log(err);
    }
}
```
åœ¨ç”Ÿæˆå™¨å†…éƒ¨ï¼Œä¸ç®¡ä»€ä¹ˆå€¼ yield å‡ºæ¥ï¼Œéƒ½åªæ˜¯ä¸€ä¸ªé€æ˜çš„å®ç°ç»†èŠ‚ã€‚æ‰‹å·¥å®ç°æ¥æ”¶å’Œè¿æ¥ yield å‡ºæ¥çš„ promiseï¼Œä½¿å®ƒèƒ½å¤Ÿåœ¨å†³è®®ä¹‹åæ¢å¤ç”Ÿæˆå™¨ï¼š
```javascript
var it = main();

var p = it.next().value;

// ç­‰å¾… promise å†³è®®
p.then(
    function(text) {
        it.next(text);
    },
    function(err) {
        it.throw(err);
    }
)
```
æ‰‹å·¥ç»„åˆçš„æ–¹å¼ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬åˆ©ç”¨äº†å·²çŸ¥ *main() ä¸­åªæœ‰ä¸€ä¸ªéœ€è¦æ”¯æŒ Promise çš„æ­¥éª¤è¿™ä¸€äº‹å®ã€‚

å¦‚æœæƒ³è¦èƒ½å¤Ÿå®ç° Promise é©±åŠ¨çš„ç”Ÿæˆå™¨ï¼Œä¸ç®¡å…¶å†…éƒ¨æœ‰å¤šå°‘ä¸ªæ­¥éª¤å‘¢ï¼Ÿ

### æ”¯æŒ Promsie çš„ Generator Runner
æˆ‘ä»¬å½“ç„¶ä¸å¸Œæœ›ä¸ºæ¯ä¸ªä½¿ç”¨ç”Ÿæˆå™¨çš„ä»£ç éƒ½é‡å¤æ‰‹å·¥ç¼–å†™ä¸åŒçš„ Promise é“¾ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯å€ŸåŠ©è¾…åŠ©å‡½æ•°æ¥å®Œæˆï¼š
```javascript
// @benjamingr on GitHub
function run(gen) {
    var args = [].slice.call(arguments, 1), it;

    // åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­åˆå§‹åŒ–ç”Ÿæˆå™¨
    it = gen.apply(this, args);

    // è¿”å›ä¸€ä¸ª promise ç”¨äºç”Ÿæˆå™¨å®Œæˆ
    return Promise.resolve()
        .then(function handleNext(value) {
            // å¯¹ä¸‹ä¸€ä¸ª yield å‡ºçš„å€¼è¿è¡Œ
            var next = it.next(value);

            return (function handleResult(next) {
                // ç”Ÿæˆå™¨è¿è¡Œæ˜¯å¦å®Œæ¯•
                if (next.done) {
                    return next.value;
                } else {
                    // å¦åˆ™ç»§ç»­è¿è¡Œ
                    return Promise.resolve(next.value)
                        .then(
                            // æˆåŠŸå°±æ¢å¤å¼‚æ­¥å¾ªç¯ï¼ŒæŠŠå†³è®®çš„å€¼å‘å›ç»™ç”Ÿæˆå™¨
                            handleNext,
                            // å¦‚æœ value æ˜¯è¢«æ‹’ç»çš„ promise
                            // å°±æŠŠé”™è¯¯ä¼ å›ç”Ÿæˆå™¨è¿›è¡Œå‡ºé”™å¤„ç†
                            function handleErr(err) {
                                return Promise.resolve(
                                    it.throw(err)
                                ).then(handleResult)
                            }
                        )
                }
            })(next);
        });
}
```
`[].slice.call()` å¸¸ç”¨æ¥å°†ç±»æ•°ç»„è½¬åŒ–ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚call() æ˜¯æ‰€æœ‰å‡½æ•°éƒ½å…·å¤‡çš„æ–¹æ³•ï¼Œå…¶ä½œç”¨æœ‰ä¸¤ä¸ªï¼Œå³è°ƒç”¨å‡½æ•°å¹¶æ”¹å˜å‡½æ•°å†…éƒ¨thisæŒ‡å‘ã€‚

ç”Ÿæˆå™¨ yield å‡º Promiseï¼Œç„¶åå…¶æ§åˆ¶ç”Ÿæˆå™¨çš„è¿­ä»£å™¨æ¥æ‰§è¡Œå®ƒï¼Œç›´åˆ°ç»“æŸã€‚
```javascript
function foo(x, y) {
    return new Promise(function(resolve, reject) {
        setTimeout(function() {
            resolve(x * y);
        }, 500);
    })
}

async function main() {
    try {
        var text = await foo(11, 31);
        console.log(text);
    } catch (err) {
        console.error(err);
    }
}

main();
console.log('start')
// start
// 341
```
main() ä¹Ÿä¸å†è¢«å£°æ˜ä¸ºç”Ÿæˆå™¨å‡½æ•°ï¼Œå®ƒç°åœ¨æ˜¯æ–°ä¸€ç±»å‡½æ•°ï¼šasync å‡½æ•°ï¼›ä¸å† yield å‡º Promiseï¼Œè€Œæ˜¯ç”¨ await ç­‰å¾…å®ƒçš„å†³è®®ã€‚

å¦‚æœ await äº†ä¸€ä¸ª Promiseï¼Œasync å‡½æ•°å°±ä¼šè‡ªåŠ¨è·çŸ¥è¦åšä»€ä¹ˆï¼Œå®ƒä¼šæš‚åœè¿™ä¸ªå‡½æ•°(å°±åƒç”Ÿæˆå™¨ä¸€æ ·)ï¼Œç›´åˆ° Promise å†³è®®ã€‚


## ç”Ÿæˆå™¨ä¸­çš„ Promise å¹¶å‘
è®©å¼‚æ­¥æµç¨‹åŸºäº Promiseï¼Œç‰¹åˆ«æ˜¯åŸºäºå®ƒä»¬ä»¥æ—¶é—´æ— å…³çš„æ–¹å¼ç®¡ç†çŠ¶æ€çš„èƒ½åŠ›ï¼š
```javascript
function *foo() {
    // è®©ä¸¤ä¸ªè¯·æ±‚å¹¶è¡Œ
    var p1 = request('http://some.url.1');
    var p2 = request('http://some.url.2');

    // ç­‰å¾…ä¸¤ä¸ª promise éƒ½å†³è®®
    var r1 = yield p1;
    var r2 = yield p2;

    var r3 = yield request(
        'http://some.url.3/?v=' + r1 + ',' + r2
    )

    console.log(r3);
}

run(foo);

// ç­‰æ•ˆäº Promise.all([ .. ])
function *foo() {
    // è®©ä¸¤ä¸ªè¯·æ±‚å¹¶è¡Œï¼Œå¹¶ç­‰å¾…ä¸¤ä¸ª promise éƒ½å†³è®®
    var results = yield Promise.all([
        request('http://some.url.1'),
        request('http://some.url.2')
    ])
    // æˆ–è€…è§£æ„èµ‹å€¼
    // var [r1, r2] = yield Promise.all([
    //     request('http://some.url.1'),
    //     request('http://some.url.2')
    // ])

    var r1 = results[0];
    var r2 = results[1];

    var r3 = yield request(
        'http://some.url.3/?v=' + r1 + ',' + r2
    )

    console.log(r3);
}
```
Promise æ‰€æœ‰çš„å¹¶å‘èƒ½åŠ›åœ¨ç”Ÿæˆå™¨ + Promise æ–¹æ³•ä¸­éƒ½å¯ä»¥ä½¿ç”¨ã€‚

è¦æ³¨æ„åœ¨ç”Ÿæˆå™¨å†…éƒ¨åŒ…å«äº†å¤šå°‘ Promise é€»è¾‘ï¼Œä½¿ç”¨ç”Ÿæˆå™¨å®ç°å¼‚æ­¥çš„æ–¹æ³•çš„å…¨éƒ¨è¦ç‚¹åœ¨äºåˆ›å»ºç®€å•ã€é¡ºåºã€çœ‹ä¼¼åŒæ­¥çš„ä»£ç ï¼Œå°†å¼‚æ­¥çš„ç»†èŠ‚å°½å¯èƒ½éšè—èµ·æ¥ã€‚
```javascript
function bar(url1, url2) {
    return Promise.all([
        request(url1),
        request(url2)
    ])
}

function *foo() {
    // éšè— bar(..) å†…éƒ¨åŸºäº Promise çš„å¹¶å‘ç»†èŠ‚
    var results = yield bar(
        'http://some.url.1',
        'http://some.url.2'
    )

    var r1 = results[0];
    var r2 = results[1];

    var r3 = yield request(
        'http://some.url.3/?v=' + r1 + ',' + r2
    )

    console.log(r3);
}
```
åœ¨ *foo() å†…éƒ¨ï¼Œæˆ‘ä»¬æ‰€åšçš„ä¸€åˆ‡å°±æ˜¯è¦æ±‚ bar(..) ç»™æˆ‘ä¸€äº› resultsï¼Œå¹¶é€šè¿‡ yield æ¥ç­‰å¾…ç»“æœï¼Œè¿™æ ·æ›´ç®€æ´ä¹Ÿæ›´æ¸…æ™°ã€‚

æˆ‘ä»¬æŠŠå¼‚æ­¥ï¼Œå®é™…ä¸Šæ˜¯ Promiseï¼Œä½œä¸ºä¸€ä¸ªå®ç°ç»†èŠ‚æ¥çœ‹å¾…ã€‚

è¦æƒ³å®ç°ä¸€ç³»åˆ—é«˜çº§æµç¨‹æ§åˆ¶ï¼Œå°±éœ€è¦æŠŠä½ çš„ Promise é€»è¾‘éšè—åœ¨ä¸€ä¸ªåªä»ç”Ÿæˆå™¨ä»£ç ä¸­è°ƒç”¨çš„å‡½æ•°å†…éƒ¨ã€‚

åˆ›å»ºä»£ç é™¤äº†è¦å®ç°åŠŸèƒ½å’Œä¿æŒæ€§èƒ½ä¹‹å¤–ï¼Œè¿˜åº”è¯¥å°½å¯èƒ½ä½¿ä»£ç æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚


## ç”Ÿæˆå™¨å§”æ‰˜
ç”¨æ™®é€šå‡½æ•°å®ç°è¿™ä¸ªé—®é¢˜çš„ä¸»è¦ç¼ºç‚¹æ˜¯å®ƒå¿…é¡»éµå¾ªæ™®é€šå‡½æ•°çš„è§„åˆ™ï¼Œä¹Ÿå°±æ„å‘³ç€å®ƒä¸èƒ½åƒç”Ÿæˆå™¨ä¸€æ ·ç”¨ yield æš‚åœè‡ªå·±ã€‚

ä» *bar() è°ƒç”¨ *foo()ï¼Œç§°ä¸º yield å§”æ‰˜ã€‚yield å§”æ‰˜çš„å…·ä½“è¯­æ³•æ˜¯ï¼š`yield * __`ã€‚
```javascript
function *foo() {
    console.log("*foo() starting");
    yield 3;
    yield 4;
    console.log("*foo() finished");
}
function *bar() {
    yield 1;
    yield 2;
    yield *foo(); // yield å§”æ‰˜
    yield 5;
}

var it = bar();
console.log(it.next().value); // 1
console.log(it.next().value); // 2
console.log(it.next().value); // *foo() starting
                              // 3
console.log(it.next().value); // 4
console.log(it.next().value); // *foo() finished
                              // 5
```
yield \*foo() å§”æ‰˜å·¥ä½œæµç¨‹ï¼šè°ƒç”¨ foo() åˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨ï¼Œç„¶å yield * æŠŠè¿­ä»£å™¨å®ä¾‹æ§åˆ¶(å½“å‰ *bar() ç”Ÿæˆå™¨çš„)å§”æ‰˜ç»™/è½¬ç§»åˆ°äº†å¦ä¸€ä¸ª \*foo() è¿­ä»£å™¨ã€‚

å‰ä¸¤ä¸ª it.next() è°ƒç”¨æ§åˆ¶çš„æ˜¯ \*bar()ï¼Œä½†æ˜¯å½“å‘å‡ºç¬¬ä¸‰ä¸ª it.next() è°ƒç”¨æ—¶ï¼Œ\*foo() å¯åŠ¨ï¼Œæˆ‘ä»¬ç°åœ¨æ§åˆ¶çš„æ˜¯ \*foo()ï¼Œè€Œä¸æ˜¯ \*bar()ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™è¢«ç§°ä¸ºå§”æ‰˜ï¼š\*bar() æŠŠè‡ªå·±çš„è¿­ä»£æ§åˆ¶å§”æ‰˜ç»™äº† \*foo()ã€‚

ä¸€æ—¦ it è¿­ä»£å™¨æ§åˆ¶æ¶ˆè€—äº†æ•´ä¸ª *foo() è¿­ä»£å™¨ï¼Œit å°±ä¼šè‡ªåŠ¨è½¬å›æ§åˆ¶ *bar()ã€‚

yield * æš‚åœäº†è¿­ä»£æ§åˆ¶ï¼Œè€Œä¸æ˜¯ç”Ÿæˆå™¨æ§åˆ¶ã€‚å½“è°ƒç”¨ *foo() ç”Ÿæˆå™¨æ—¶ï¼Œç°åœ¨ yield å§”æ‰˜åˆ°äº†å®ƒçš„è¿­ä»£å™¨ã€‚å®é™…ä¸Šï¼Œå¯ä»¥ yield å§”æ‰˜åˆ°ä»»æ„ iterableï¼Œ`yield *[1,2,3]` ä¼šæ¶ˆè€—æ•°ç»„å€¼ `[1,2,3]` çš„é»˜è®¤è¿­ä»£å™¨ã€‚

### ä¸ºä»€ä¹ˆç”¨å§”æ‰˜
yield å§”æ‰˜çš„ä¸»è¦ç›®çš„æ˜¯ä»£ç ç»„ç»‡ï¼Œä»¥è¾¾åˆ°ä¸æ™®é€šå‡½æ•°è°ƒç”¨çš„å¯¹ç§°ã€‚

yield * æ˜¯ä¸€ä¸ªè¯­æ³•ä¸Šçš„ç¼©å†™ï¼Œç”¨äºä»£æ›¿æ‰‹å·¥åœ¨ *foo() çš„æ­¥éª¤ä¸Šè¿­ä»£ï¼Œä¸è¿‡æ˜¯åœ¨ *bar() å†…éƒ¨ã€‚

### æ¶ˆæ¯å§”æ‰˜
yield å§”æ‰˜ä¸åªç”¨äºè¿­ä»£å™¨æ§åˆ¶å·¥ä½œï¼Œä¹Ÿç”¨äºåŒå‘æ¶ˆæ¯ä¼ é€’å·¥ä½œã€‚
```javascript
function *foo() {
    console.log('inside *foo():', yield 'B');

    console.log('inside *foo():', yield 'C');

    return 'D';
}

function *bar() {
    console.log('inside *bar():', yield 'A');

    console.log('inside *bar():', yield *foo());

    console.log('inside *bar():', yield 'E');

    return 'F';
}

var it = bar();
console.log('outside:', it.next().value);
// outside:A
console.log('outside:', it.next(1).value);
// inside *bar():1
// outside:B
console.log('outside:', it.next(2).value);
// inside *foo():2
// outsideLC
console.log('outside:', it.next(3).value);
// inside *foo():3
// inside *bar():D
// outside:E
console.log('outside:', it.next(4).value);
// inside *bar():4
// outside:F
```
ä»å¤–å±‚è¿­ä»£å™¨ it è§’åº¦æ¥è¯´ï¼Œæ˜¯æ§åˆ¶æœ€å¼€å§‹çš„ç”Ÿæˆå™¨è¿˜æ˜¯æ§åˆ¶å§”æ‰˜çš„é‚£ä¸ªç”Ÿæˆå™¨ï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚

yield å§”æ‰˜ç”šè‡³å¹¶ä¸è¦æ±‚å¿…é¡»è½¬åˆ°å¦ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå®ƒå¯ä»¥è½¬åˆ°ä¸€ä¸ªéç”Ÿæˆå™¨çš„ä¸€èˆ¬ iterableã€‚

é»˜è®¤çš„æ•°ç»„è¿­ä»£å™¨å¹¶ä¸å…³å¿ƒé€šè¿‡ next(..) è°ƒç”¨å‘é€çš„ä»»ä½•æ¶ˆæ¯ã€‚

å’Œ yield å§”æ‰˜é€æ˜åœ°åŒå‘ä¼ é€’æ¶ˆæ¯çš„æ–¹å¼ä¸€æ ·ï¼Œé”™è¯¯å’Œå¼‚å¸¸ä¹Ÿæ˜¯åŒå‘ä¼ é€’çš„ã€‚

### å¼‚æ­¥å§”æ‰˜

### é€’å½’å§”æ‰˜
yield å§”æ‰˜å¯ä»¥è·Ÿè¸ªä»»æ„å¤šå§”æ‰˜æ­¥éª¤ï¼Œåªè¦æŠŠå®ƒä»¬è¿åœ¨ä¸€èµ·ï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨ yield å§”æ‰˜å®ç°å¼‚æ­¥çš„ç”Ÿæˆå™¨é€’å½’ï¼Œå³ä¸€ä¸ª yield å§”æ‰˜åˆ°å®ƒè‡ªèº«çš„ç”Ÿæˆå™¨ï¼š
```javascript
function *foo(val) {
    if (val > 1) {
        // ç”Ÿæˆå™¨é€’å½’
        val = yield *foo(val - 1);
    }
    return yield request('http://some.url/?v=' + val);
}

function *bar() {
    var r1 = yield *foo(3);
    console.log(r1);
}

run(bar);
```


## ç”Ÿæˆå™¨å¹¶å‘
ä½¿ç”¨å¤šä¸ªå¹¶å‘ç”Ÿæˆå™¨ï¼š
```javascript
var res = []

function *reqData(url) {
    res.push(
        yield request(url)
    )
}

var it1 = reqData('http://some.url.1')
var it2 = reqData('http://some.url.2')

var p1 = it1.next();
var p2 = it2.next();

p1.then(function(data) {
    it1.next(data);
    return p2;
}).then(function(data) {
    it2.next(data);
})
```
*reqData(..) çš„ä¸¤ä¸ªå®ä¾‹éƒ½è¢«å¯åŠ¨æ¥å‘é€å®ƒä»¬çš„ ajax è¯·æ±‚ï¼Œç„¶åé€šè¿‡ yield æš‚åœï¼Œç„¶åæˆ‘ä»¬é€‰æ‹©åœ¨ p1 å†³è®®æ—¶æ¢å¤ç¬¬ä¸€ä¸ªå®ä¾‹ï¼Œç„¶ååœ¨ p2 å†³è®®æ—¶æ¢å¤ç¬¬äºŒä¸ªå®ä¾‹ã€‚é€šè¿‡è¿™ç§æ–¹å¼ç¡®ä¿ res\[0] ä¸­ä¼šæ”¾ç½®ç¬¬ä¸€ä¸ªå“åº”ï¼Œè€Œ res\[1] ä¸­ä¼šæ”¾ç½®ç¬¬äºŒä¸ªå“åº”ã€‚

è®©ç”Ÿæˆå™¨æ¥åè°ƒï¼š
```javascript
var res = []

function *reqData(url) {
    var data =  yield request(url);

    // æ§åˆ¶è½¬ç§»
    yield;

    res.push(data)
}

var it1 = reqData('http://some.url.1')
var it2 = reqData('http://some.url.2')

var p1 = it1.next();
var p2 = it2.next();

p1.then(function(data) {
    it1.next(data);
})
p2.then(function(data) {
    it2.next(data);
})

Promise.all([p1, p2])
.then(function() {
    it1.next();
    it2.next();
})
```
*reqData(..) çš„ä¸¤ä¸ªå®ä¾‹ç°åœ¨ç¡®å®æ˜¯å¹¶å‘è¿è¡Œäº†ï¼Œè€Œä¸”æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œéƒ½æ˜¯å„è‡ªçš„å“åº”ä¸€å›æ¥å°±å–å¾—äº†æ•°æ®ï¼Œç„¶åæ¯ä¸ªå®ä¾‹å†æ¬¡ yieldï¼Œç”¨äºæ§åˆ¶ä¼ é€’çš„ç›®çš„ã€‚ç„¶åæˆ‘ä»¬åœ¨ Promise.all(\[..]) å¤„ç†å‡½æ•°ä¸­é€‰æ‹©å®ƒä»¬çš„æ¢å¤é¡ºåºã€‚


## å½¢å®è½¬æ¢ç¨‹åº thunk
ç›®å‰ä½ç½®ï¼Œæˆ‘ä»¬å·²ç»å‡å®šä»ç”Ÿæˆå™¨å‡ºä¸€ä¸ª Promiseï¼Œå¹¶ä¸”è®©è¿™ä¸ª Promise é€šè¿‡ä¸€ä¸ªåƒ run(..) è¿™æ ·çš„è¾…åŠ©å‡½æ•°æ¢å¤è¿™ä¸ªç”Ÿæˆå™¨ï¼Œè¿™æ˜¯é€šè¿‡ç”Ÿæˆå™¨ç®¡ç†å¼‚æ­¥çš„æœ€å¥½æ–¹å¼ã€‚

JavaScript ä¸­çš„ thunk æ˜¯æŒ‡ä¸€ä¸ªç”¨äºè°ƒç”¨å¦å¤–ä¸€ä¸ªå‡½æ•°çš„å‡½æ•°ï¼Œæ²¡æœ‰ä»»ä½•å‚æ•°ã€‚ç”¨ä¸€ä¸ªå‡½æ•°å®šä¹‰å°è£…å‡½æ•°è°ƒç”¨ï¼ŒåŒ…æ‹¬éœ€è¦çš„ä»»ä½•å‚æ•°ï¼Œæ¥å®šä¹‰è¿™ä¸ªè°ƒç”¨çš„æ‰§è¡Œï¼Œé‚£ä¹ˆè¿™ä¸ªå°è£…å‡½æ•°å°±æ˜¯ä¸€ä¸ªå½¢å®è½¬æ¢ç¨‹åºã€‚
```javascript
function thunkify(fn) {
    var args = [].slice.call(arguments, 1);
    return function(cb) {
        args.push(cb);
        return fn.apply(null, args);
    }
}
```
å°†éœ€è¦çš„å›è°ƒå‡½æ•°æ”¾åœ¨æœ€åçš„ä½ç½®ï¼Œè¿™ç§ç§°ä¸ºâ€œcallback-lastâ€é£æ ¼ã€‚
```javascript
function thunkify(fn) {
    return function() {
        var args = [].slice.call(arguments);
        return function(cb) {
            args.push(cb);
            return fn.apply(null, args);
        }
    }
}
```


## ES6 ä¹‹å‰çš„ç”Ÿæˆå™¨
### æ‰‹å·¥å˜æ¢
```javascript
// ç”Ÿæˆå™¨è¯­æ³•
function *foo(url) {
    try {
        var val = yield request(url);
    } catch (err) {
        console.log('Oops:', err);
    }
}
```
ç”Ÿæˆå™¨é€šè¿‡æš‚åœè‡ªå·±çš„ä½œç”¨åŸŸ/çŠ¶æ€å®ç°ï¼Œå¯ä»¥é€šè¿‡å‡½æ•°é—­åŒ…æ¥æ¨¡æ‹Ÿï¼š
```javascript
function *foo(url) {
    // çŠ¶æ€ 1

    try {
        var TMP1 = request(url);

        // çŠ¶æ€2
        var val = yield TMP1;
    } catch (err) {
        // çŠ¶æ€3
        console.log('Oops:', err);
    }
}
```
å¦‚ä¸Šæ‰€ç¤ºï¼Œ1 æ˜¯èµ·å§‹çŠ¶æ€ï¼Œ2 æ˜¯ request(..) æˆåŠŸåçš„çŠ¶æ€ï¼Œ3 æ˜¯ request(..) å¤±è´¥çš„çŠ¶æ€ã€‚

å› æ­¤ï¼Œç¿»è¯‘ç”Ÿæˆå™¨ï¼Œé¦–å…ˆåœ¨é—­åŒ…ä¸­å®šä¹‰ä¸€ä¸ªå˜é‡ state ç”¨äºè·Ÿè¸ªçŠ¶æ€ï¼Œå®šä¹‰å†…å±‚å‡½æ•° process(..)ï¼Œä½¿ç”¨ switch è¯­å¥å¤„ç†æ¯ä¸ªçŠ¶æ€ï¼š
```javascript
function foo(url) {
    // ç®¡ç†ç”Ÿæˆå™¨çŠ¶æ€
    var state;

    // ç”Ÿæˆå™¨èŒƒå›´å˜é‡å£°æ˜
    var val;

    function process(v) {
        switch(state) {
            case 1:
                return request(url);
            case 2:
                val = v;
                console.log(val);
                return;
            case 3:
                var err = v;
                console.log('Oops', err)
                break;
        }
    }

    // æ„é€ å¹¶è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨
    return {
        next: function(v) {
            // åˆå§‹çŠ¶æ€
            if (!state) {
                state = 1;
                return {
                    done: false,
                    value: process()
                };
            } else if (state == 1) {
                // yield æˆåŠŸæ¢å¤
                state = 2;
                return {
                    done: false,
                    value: process(v);
                }
            } else {
                return {
                    done: true,
                    value: undefined
                }
            }
        },
        'throw': function(e) {
            // å”¯ä¸€çš„æ˜¾å¼é”™è¯¯å¤„ç†åœ¨çŠ¶æ€1
            if (state == 1) {
                state = 3;
                return {
                    done: true,
                    value: process(e)
                } else {
                    throw e;
                }
            }
        }
    }
}
```

### è‡ªåŠ¨è½¬æ¢


## æ€»ç»“
ç”Ÿæˆå™¨æ˜¯ ES6 çš„ä¸€ä¸ªæ–°çš„å‡½æ•°ç±»å‹ï¼Œç”Ÿæˆå™¨å¯ä»¥åœ¨è¿è¡Œå½“ä¸­å®Œå…¨ä¿æŒå…¶çŠ¶æ€æš‚åœï¼Œå¹¶ä¸”å°†æ¥å†ä»æš‚åœçš„åœ°æ–¹æ¢å¤è¿è¡Œã€‚

è¿™ç§äº¤æ›¿çš„æš‚åœå’Œæ¢å¤æ˜¯åˆä½œæ€§çš„è€Œä¸æ˜¯æŠ¢å å¼çš„ã€‚

yield/next(..) è¿™ä¸€å¯¹ä¸åªæ˜¯ä¸€ç§æ§åˆ¶æœºåˆ¶ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ç§åŒå‘æ¶ˆæ¯ä¼ é€’æœºåˆ¶ã€‚yield .. è¡¨è¾¾å¼æœ¬è´¨ä¸Šæ˜¯æš‚åœä¸‹æ¥ç­‰å¾…æŸä¸ªå€¼ï¼Œæ¥ä¸‹æ¥çš„ next(..) è°ƒç”¨ä¼šå‘è¢«æš‚åœçš„ yield è¡¨è¾¾å¼ä¼ å›ä¸€ä¸ªå€¼ï¼Œæˆ–è€…æ˜¯éšå¼çš„ undefinedã€‚

ç”Ÿæˆå™¨çš„å…³é”®ä¼˜ç‚¹æ˜¯ï¼šç”Ÿæˆå™¨å†…éƒ¨çš„ä»£ç æ˜¯ä»¥è‡ªç„¶çš„åŒæ­¥/é¡ºåºæ–¹å¼è¡¨è¾¾ä»»åŠ¡çš„ä¸€ç³»åˆ—æ­¥éª¤ã€‚å…¶æŠ€å·§åœ¨äºï¼Œæˆ‘ä»¬æŠŠå¯èƒ½çš„å¼‚æ­¥éšè—åœ¨äº†å…³é”®å­— yield çš„åé¢ï¼ŒæŠŠå¼‚æ­¥ç§»åŠ¨åˆ°æ§åˆ¶ç”Ÿæˆå™¨çš„è¿­ä»£å™¨çš„ä»£ç éƒ¨åˆ†ã€‚

ç”Ÿæˆå™¨ä¸ºå¼‚æ­¥ä»£ç ä¿æŒäº†é¡ºåºã€åŒæ­¥ã€é˜»å¡çš„ä»£ç æ¨¡å¼ã€‚


## å‚è€ƒ
[1] Kyle Simpson. You Don't Know JS