---
title: 基于Node.js的聊天室程序
date: 2019-04-08 15:20:00
tags:
categories:
- JavaScript
---

## 程序需求
构建一个在线聊天程序，需要实现：
- 用户可以在表单中输入消息；
- 消息输入后发送给同一个聊天室内的其他所有用户；
- 进入聊天室时，程序会自动给用户分配一个昵称；
- 用户可以通过聊天命令修改昵称：/nick xxx；
- 用户可以输入命令创建新的聊天室(或加入已有的聊天室)：/join xxx；
- 在加入或创建聊天室时，新聊天室的名称出现在聊天程序的顶端的水平条上，也会出现在聊天消息区域右侧的可用房间列表中；

## 技术分析
为了提供静态文件(HTML、CSS 和客户端 JavaScript)，需要使用 Node 内置的 http 模块。通过 HTTP 提供文件时，通常不能只是发送文件中的内容，还应该有发送文件的类型，要用正确的 MIME 类型设置 HTTP 头的 Content-Type。

为了处理与聊天相关的消息，一般地，获取聊天消息需要用 Ajax 轮询服务器，但是用 Ajax 发送消息，使用 HTTP 作为传输机制，而 HTTP 本来就不是做实时通信的。在用 HTTP 发送消息时，必须用一个新的 TCP/IP 连接；打开和关闭连接需要时间；每次请求时都要发送 HTTP 头，导致传输的数据量比较大。故采用了 WebSocket，这是一个为支持实时通讯而设计的轻量的双向通信协议。

因为在大多数情况下，只有兼容 HTML5 的浏览器才支持 WebSocket，所以使用 Socket.IO 库给不能使用 WebSocket 的浏览器提供了一些后备措施。

### Node 同时处理 HTTP 和 WebSocket 服务
在用户访问聊天程序网站时发生 HTTP 数据请求与响应；在用户聊天时持续发生 WebSocket 数据发送与接受。

### 创建程序的文件结构
```javascript
|- lib           //存放服务器端逻辑
|- static        //存放客户端文件
   |- css
   |- html
   |- js
```
Node 对目录结构没有任何特殊要求。

### 指明依赖项
程序的依赖项是指需要通过安装来提供程序所需功能的模块。

程序的依赖项是在 package.json 文件中指明的，这个文件总是被放在程序的根目录下。package.json 文件用于描述你的应用程序，它包含一些 JSON 表达式，并遵循 CommonJS 包描述标准。在 package.json 中定义程序的名称、版本号、对程序的描述，以及程序的依赖项。

### 安装依赖项
定义好 package.json 文件之后，进入根目录下通过命令就能从 package.json 文件中读出依赖项，并把它们都安装好。

```shell
$ npm install
```

命令运行完成后，根目录下出现自动创建的 node_modules 目录，这个目录中存放程序的依赖项。

## 提供 HTML、CSS 和客户端 JavaScript 的服务
### 创建静态文件服务器
创建静态服务器既要用到 Node 内置的功能，也要用到第三方的 mime 附加模块来确定文件的 MIME 类型。

访问内存(RAM) 要比访问文件系统快得多，因此 Node 程序通常会把常用的数据缓存到内存里。只有第一次访问时才会从文件系统中读取，当下一次访问时会先确定文件是否缓存了，如果是，则返回它；如果文件还没缓存，则从硬盘中读取并返回它，如果文件不存在，则返回 404。

在命令行中输入命令启动 HTTP 服务器：
```shell
$ node server.js
```

在命令行中按下 Ctrl + C 可以停止正在运行的服务器。

## 用 Socket.IO 处理与聊天相关的消息
Socket.IO 为 Node 及客户端 JavaScript 提供了基于 WebSocket 以及其他方式的封装，它提供了一个抽象层。如果浏览器没有实现 WebSocket，Socket.IO 会自动启用一个备选方案，而对外提供的 API 还是一样的。

事件发射器是跟某种资源相关联的，它既能向这个资源发送消息，也能从这个资源接收消息。资源可以是连接远程服务器，或者更抽象的东西。事件发射器本质上是组织异步逻辑的一种很方便的设计模式，Socket.IO 实现了事件发射器，程序不用把每条消息都向已连接的用户广播，而是只向那些预定了某个通道的用户广播。

## 在程序的用户界面上使用客户端 JavaScript
从安全角度看，Web 程序中有两种文本数据，一种是受信的文本数据，由程序提供的文本组成；另一种是可疑的文本数据，是由程序的用户创建的文本，或从用户创建的文本中提取出来的。

之所以认为来自用户的文本数据是可疑的，是因为恶意用户可能会蓄意在提交的文本数据中包含 <script\> 标签，放入 JavaScipt 逻辑。如果不经修改就把这些数据展示给其他用户，可能会发生令人厌恶的事情，比如将用户转到其他 Web 页面上，这种劫持 Web 程序的方法称为跨域脚本攻击(XSS)。


## 参考
[1] Mike Cantelon, Marc Harter, T.J. Holowaychuk, Nathan Rajlich. Node.js in Action.