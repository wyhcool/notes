---
title: DOM2 核心和 DOM2 HTML
date: 2019-03-20 16:50:00
tags:
categories:
- JavaScript
---

W3C DOM2 核心和 DOM2 HTML 这两个规范为网页文档的 DOM 表现提供了基础。

## DOM 不是 JavaScript，DOM 不是 DHTML，它是文档，它是由 W3C 开发的一组规范，这些规范规定了 JavaScript 这样的语言为符合标准需要实现的对象、方法和属性
网页是一种结构化的文档，使用一组预定义的 XML 或 HTML 标签进行标记。

当浏览器接收到网页文档时，会根据文档类型(doctype)和关联的样式表对其进行解析，然后以可视化形式显示在屏幕上。

在与 W3C 标准兼容的浏览器中，网页文档也可以在遵循 DOM 规范的指导方针下使用 JavaScript 对象来引用。这些 JavaScript 对象可以通过脚本来获得，而且提供了一种标准的、不针对特定浏览器的文档交互方式。

DOM 是一组用来描述脚本怎样与结构化文档进行交互和访问的 Web 标准。DOM 定义了一系列对象、属性和方法，用于访问、操纵和创建文档中的内容、结构、样式和行为。

根据 W3C 的说法，DHTML 是某些厂商用来描述通过组合 HTML、样式表和脚本使文档呈现出动画效果的一个术语。DOM 背后的思想中确实结合了 DHTML 的概念，但 DHTML 包含了在浏览器间存在差异的非标准对象。

## DOM 的级别
W3C DOM 分成不同的级别，每个级别包含不同的子规范和模块，每个模块都在上一个级别基础上实现了新的改进特性，但在某些情况下，一个级别可能会与上一个级别不兼容。

### DOM 0 级
没有 DOM 0 级，因此也没有 DOM 0 级规范。一般地，DOM 0 级指的是一组专有的 DHTML 方法、对象和集合。而这些专有的特性在称为标准的规范之前，在不同浏览器中的实现是不一致的。

### DOM 1 级
DOM 1 级规范于 1998 年 10 月发布，由两部分组成：
- DOM Core：为 XML 文档规定了一般性的树形节点结构的内部运行机制，同时给出了创建、编辑和操纵这个树形结构的必要属性和方法。
- DOM HTML：为与 HTML 文档、标签集合以及个别的 HTML 标签相关的具体元素定义了对象、属性和方法。

DOM 1 级规范包含诸如 Document、 Node、 Attr、Element、 Text、 HTMLDocument、 HTMLElement 和 HTMLCollection 等对象的定义。

### DOM 2 级
DOM 2 级规范于 2000 年 11 月发布，DOM 2 级推荐标准分成了 6 个不同的规范：
- DOM2 Core：类似 DOM Core，规定了对 DOM 文档结构的控制机制，增加了更多的特性。
- DOM2 HTML：类似 DOM HTML，规定了针对 HTML 的 DOM 文档的控制机制，还包括了另外一些属性。
- DOM2 Events：规定了对与鼠标相关的事件（包括目标、捕获、冒泡和取消）的控制机制，但不包含与键盘相关事件的处理部分。
- DOM2 Style(DOM2 CSS)：提供了访问和操纵所有与 CSS 相关的样式及规则的能力。
- DOM2 Traversal and Range：这两个规范使能够迭代访问 DOM，以便根据需要对文档进行遍历或操作。
- DOM2 Views：提供了访问和更新文档表现的能力。

### DOM 3 级
DOM 3 级规范包含了更新之后的核心，总共包括以下规范：
- DOM3 Core：向原有核心添加了更多的新方法和新属性，同时也修改了已有的一些方法。
- DOM3 Load and Save：提供将 XML 文档的内容加载到 DOM 文档中和将 DOM 文档序列化为 XML 文档的能力。
- DOM3 Validation：提供了确保动态生成的文档的有效性(或者符合文档类型声明)的能力。 
- DOM3 Events：提供访问键盘和鼠标相关事件的能力。
- DOM3 XPath：提供使用 XPath 1.0 查询访问 DOM 文档的树形结构的能力。
- DOM3 Views、Formatting 与 DOM3 Abstract Schemas：提供动态访问和更新文档的内容、结构及样式的能力。

### 浏览器支持的 DOM 级别
使用 DOMImplementation 对象判断浏览器支持何种 W3C DOM 特性。

在 Web 浏览器中，DOMImplementation 对象被实例化为 document.implementation。

可以通过 document.implementation.hasFeature() 方法验证浏览器支持何种特性，该方法接受两个参数，第一个参数是下列之一，第二个参数是 DOM 级别，即 1.0、 2.0 或 3.0。
- Core：DOM 1 级和 2 级的基本方法，以及 DOM 2 级中的 XML 命名空间。
- XML：DOM 1 级、2 级和 3 级中的 XML 1.0。
- HTML：DOM 1 级、2 级和 3 级中的 HTML 4.0 和 DOM 2 级中对 XHTML 1.0 的支持。
- Views：DOM 2 级，用于 CSS 和 UIEvents 模块。
- StyleSheets：DOM 2 级，针对关联样式表和文档。
- CSS：DOM 2 级，针对层叠样式表进行的扩展。
- CSS2：DOM 2 级，针对层叠样式表 2 级进行的扩展。
- Events：DOM 2 级，针对一般事件。
- UIEvents：DOM 2 级，针对一般用户界面事件。
- MouseEvents：DOM 2 级，针对鼠标事件。
- MutationEvents：DOM 2 级，针对 DOM 树中的事件变化。
- HTMLEvents：DOM 2 级，针对 HTML 4.01 的特定事件。
- Range：DOM 2 级，针对 DOM 树中的范围操作。
- Traversal：DOM 2 级，针对 DOM 树中的迭代和遍历方法。
- LS：DOM 3 级，动态将文档加载到 DOM 树中。
- LS-Async：DOM 3 级，动态异步将文档加载到 DOM 树中。
- Validation：DOM 3 级，对面向模式(schema)修正 DOM 的支持。

如果浏览器不存在 document.implementation 对象，那么基本上可确定它不支持 DOM，不过也有可能部分支持。比如 IE6 支持 HTML 而不是 Core。

使用 DOM 特性时，首先是标准的方式，然后才是专有的方式(IE 的方式)。

## DOM Core (DOM 核心)
当浏览器解析 HTML 中的标记时，它会根据自身支持的 W3C DOM 模块把标记转换成对象。文档中的每个标签都可以通过一个核心对象来表示。

![dom-core](https://github.com/wyhcool/notes/blob/master/JavaScript/JavaScript%20Dom%20%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/03-01-dom-core-see-the-document.png)

文档树形结构中项的主体部分是 Element 节点，其中唯一的特例是表示整个文档的 Document 和表示标记中根元素 <html\> 的 DocumentElement。

标记中每个标签之间的空白符都被转换成了 Text 节点，这是 DOM 规范中规定的对空白符和换行符的处理方式。在理想情况下，DOM 树能够反映与之关联的文档标记中的所有信息。然而，在使用 IE 的情况下，只有当除了空白符外还夹杂有其他的文本字符时才会存在文本节点。

![ie-dom-core](https://github.com/wyhcool/notes/blob/master/JavaScript/JavaScript%20Dom%20%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/03-02-dom-core-see-the-document-without-white-space-formatting.png)

注意⚠️：当迭代每个节点的 childNodes 时记住上述这一点是至关重要的。

### 继承在 DOM 中的重要性
在浏览器解析完 HTML 文档后，每个节点并非就是一个简单的 Element 对象的实例，而是继承了很多东西的 Element 对象的扩展。

取决于文档的标记、nodeName 以及适合于该特定标签的 DOM HTML 规范，每个项都将继承一组特定的属性和方法。

![dom-extentions](https://github.com/wyhcool/notes/blob/master/JavaScript/JavaScript%20Dom%20%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/03-03-extentions-from-node-to-HTMLAnchorElement.png)

通过继承可以在各种对象之间维护公有的功能。

DOM2 核心和 DOM2 HTML 中几乎每一个对象的基础都是 Node 对象。

### 核心 Node 对象
Node 对象的属性中包括一些用于识别的特征，比如 nodeName、nodeValue、nodeType、parentNode、childNodes、firstChild、lastChild、previousSibling、nextSibling、attributes 和 ownerDocument。这些属性对于扩展自 Node 对象的所有 DOM 对象都是有效的。

#### 节点名称、值和类型 Node names, values and types
对于文档中的 Element 对象而言，可以使用 nodeName 属性取得用于区分节点的标签名称，为保持一致性，nodeName 的值会被转换为大写形式。

对于不基于文档中标签的其他对象来说，nodeName 的值取决于引用对象的类型。DOM2 Core 规范中规定的每种 nodeType 预期的 nodeName 值：

| 对象 | nodeName 返回值 |
|-:|:-:|
| Element           | 元素的名称，大写  |
| Attr              | 属性的名称，小写  |
| Text              | #text           |
| CDATASection      | #cdata-section  |
| EntityReference   | 实体引用的名称    |
| Entity            | 实体的名称       |
| ProcessingInsttruction | 目标的名称  |
| Comment           | #comment       |
| Document          | #document      |
| DocumentType      | 文档类型的名称，如 HTML |
| DocumentFragment  | #document fragment |
| Notation          | 表示法的名称     |

要取得与 Node 关联的值，可以使用 nodeValue 属性。事实上，nodeValue 属性只适用于少数 DOM 对象，尤其是 Attr、ProcessingInstruction、Comment、Text 和 CDATASection，除此之外其他所有对象的 nodeValue 值都将返回 null。DOM2 Core 规定中规定的每种 nodeType 预期的 nodeValue 值：

| 对象 | nodeValue 返回值 |
|-:|:-:|
| Element           | null  |
| Attr              | 字符串形式的属性值    |
| Text              | 字符串形式的节点内容  |
| CDATASection      | 字符串形式的节点内容  |
| EntityReference   | null  |
| Entity            | null  |
| ProcessingInsttruction | 字符串形式的节点内容  |
| Comment           | 字符串形式的注释文本       |
| Document          | null  |
| DocumentType      | null  |
| DocumentFragment  | null  |
| Notation          | null  |

nodeType 表示的是节点的类型，DOM Core 对象的 nodeType 常量：

| nodeType值 | 等价命名常量 |
|:-:|:-|
| 1 | Node.ELEMENT_NODE                | 
| 2 | Node.ATTRIBUTE_NODE              |
| 3 | Node.TEXT_NODE                   |
| 4 | Node.CDATA_SECTION_NODE          |
| 5 | Node.ENTITY_REFERENCE_NODE       |
| 6 | Node.ENTITY_NODE                 |
| 7 | Node.PROCESSING_INSTRUCTION_NODE |
| 8 | Node.COMMENT_NODE                |
| 9 | Node.DOCUMENT_NODE               |
|10 | Node.DOCUMENT_TYPE_NODE          |
|11 | Node.DOCUMENT_FRAGMENT_NODE      |
|12 | Node.NOTATION_NODE               |

如果在代码中需要检测 nodeType 时，那么要是能够在比较关系中使用 DOM 常量就好了。
```javascript
if (node.nodeType === Node.COMMENT_NODE) {
    //针对注释节点的代码
}
```

注意：并不是所有浏览器都支持 DOM 常量，在 IE 中，Node 对象则是不存在的。

#### 父节点、子节点和兄弟节点 
DOM2 核心中的大多数属性和方法都涉及在树形结构中引用和创建节点。每个 Node 对象都有许多预定义的属性，分别引用树中的其他相关节点，

parentNode 属性引用指定节点的直接父节点。

childNodes 属性引用指定节点的所有子节点，属性值是包含 DOM 对象的一个类数组的 NodeList 对象，通过数组中以数字索引来表示子节点，该对象中的第一个子元素的索引为 0，最后一个子元素的索引为 childNodes.length - 1。对这个对象进行迭代时既可以使用访问数组元素的方法，也可以使用 item() 方法。

firstChild 属性引用指定节点的第一个子节点。

lastChild 属性引用指定节点的最后一个子节点。在只有一个子节点的情况下， firstChild 和 lastChild 引用的是同一个节点。

previousSibling 属性引用指定节点向前紧邻的兄弟节点。如果当前节点是该级别节点中的第一个节点，那么 previousSibling 的值为 null。

nextSibling 属性引用指定节点的向后紧邻的兄弟节点。如果当前节点是该级别节点中的最后一个节点，那么 nextSibling 的值为 null。

注意⚠️：包含缩进空白符的 Text 节点。

#### 节点的 attributes 属性
如同 DOM 文档中的其他节点一样，节点的属性也扩展自 Node 对象，但是并不包含在表示父子关系的树形结构中。作为核心 Attr 对象的实例，节点的属性被包含在相应节点的 attributes 成员的一个 NamedNodeMap 对象中。

在 DOM2 核心中，attributes 不仅是 Node 接口定义的属性，同时 attributes 还实现了 Attr 和 NamedNodeMap 接口。attributes 中包含的是一个节点的所有属性的集合。

```javascript
var anchor = document.getElementById('firefox');
for (var i = 0;i < anchor.attributes.length; i++) {
    Alex.log.write(anchor.attributes.item(i).nodeName + ' = ' + anchor.attributes.item(i).nodeValue);
}
```

与 NodeList 对象类似，NameNodeMap 对象中的项既可以使用访问数组元素的方法，也可以使用 item() 方法。

此外，与 NodeList 对象不同的是，NameNodeMap 对象可以通过 getNamedItem() 方法取得指向具体属性节点的引用，这个方法在任何节点上都是有效的。与此类似的 getAttribute() 方法，仅在 Element 对象实例的节点上是有效的。

```javascript
var href = anchor.attributes.getNamedItem("href").nodeValue;
```

#### 节点的 ownerDocuemnt 属性
一个节点的 ownerDocument 属性指向节点所属根文档的引用。在大多数情况下，都可以通过它在作用域链中引用 document。如果在某个自定义对象内覆盖了 docuemnt 对象时，通过使用传递到对象内部的 DOM Node 对象的 ownerDocument 属性，仍然可以访问到原始的 document。

#### 检测子节点和属性
使用 hasChildNodes() 方法检测某个节点是否具有子节点。

使用 hasAttributes() 方法检测某个节点是否具有属性。

确定节点中包含多少个子节点，仍要使用 childNodes 属性。

确定节点包含多少属性，仍要使用 attributes 属性。

#### 操纵 DOM 节点树
大多数 DOM 脚本的任务是在 DOM 文档中插入、删除和移动节点，操纵 DOM 节点总是在父节点上操纵子节点。

使用 appendChild(newChild) 方法向 Node 对象中添加新的节点，该操作总是将新节点添加到 Node 对象的末尾。

使用 insertBefore(newChild, refChild) 方法在引用的子节点之前插入一个新节点，

注意⚠️：在编写操纵 DOM 的脚本时，一定要在必要时将空白符考虑在内。

出于某种原因，W3C 决定在核心规范中不包含 prependChild() 和 insertAfter() 方法，不过可以使用现有的方法完成相同的任务。

使用 replaceChild(newChild, oldChild) 方法替换一个节点的子节点。

使用 removeChild(oldChild) 方法删除一个节点的子节点。

#### 复制和移动节点
使用像 document.getElementById(string) 这样的方法返回的是对 Node 对象的引用，而不是相应对象的副本。

而使用 cloneNode(deep) 方法将复制并返回调用它的节点的副本。如果传递给它的参数是 true，它还将递归复制当前节点的所有子孙节点。否则，它只复制当前节点。

```javascript
var li = docuemnt.getElementById('item');
list.appendChild(li);
```
上述操作中向 list 中添加已经在文档中存在的一个节点的引用，所以节点被移动(而不是复制)到了新位置。

### 核心 Element 对象
DOM 文档树形结构的主体部分都是由 Element 节点构成的(但其中特殊的 DOM2 HTML 对象还会进一步扩展 Element 对象)。所有的 Element 对象都拥有 Node 对象的属性和方法，同时还有其他一些便于操纵节点属性和查找子 Element 对象的方法。

#### 操纵 Element 对象的属性
为简化对 attributes 的处理，Element 对象中包含了很多种用来操纵基础的 Node 对象的 attributes 属性的方法。
- getAttribute(name) 方法基于一个字符串形式的属性名称取得相应属性的值。
- setAttribute(name, value) 方法基于一个字符串形式的属性名称设置相应属性的值。
- removeAttribute(name) 方法基于一个字符串形式的属性名称删除相应属性的值。

#### 在 Element 对象中查找 Element 对象
在 Element 对象的范围内，可以用来查找其他节点的唯一有效办法就是 getElementsByTagName()，该方法的返回值是一个 NodeList 对象，其中包含与给定标签名称匹配的所有元素的引用。在最终的 NodeList 对象列表中，所有元素都是按照它们在 DOM 文档出现的先后顺序排列的。

在 getElementsByTagName() 方法中也可以使用星号(*)作为通配符来匹配所有元素的标签名称。 

注意⚠️：getElementsByTagName() 方法返回的节点中只包含 Element 节点，不包含其他类型的节点(比如文本节点)。


Element 对象中没有用于创建新 Element 对象的方法，创建新 DOM 元素的操作完全由 Document 对象负责处理。

### 核心 Document 对象
JavaScript 的全局对象是 window 对象，而 DOM 中使用的正是 window 对象的 document 属性，或者 window.document。

DOM 核心规范中的 Document 对象本身也扩展自 Node 对象，因此 Node 对象的属性和方法也适用于 Document 对象。

在 W3C DOM 规范诞生之前， window.document 就已经在 DHTML 中存在了。因此，算上 W3C DOM 的方法在内，widnow.document 对象也可能包含其他浏览器专有的成员。不过只要可能，就应该避免使用专有的、非标准的成员，而采用基于标准的方法。

#### document.documentElement 属性
document.documentElement 属性是访问文档根元素的快捷方式。对于在浏览器中呈现的 HTML 文档而言，根元素就是 <html\> 标签。

#### 使用 Document 对象的方法创建节点
Document 对象中包含很多可以用来创建 DOM 核心中各种节点类型的新实例的方法。
- createElement(tagName)：创建节点类型为 Node.ELEMENT_NODE 的 Element 节点。
- createAttribute(name)：创建节点类型为 Node.ATTRIBUTE_NODE 的 Attr 节点。
- createTextNode(data)：创建节点类型为 Node.TEXT_NODE 的 Text 节点。
- createCDATASection(data)：创建节点类型为 Node.CDATA_SECTION_NODE 的 CDATASection 节点。
- createEntityReference(name)：创建节点类型为 Node.ENTITY_REFERENCE_NODE 的 EntityReference 节点。
- createProcessingInstruction(target, data)：创建节点类型为 Node.PROCESSING_INSTRUCTION_NODE 的 ProcessingInstruction 节点。
- createComment(data)：创建节点类型为 Node.COMMENT_NODE 的 Comment 节点。
- createDocumentFragement()：创建节点类型为 ode.DOCUMENT_FRAGMENT_NODE 的 DocumentFragment 节点。

大多数情况下，使用的是 createElement()、createAttribute() 和 createTextNode() 方法。

#### 使用 Document 对象的方法查找 Element 对象
核心 Document 对象中的另外两个重要的方法是：getElementsByTagName() 和 getElementById()。

```javascript
document.getElementById('out-wrapper');
```

getElementById() 方法返回带有 id = 'xxx' 属性的 Element 对象，该方法只返回一个元素，为避免在使用时造成混乱，任何 ID 在整个文档中都必须保持唯一性。

虽然 Document 对象的 getElementsByTagName() 方法与 Element 对象的同名方法功能相同，但它们并不是同一个函数。Document 对象不是继承自 Element 对象，但它却包含了功能相同的 getElementsByTagName() 方法，因而可以使用该方法来查询整个文档。

为什么没有原生的 getElementsByClassName() 方法呢？这个方法之所以没有包含在 DOM 核心中，是因为类属性并不适用于所有类型的 XML 文档。getElementsByClass() 方法只适用于 HTML 文档，而不适用于 XML 文档。虽然 XML 文档中也可以带有 class 属性，但那不是 XML 规范所规定的；另外 HTML 文档中的 HTMLElement 对象有一个规范规定的 className 属性，因此 getElementsByClassName() 在 DOM2 HTML 规范中是有意义的。

### 遍历和迭代DOM树
在文档树中递归地检查每个节点及其子节点是最频繁的 DOM 操作。

如果不关心节点在 DOM 树中的深度，那么可以使用 document.getElementsByTagName('*') 方法取得指定节点中的所有 Element 节点，并循环遍历这些节点。

如果希望跟踪节点的深度，或者构建一个路径，那么可以通过递归的方式来遍历 DOM 树，通过 node.fistChild 和 node.nextSibling 层次遍历。


## DOM HTML
DOM2 HTML 规范包含针对所有 HTML 元素的特定对象。每个 DOM2 HTML 对象都扩展自 DOM2 核心对象。

### DOM2 HTML 的 HTMLDocument 对象
当 HTML 文档呈现在浏览器中时，window.document 中的 DOM 文档对象实际上是 HTMLDocument 对象的一个实例。HTMLDocument 对象从核心的 Document 对象中继承了所有成员，而且添加了其他的属性和方法。

其中增加的属性：
- title：包含位于 <title\> 标签中的字符串。
- referrer：包含连接到当前页面的前一个页面的 URL。
- domain：包含当前站点的域名。
- URL：包含浏览器在查看当前页面时地址栏中的 URL。
- body：引用从 <body\> 节点开始的 DOM。
- images：是一个包含当前文档中所有 <img\> 标签的数组集合。
- applets：是一个包含与当前文档中所有 <applet\> 标签对应的 DOM 节点的数组集合。
- forms：是一个包含与当前文档中所有 <form\> 标签对应的 DOM 节点的数组集合。
- links：是一个包含与当前文档中所有 <link\> 标签对应的 DOM 节点的数组集合。该属性返回的数组中的元素为所有包含 href 属性的 a 元素和所有 area 元素的引用。
- anchors：是一个包含与当前文档中所有 <a\>  标签对应的 DOM 节点的数组集合。该属性返回的数组中的元素为文档中所有锚元素，只能返回包含了 name 属性的 a 元素创建的锚，而不能返回只包含 id 属性的 a 元素创建的锚。
- cookie：是一个包含当前页面中所有 cookie 信息的字符串。

不是官方 DOM2 HTML 规范的内容，但在不少浏览器中都可用的属性，比如：frames、plugins、scripts、stylesheets 等。

HTMLDocument 对象中包含的方法：
- open()：打开一个文档以便接受 write() 或 writeln() 方法的输入。
- close()：关闭当前的文档。
- write(data)：将输入写入到文档中。
- writeln(data)：将输入写入到文档的同时写入一个换行符。
- getElementsByName(elementName)：除了不使用标签名而使用 name='xxx' 属性外，与 getElementsByTagName() 的工作方式相同。

注意⚠️：避免使用 document.write() 方法，可能会导致浏览器的怪异行为。

### DOM2 HTML 的 HTMLElement 对象
HTMLElement 对象继承自 DOM2 核心的 Element 对象，同样也添加了一些属性：
- id：包含可以供 document.getElementById('xxx') 方法使用的 id='xxx' 属性。
- title：用于进一步对元素进行语义化描述和悬停工具条。
- lang：为节点语言定义的语言代码。
- dir：表示节点中文本的方向。默认是表示从左向右的 ltr。
- className：包含用作 CSS 连接点的所有 class='xxx' 属性。

文档中的每个特定的标签都会通过一个针对标签的 DOM HTML 对象，以额外的属性和方法来加以扩展。



## 总结
学会所有正确的 DOM 方法和属性是进行 DOM 脚本编程的基础，更为重要的是，只有理解所有这些方法和属性的来源，以及每个规范与其他规范之间的协同的方式，才能更好地把握编程。

浏览器并非完美的开发环境，存在着各式各样的差别，解决这个问题的最佳方案就是：将按照标准开发放在首位，然后通过适当的能力检测来启用非标准特性。


## 参考
[1] 桑贝斯. JavaScript DOM高级程序设计 : AdvancED DOM Scripting: dynamic web design techniques[M]. 人民邮电出版社, 2008.