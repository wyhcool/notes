
---
title: 依赖注入
date: 2022-05-02 12:25:00
tags:
categories:
- Angular
---

依赖注入(dependency injection, DI)是这样一个系统：它让程序中的某部分可以访问其他部分，而且我们可以配置它们的访问方式。

可以把注入器看作 new 操作符的替代品。

使用依赖注入技术的主要优点是客户代码不必知晓如何创建依赖，它们只需要与那些依赖交互就可以了。

这种注入依赖的技术是基于一项被称为控制反转的设计原则。

控制反转(inversion of control, IoC)原则的非正式称谓是“好莱坞法则”（别打给我们，我们会打给你。don't call us, we'll call you）。

一旦部件变得过于关心它的依赖，部件本身就会变得脆弱而难以修改。如果我们修改了一个部件，这项修改就会向上扩散到所有依赖它的部件中，它会影响到程序中很多不同的区域，甚至可能超出程序的边界。换言之，这些部件之间产生了紧耦合。

使用依赖注入，我们可以得到一个更加松耦合的架构，当修改单一组件时，对程序中其他区域的影响就小多了，同时，只要这些部件之间的接口没有变，我们甚至可以在不修改其他部件中实现代码的情况下集体更换它们。

在传统方式下，如果部件A需要依赖部件B，那就意味着A要在内部创建一个B的实例，也就是A依赖于B。而在依赖注入机制下，如果部件A需要依赖部件B，那么就应该把B传入A。对部件B进行注册，在部件A中声明对B的依赖，然后使用DI框架将B注入。

## 依赖注入的部件
要注册一个依赖，我们就得找到一些东西作为该依赖的标识，这个标识被称为依赖的令牌(token)。

在 Angular 中，依赖注入包括三个部分：
- 提供者(绑定)，负责把一个令牌映射到一个依赖的列表，它告诉Angular该如何根据指定的令牌创建对象。
- 注入器，负责持有一组绑定，当外界要求创建对象时，解析这些依赖并注入它们。
- 依赖，就是将被用于注入的对象。

## 尝试注入器
使用 `ReflectiveInjector.resolveAndCreate` 静态方法负责创建一个新的注入器，它使用反射机制(reflection)来找出正确的参数类型。

注意：它会注入该类的一个单例对象。

## 使用 NgModule 提供依赖
为了能够注入，必须把提供者们添加到 NgModule 的 providers 属性中。

## 提供者
### 使用类
注入一个类的单例实例，配置方法如下：
```javascript
{ provide: MyComponent, useClass: MyComponent }
```
provide 配置方法接收两个键，第一个 provide 键是用作这个可注入对象标识的令牌，第二个 useClass 键用来指出注入什么以及如何注入。

令牌和被注入物不一定同名。

首次注入时它尚未实例化，需要创建一个实例，此时，依赖注入系统就会调用该类的构造函数。如果构造函数需要参数时，就必须得告诉注入器在创建服务的实例时要使用哪个参数。

### 使用工厂
如果要使用工厂进行注入，就需要写一个返回任意对象的函数：
```javascript
{
    provide: MyComponent,
    useFactory: () => {
        if (loggedIn) {
            return new MyLoggedComponent();
        }
        return new MyComponent();
    }
}
```
工厂还可以拥有自己的依赖：
```javascript
{
    provide: MyComponent,
    useFactory: (user) => {
        if (loggedIn) {
            return new MyLoggedComponent(user);
        }
        return new MyComponent();
    },
    deps: [ User ]
}
```
工厂是创建可注入对象的最强方式，因为我们可以工厂函数中为所欲为。

### 使用值
当我们需要一个常量，而它可能会根据应用的其他部分甚至环境进行重新定义时：
```javascript
{ provide: 'API_URL', useClass: 'http://my.api.com/v1' }
```

### 使用别名
制造一个别名来引用以前注册过的令牌：
```javascript
{ provide: NewComponent, useExisting: MyComponent }
```

## 应用中的依赖注入
在我们开发应用时，需要经过三步才能进行依赖注入：
- 创建该服务的类；
- 在准备接受注入的部件上声明该依赖；
- 配置要注入的依赖。

写部件时，我们通常会使用 Angular 提供的两种便捷方式来声明要接收的依赖：
- 在部件的构造函数中声明这些可注入对象，Angular 会通过反射机制来找出要注入的类。
- 使用 @Inject 注解。

依赖注入的最后一步是把部件想要的东西与可注入对象关联起来，换言之，我们告诉 Angular：当部件声明了它的依赖时，应该注入什么。

## 使用注入器
当我们需要控制在什么时机创建依赖的单例对象时，我们就需要使用注入器。

## 替换值
使用依赖注入的另一个理由是在运行期间改变被注入对象的硬编码值。

## NgModule
NgModule 是帮助编译器和依赖注入对依赖进行组织的方式。

Angular 需要解决组件定义了哪些 HTML 标记(tag) 以及这些依赖来自哪里这两个问题。

NgModule 体系是 Angular 框架内部对依赖进行组织的一种方式，特别是围绕两个问题：编译出了哪些标记 以及 哪些依赖应该被注入其中。

对于编译器来说，如果有一个带有自定义标记的 Angualr 模板，那就得告诉编译器哪些标签是有效的。

任何组件都只能从属于一个 NgModule，通常我们会把多个组件一起放入一个 NgModule。

如果任何组件想要使用其他组件，它必须首先通过 NgModule 体系获得访问权，有两种方式能够做到这一点：
- 其他组件位于同一个 NgModule 中；
- 其他组件所属的 NgMoudle 被导入了当前组件所在的模块。

把组件添加到 declarations 和 exports 中，这样才能保证当前组件可以在其他模块中通过 imports 的方式使用。


## 参考
[1] Lerner A.ng-book 2: The Complete Book on Angular 2.2017.

[2] https://angular.cn/docs