---
title: HTTP 协议
date: 2019-04-24 10:53:15
tags:
categories:
- 网络
---

## 简介
HTTP 协议是 Hyper Text Transfer Protocol(超文本传输协议)的缩写，是用于从万维网(WWW, World Wide Web)服务器传输超文本到本地浏览器的传送协议。

HTTP 是一个基于 TCP/IP 通信协议来传递数据（HTML 文件、图片文件、查询结果等）。

HTTP 协议工作于客户端-服务端架构之上，浏览器作为 HTTP 客户端通过 URL 向 HTTP 服务端即 WEB 服务器发送请求，Web 服务器根据接收到的请求后，向客户端发送响应信息。

## 主要特点
1. 简单快速：客户向服务器请求服务时，只需传送请求方法和路径。请求方法常用的有 GET、HEAD、POST。每种方法规定了客户与服务器联系的类型不同。由于 HTTP 协议简单，使得 HTTP 服务器的程序规模小，因而通信速度很快。

2. 灵活：HTTP 允许传输任意类型的数据对象。正在传输的类型由 Content-Type 加以标记。

3. 无状态：HTTP 协议是无状态协议。无状态是指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。

注意⚠️：

无状态协议是指 HTTP 协议本身对于事务处理没有记忆功能，服务器不知道浏览器的状态。通俗的即使你登录了，去访问同一个网站的不同网页，服务器都不会知道你是谁，如果需要记录登录用户的信息，用户操作，用户行为等数据需要使用 cookie 或 session 来存储，所以无状态是针对应用层协议而言的。

优点：服务器不用为每个客户端连接分配内存来记忆大量状态，也不用在客户端失去连接时去清理内存，以更高效地去处理 WEB 业务。

缺点：客户端的每次请求都需要携带相应参数，服务器需要处理这些参数。

Keep-Alive：从 HTTP/1.1 起，浏览器默认都开启了 Keep-Alive，保持连接特性，客户端和服务器都能选择随时关闭连接，则请求头中为 Connection: Close。简单地说，当一个网页打开完成后，客户端和服务器之间用于传输 HTTP 数据的 TCP 连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的 TCP 连接。但是 Keep-Alive 不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如Apache）中设定这个时间，所以 Keep-Alive 是针对下层网络层协议而言，为了节省建立多次 TCP 连接的成本。

无状态不代表 HTTP 不能保持 TCP 连接，更不能代表 HTTP 使用的是 UDP 协议（无连接）。即使 HTTP 在无状态下，只要客户端和服务器的头部信息connection:keep-alive，则在有效期内他们使用同一条 TCP 连接。

## URL
HTTP 使用统一资源标识符(Uniform Resource Identifiers, URI)来传输数据和建立连接。URL 是一种特殊类型的 URI，包含了用于查找某个资源的足够的信息。

URL(Uniform Resource Locator，统一资源定位符)是互联网上用来标识某一处资源的地址。以下面这个 URL 为例，介绍下普通URL的各部分组成：

http://www.aspxfans.com:8080/news/index.asp?boardID=5&ID=24618&page=1#name

从上面的URL可以看出，一个完整的 URL 包括以下几部分：

- 1.协议部分：该 URL的协议部分为“http：”，这代表网页使用的是HTTP协议。在 Internet 中可以使用多种协议，如 HTTP，FTP 等等。在 "HTTP" 后面的 “//” 为分隔符。
- 2.域名部分：该 URL 的域名部分为“www.aspxfans.com”。一个 URL 中，也可以使用IP地址作为域名使用。
- 3.端口部分：跟在域名后面的是端口，域名和端口之间使用“:”作为分隔符。端口不是一个URL必须的部分，如果省略端口部分，将采用默认端口 80。
- 4.虚拟目录部分：从域名后的第一个“/”开始到最后一个“/”为止，是虚拟目录部分。虚拟目录也不是一个 URL 必须的部分。本例中的虚拟目录是“/news/”
- 5.文件名部分：从域名后的最后一个“/”开始到“？”为止，是文件名部分，如果没有“?”,则是从域名后的最后一个“/”开始到“#”为止，是文件部分，如果没有“？”和“#”，那么从域名后的最后一个“/”开始到结束，都是文件名部分。本例中的文件名是“index.asp”。文件名部分也不是一个URL必须的部分，如果省略该部分，则使用默认的文件名。
- 6.参数部分：从“?”开始到“#”为止之间的部分为参数部分，又称搜索部分、查询部分。本例中的参数部分为“boardID=5&ID=24618&page=1”。参数可以允许有多个参数，参数与参数之间用“&”作为分隔符。
- 7.锚部分：从“#”开始到最后，都是锚部分。本例中的锚部分是“name”。锚部分也不是一个URL必须的部分。

## URI vs. URL
URI，是 Uniform Resource Identifier，统一资源标识符，用来唯一的标识一个资源。

Web 上可用的每种资源如 HTML 文档、图像、视频片段、程序等都是一个来 URI 来定位的。URI一般由三部组成：
- ①访问资源的命名机制
- ②存放资源的主机名
- ③资源自身的名称，由路径表示，着重强调于资源。

URL 是一种具体的 URI，即 URL 可以用来标识一个资源，而且还指明了如何定位到这个资源。采用 URL 可以用一种统一的格式来描述各种信息资源，包括文件、服务器的地址和目录等。URL一般由三部组成：
- ①协议(或称为服务方式)
- ②存有该资源的主机IP地址(有时也包括端口号)
- ③主机资源的具体地址。如目录和文件名等


URI 是以一种抽象的，高层次概念定义统一资源标识，而 URL 和 URN 则是具体的资源标识的方式。URL 和 URN 都是一种 URI。笼统地说，每个 URL 都是 URI，但不一定每个 URI 都是 URL。这是因为 URI 还包括一个子类，即统一资源名称 (URN)，它命名资源但不指定如何定位资源。

## 请求消息 Request
客户端发送一个 HTTP 请求到服务器的请求消息包括以下格式：请求行（request line）、请求头部（header）、空行和请求数据四个部分组成。
```javascript
// GET /562f25980001b1b106000338.jpg HTTP/1.1
// Host    img.mukewang.com
// User-Agent    Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.106 Safari/537.36
// Accept    image/webp,image/*,*/*;q=0.8
// Referer    http://www.imooc.com/
// Accept-Encoding    gzip, deflate, sdch
// Accept-Language    zh-CN,zh;q=0.8
//

```
Get 请求：
- 第一部分：请求行，用来说明请求类型，要访问的资源以及所使用的HTTP版本。GET说明请求类型为GET, 「/562f25980001b1b106000338.jpg」为要访问的资源，该行的最后一部分说明使用的 是HTTP1.1 版本。
- 第二部分：请求头部，紧接着请求行（即第一行）之后的部分，用来说明服务器要使用的附加信息。HOST 将指出请求的目的地，User-Agent 包含发出请求的用户信息，Accept 指定客户端能够接收的内容类型，Referer 指出先前网页的地址，当前请求网页紧随其后，即来路，Accept-Encoding，指定浏览器可以支持的服务器返回内容压缩编码类型，Accept-Language 指定浏览器可接受的语言。
- 第三部分：空行，请求头部后面的空行是必须的。即使第四部分的请求数据为空，也必须有空行。
- 第四部分：请求数据也叫主体，可以添加任意的其他数据。Get 请求数据为空。

```javascript
// POST / HTTP/1.1
// Host:www.wrox.com
// User-Agent:Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022)
// Content-Type:application/x-www-form-urlencoded
// Content-Length:40
// Connection: Keep-Alive

// name=Professional%20Ajax&publisher=Wiley
```
POST 请求：
- 第一部分：请求行，第一行说明了是 POST 请求，以及 HTTP1.1 版本。
- 第二部分：请求头部，第二行至第六行。
- 第三部分：空行，第七行的空行。
- 第四部分：请求数据，第八行。

## 响应消息 Response
一般情况下，服务器接收并处理客户端发过来的请求后会返回一个 HTTP 的响应消息。HTTP 响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。
 
```javascript
// HTTP/1.1 200 OK
// Date: Fri, 22 May 2009 06:07:21 GMT
// Content-Type: text/html; charset=UTF-8

// <html>
//       <head></head>
//       <body>
//             <!--body goes here-->
//       </body>
// </html>
```
- 第一部分：状态行，由HTTP协议版本号，状态码，状态消息三部分组成。「HTTP/1.1」表明 HTTP1.1 版本，状态码为 200，状态消息为 OK。
- 第二部分：消息报头，用来说明客户端要使用的一些附加信息。第二行和第三行为消息报头，Date 说明生成响应的日期和时间，Content-Type 指定了MIME类型的HTML(text/html),编码类型是UTF-8。
- 第三部分：空行，消息报头后面的空行是必须的。
- 第四部分：响应正文，服务器返回给客户端的文本信息。空行后面的html部分为响应正文。

## 状态码
状态代码有三位数字组成，第一个数字定义了响应的类别，共分五种类别:
- 1xx：指示信息--表示请求已接收，继续处理
- 2xx：成功--表示请求已被成功接收、理解、接受
- 3xx：重定向--要完成请求必须进行更进一步的操作
- 4xx：客户端错误--请求有语法错误或请求无法实现
- 5xx：服务器端错误--服务器未能实现合法的请求

常见状态码：
- 200 OK                    //客户端请求成功
- 400 Bad Request           //客户端请求有语法错误，不能被服务器所理解
- 401 Unauthorized          //请求未经授权，这个状态代码必须和WWW-Authenticate报头域一起使用 
- 403 Forbidden             //服务器收到请求，但是拒绝提供服务
- 404 Not Found             //请求资源不存在，eg：输入了错误的URL
- 500 Internal Server Error //服务器发生不可预期的错误
- 503 Server Unavailable    //服务器当前不能处理客户端的请求，一段时间后可能恢复正常

## HTTP 请求方法
根据 HTTP 标准，HTTP 请求可以使用多种请求方法。

HTTP1.0 定义了三种请求方法： GET, POST 和 HEAD方法。

HTTP1.1 新增了五种请求方法：OPTIONS, PUT, DELETE, TRACE 和 CONNECT 方法。

- GET，请求指定的页面信息，并返回实体主体。
- HEAD，类似于get请求，只不过返回的响应中没有具体的内容，用于获取报头。
- POST，向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST请求可能会导致新的资源的建立和/或已有资源的修改。
- PUT，从客户端向服务器传送的数据取代指定的文档的内容。
- DELETE，请求服务器删除指定的页面。
- CONNECT，HTTP/1.1 协议中预留给能够将连接改为管道方式的代理服务器。
- OPTIONS，允许客户端查看服务器的性能。
- TRACE，回显服务器收到的请求，主要用于测试或诊断。

## HTTP 工作原理
HTTP 协议规定 Web 客户端如何从 Web 服务器发起请求，以及服务器如何把响应数据传送给客户端。

以下是 HTTP 请求/响应的步骤：
- 1、客户端连接到 Web 服务器。一个 HTTP 客户端，通常是浏览器，与 Web 服务器的HTTP 端口（默认为80）建立一个 TCP 套接字连接。
- 2、发送HTTP请求。通过 TCP 套接字，客户端向 Web 服务器发送一个请求报文，一个请求报文由请求行、请求头部、空行和请求数据 4 部分组成。
- 3、服务器接受请求并返回 HTTP 响应。Web 服务器解析请求，定位请求资源。服务器将资源副本写到 TCP 套接字，由客户端读取。一个响应由状态行、响应头部、空行和响应数据 4 部分组成。
- 4、释放连接TCP连接。若 Connection 模式为 close，则服务器主动关闭 TCP 连接，客户端被动关闭连接，释放TCP连接；若 Connection 模式为 keep-alive，则该连接会保持一段时间，在该时间内可以继续接收请求;
- 5、客户端浏览器解析HTML内容。客户端浏览器首先解析状态行，查看表明请求是否成功的状态代码。然后解析每一个响应头，响应头告知以下为若干字节的HTML文档和文档的字符集。客户端浏览器读取响应数据HTML，根据HTML的语法对其进行格式化，并在浏览器窗口中显示。

HTTP 请求发送之前，需要先建立 TCP 连接，只有 TCP 连接建立，才可以发送HTTP请求。 当 HTTP 请求发送并响应完成，有两种情况，

| 操作 | 含义 |
|:-:|:-|
| 关闭TCP连接 | 当HTTP发送下一个请求的时候，需要在此进行三次握手，建立TCP连接 |
| 不关闭TCP连接 | 长连接，HTTP发送下一个请求的时候可以直接发送，不需要再次建立TCP连接 |

在 Chrome 浏览器中，ConnectionID 表示的就是 TCP 建立连接的 ID。HTTP 1.1默认进行长连接，在 HTTP2 中，会有信道复用，意味着在一个 TCP 连接上可以并发发送多个 HTTP 请求。

例如：在浏览器地址栏键入URL，按下回车之后会经历以下流程：
- 1、浏览器向 DNS 服务器请求解析该 URL 中的域名所对应的 IP 地址;
- 2、解析出 IP 地址后，根据该 IP 地址和默认端口 80，和服务器建立TCP连接;
- 3、浏览器发出读取文件(URL 中域名后面部分对应的文件)的HTTP 请求，该请求报文作为 TCP 三次握手的第三个报文的数据发送给服务器;
- 4、服务器对浏览器请求作出响应，并把对应的 html 文本发送给浏览器;
- 5、释放 TCP连接;
- 6、浏览器渲染 html 内容; 　　

## GET vs. POST
get参数通过url传递，post放在request body中。

get请求在url中传递的参数是有长度限制的，而post没有。

get比post更不安全，因为参数直接暴露在url中，所以不能用来传递敏感信息。

get请求只能进行url编码，而post支持多种编码方式

get请求会浏览器主动缓存cache，而post不会。

get请求参数会被完整保留在浏览历史记录里，而post中的参数不会被保留。

GET和POST本质上就是TCP链接，并无差别。但是由于HTTP的规定和浏览器/服务器的限制，导致他们在应用过程中体现出一些不同。


get 请求的缓存过程：

- 第一次请求时，返回数据，在http头部中包含last-modified(最后修改的时间) Etag（指示资源的状态的唯一标识）Expires(指示资源在浏览器缓存中的过期时间)，然后浏览器会将请求回的文件放在Cache目录下，并保存上述信息。
- 发起第二次请求。浏览器会先检查Cache目录中是否有该文件，并且是否过期。同时满足这两个条件，则浏览器不会在向服务器发送请求，而是直接使用缓存中的文件。否则，浏览器会发送请求服务器 ，并在头部添加If-Modified-Since 和 If-None-Match。
- 如果文件从上次访问至今都没有被修改过或Etag信息没有变化，则直接返回一个304的状态，表明服务器端允许请求访问资源，但不满足条件，返回不包含任何响应的主体部分。




## 参考
[1] https://www.cnblogs.com/ranyonsue/p/5984001.html
